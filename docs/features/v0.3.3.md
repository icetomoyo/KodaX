# v0.3.3 Feature Designs

**版本**: v0.3.3
**状态**: Released
**Feature 数量**: 1

---

## FEATURE_004: 交互式界面改进

**Status**: Completed
**Priority**: Medium
**Category**: Enhancement

### 1. 需求概述

基于 Ink 的 React UI 全面改进，提供现代化终端用户体验。

**核心功能**:
- 多行输入与正确的光标处理
- 实时流式显示
- 主题支持基础设施
- 消息列表（带虚拟滚动）
- 状态栏显示会话信息
- 自动补全建议显示
- 工具执行分组

**技术栈**: React + Ink (React for CLI)

### 2. 影响范围

**需要创建的文件**:
```
src/ui/
├── App.tsx                  # 根组件
├── components/
│   ├── InputPrompt.tsx      # 输入框组件
│   ├── TextInput.tsx        # 底层文本输入
│   ├── MessageList.tsx      # 消息列表
│   ├── StatusBar.tsx        # 状态栏
│   ├── SuggestionsDisplay.tsx # 补全建议
│   └── MarkdownRenderer.tsx # Markdown 渲染
├── hooks/
│   ├── useTextBuffer.ts     # TextBuffer Hook
│   ├── useKeypress.ts       # 键盘事件
│   ├── useInputHistory.ts   # 输入历史
│   └── useCompletion.ts     # 自动补全
├── utils/
│   ├── text-buffer.ts       # TextBuffer 类
│   ├── paste-detector.ts    # 粘贴检测
│   ├── text-utils.ts        # Unicode 工具
│   └── key-matcher.ts       # 快捷键匹配
├── themes/
│   ├── index.ts             # 主题导出
│   └── dark.ts              # 默认暗色主题
└── types.ts                 # 类型定义
```

**需要修改的文件**:
- src/kodax_cli.ts - 添加 `--ink` 参数
- src/interactive/repl.ts - 适配层

### 3. 技术方案

**为什么选择 Ink 框架**:
1. **声明式 UI** - 使用 React 组件模式，代码更清晰
2. **成熟的生态系统** - ink-text-input、ink-spinner 等现成组件
3. **Flexbox 布局** - 使用 Yoga 布局引擎，响应式设计
4. **良好的终端兼容性** - 自动处理 ANSI 转义序列

**架构**:
```
┌─────────────────────────────────────────────────────────────────┐
│                        KodaX CLI App                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  App.tsx (Ink 根组件)                                      │  │
│  │  ├── <MainContent> - 消息列表渲染                          │  │
│  │  ├── <InputPrompt> - 多行输入框                            │  │
│  │  └── <StatusBar> - 底部状态栏                              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│  ┌───────────────────────────▼───────────────────────────────┐  │
│  │  Core Hooks                                                │  │
│  │  ├── useTextBuffer - 文本缓冲区管理                        │  │
│  │  ├── useKeypress - 键盘事件处理                            │  │
│  │  ├── useInputHistory - 输入历史                            │  │
│  │  └── useCompletion - 自动补全                              │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 4. 接口契约

**TextBuffer 接口**:
```typescript
interface CursorPosition {
  row: number;  // 逻辑行号 (0-based)
  col: number;  // 列位置 (code point index)
}

class TextBuffer {
  get text(): string;
  get lines(): string[];
  get cursor(): CursorPosition;
  get lineCount(): number;

  setText(text: string): void;
  insert(text: string, options?: { paste?: boolean }): void;
  newline(): void;
  backspace(): void;
  move(direction: 'up' | 'down' | 'left' | 'right' | 'home' | 'end'): void;
}
```

**快捷键设计**:
| 快捷键 | 功能 |
|--------|------|
| `↑/↓` | 在行间移动光标 / 历史导航 |
| `←/→` | 左右移动字符 |
| `Enter` | 提交（行尾是 `\` 则换行） |
| `Ctrl+A/E` | 移到行首/行尾 |
| `Ctrl+K/U` | 删除到行尾/行首 |
| `Ctrl+W` | 删除前一词 |
| `Ctrl+C` | 清空/退出 |

### 5. 实现步骤

1. **Phase 1**: 基础架构
   - 添加 ink、react 依赖
   - 实现 TextBuffer 类
   - 实现 useTextBuffer Hook

2. **Phase 2**: 核心组件
   - TextInput 组件
   - InputPrompt 组件
   - App 根组件

3. **Phase 3**: 增强功能
   - StatusBar 组件
   - MessageList 组件
   - 粘贴检测

4. **Phase 4**: 集成与优化
   - REPL 适配层
   - 主题系统
   - 单元测试

5. **Phase 5-6**: UX 增强
   - 启动横幅设计
   - 会话历史显示
   - 历史导航优化
   - 渲染稳定性

### 6. 验收标准

- [x] 多行输入支持，光标可在行间移动
- [x] `\` + Enter 换行，Enter 提交
- [x] 历史记录导航（上下键）
- [x] 状态栏显示会话信息
- [x] 启动 Banner 正确显示
- [x] 会话恢复时历史显示
- [x] TextBuffer 单元测试通过 (48 tests)

---

## 版本总结

| Feature | Status | 优先级 |
|---------|--------|--------|
| 004 交互式界面改进 | Completed | Medium |

**发布日期**: 2026-02-20
**主要变更**: 基于 Ink 的 React UI 全面改进，支持多行输入、状态栏、主题系统
