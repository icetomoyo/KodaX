# KodaX v0.4.0 架构重构与模块解耦

> **版本**: v0.4.0 | **创建日期**: 2025-02-20 | **状态**: 规划中

---

## 1. 背景与目标

### 1.1 当前问题

KodaX 当前架构（v0.3.x）存在以下问题：

1. **模块耦合严重**: kodax_core、kodax_cli、repl 之间存在循环依赖
2. **接口不标准**: 各模块之间的数据传递方式不统一
3. **难以独立使用**: 无法将单个模块作为独立库使用
4. **测试困难**: 耦合导致单元测试需要大量 mock

### 1.2 重构目标

```
┌─────────────────────────────────────────────────────────────┐
│                      KodaX v0.4.0                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐     │
│  │  @kodax/core │ ← │  @kodax/cli  │ ← │  @kodax/repl │     │
│  │              │   │              │   │              │     │
│  │  核心引擎     │   │  CLI 入口    │   │  交互式终端   │     │
│  │  Provider    │   │  命令解析    │   │  Ink UI      │     │
│  │  Agent       │   │  参数处理    │   │  会话管理    │     │
│  │  Tools       │   │  输出格式    │   │  历史记录    │     │
│  └──────────────┘   └──────────────┘   └──────────────┘     │
│         ↑                  ↑                  ↑              │
│         └──────────────────┴──────────────────┘              │
│                          标准化接口                           │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**核心原则**:

| 模块 | 设计原则 | 职责边界 |
|------|----------|----------|
| `@kodax/core` | **极简、智能、无副作用** | 只负责 AI 交互，不涉及 I/O |
| `@kodax/cli` | **极简、智能、薄层** | 只负责命令解析和参数处理 |
| `@kodax/repl` | **智能、清晰、高可靠** | 负责交互式体验和状态管理 |

---

## 2. 模块设计

### 2.1 @kodax/core - 核心引擎

**定位**: 纯粹的 AI 引擎，可在任何环境（Node.js、浏览器、边缘运行时）使用。

```typescript
// @kodax/core 主要导出
export { KodaXEngine } from './engine.js';
export { type Provider, type ProviderConfig } from './provider/index.js';
export { type Tool, type ToolContext, type ToolResult } from './tools/index.js';
export { type Message, type KodaXResult, type KodaXEvent } from './types.js';

// Provider 注册
export { registerProvider, getProvider, listProviders } from './registry.js';

// Tool 注册
export { registerTool, getTool, listTools } from './tools/registry.js';
```

**核心类设计**:

```typescript
// KodaXEngine - 核心引擎类
export class KodaXEngine {
  private provider: Provider;
  private tools: Map<string, Tool>;
  private eventHandlers: Set<EventHandler>;

  constructor(config: KodaXEngineConfig);

  // 核心执行方法
  async execute(input: EngineInput): Promise<KodaXResult>;

  // 流式执行
  async *stream(input: EngineInput): AsyncGenerator<KodaXEvent>;

  // 事件订阅
  subscribe(handler: EventHandler): Unsubscribe;

  // 工具管理
  registerTool(name: string, tool: Tool): void;

  // 销毁
  destroy(): void;
}

// 引擎配置
interface KodaXEngineConfig {
  provider: string | Provider;
  model?: string;
  tools?: Tool[];
  maxIterations?: number;
  systemPrompt?: string | (() => string | Promise<string>);
}

// 引擎输入
interface EngineInput {
  messages: Message[];
  context?: Record<string, unknown>;
  abortSignal?: AbortSignal;
}

// 引擎输出
interface KodaXResult {
  success: boolean;
  text?: string;
  thinking?: string;
  toolCalls?: ToolCall[];
  error?: KodaXError;
  metadata: {
    provider: string;
    model: string;
    duration: number;
    tokenUsage?: TokenUsage;
  };
}
```

**事件系统**:

```typescript
// 统一事件接口
interface KodaXEvent {
  type:
    | 'thinking_start'
    | 'thinking_delta'
    | 'thinking_end'
    | 'text_start'
    | 'text_delta'
    | 'text_end'
    | 'tool_start'
    | 'tool_input_delta'
    | 'tool_end'
    | 'tool_result'
    | 'error'
    | 'done';
  timestamp: number;
  data: unknown;
}
```

**约束条件**:
- 不依赖 Node.js 特定 API（如 fs、path）
- 不直接进行 I/O 操作
- 不维护全局状态
- 所有状态通过参数传递

### 2.2 @kodax/cli - 命令行接口

**定位**: 薄层封装，将 CLI 参数转换为 Engine 调用。

```typescript
// @kodax/cli 主要导出
export { createCLI, type CLIConfig } from './cli.js';
export { type Command, type CommandContext } from './command.js';
export { registerCommand, getCommand } from './registry.js';

// 预定义命令
export { helpCommand } from './commands/help.js';
export { versionCommand } from './commands/version.js';
export { runCommand } from './commands/run.js';
```

**CLI 类设计**:

```typescript
// CLI 入口
export function createCLI(config?: CLIConfig): CLI;

interface CLI {
  // 执行命令
  run(argv: string[]): Promise<number>;

  // 注册自定义命令
  registerCommand(name: string, command: Command): void;

  // 获取引擎实例
  getEngine(): KodaXEngine;
}

// 命令接口
interface Command {
  name: string;
  description: string;
  options?: OptionDefinition[];
  execute(context: CommandContext): Promise<number>;
}

// 命令上下文
interface CommandContext {
  argv: string[];
  options: Record<string, unknown>;
  engine: KodaXEngine;
  stdout: WritableStream;
  stderr: WritableStream;
}
```

**约束条件**:
- 只负责解析和路由，不包含业务逻辑
- 所有输出通过 stdout/stderr 流
- 可程序化调用（不依赖 process.exit）
- 支持 dry-run 模式

### 2.3 @kodax/repl - 交互式终端

**定位**: 完整的交互式体验，管理会话、状态和 UI。

```typescript
// @kodax/repl 主要导出
export { createREPL, type REPLConfig } from './repl.js';
export { type Session, type SessionManager } from './session/index.js';
export { type UIState, type UIContext } from './ui/index.js';

// UI 组件
export { MessageList } from './ui/components/MessageList.js';
export { LoadingIndicator } from './ui/components/LoadingIndicator.js';
export { ToolGroup } from './ui/components/ToolGroup.js';
export { SuggestionsDisplay } from './ui/components/SuggestionsDisplay.js';

// Contexts
export { StreamingContext } from './ui/contexts/StreamingContext.js';
export { UIStateContext } from './ui/contexts/UIStateContext.js';
export { KeypressContext } from './ui/contexts/KeypressContext.js';

// Themes
export { ThemeManager } from './ui/themes/ThemeManager.js';
export { darkTheme, lightTheme } from './ui/themes/index.js';
```

**REPL 类设计**:

```typescript
// REPL 入口
export function createREPL(config?: REPLConfig): REPL;

interface REPL {
  // 启动交互式会话
  start(): Promise<void>;

  // 停止会话
  stop(): Promise<void>;

  // 执行单条消息
  execute(message: string): Promise<KodaXResult>;

  // 获取引擎实例
  getEngine(): KodaXEngine;

  // 获取会话管理器
  getSessionManager(): SessionManager;

  // 事件
  on(event: string, handler: Function): void;
}

// REPL 配置
interface REPLConfig {
  engine: KodaXEngine | KodaXEngineConfig;
  session?: SessionConfig;
  ui?: UIConfig;
  commands?: REPLCommand[];
}
```

**会话管理**:

```typescript
// 会话接口
interface Session {
  id: string;
  createdAt: Date;
  updatedAt: Date;
  messages: Message[];
  metadata: SessionMetadata;
}

// 会话管理器
interface SessionManager {
  // 创建新会话
  create(): Session;

  // 加载会话
  load(id: string): Promise<Session>;

  // 保存会话
  save(session: Session): Promise<void>;

  // 列出会话
  list(options?: ListOptions): Promise<Session[]>;

  // 删除会话
  delete(id: string): Promise<void>;
}
```

---

## 3. 标准化接口

### 3.1 消息格式

```typescript
// 统一消息格式
interface Message {
  role: 'user' | 'assistant' | 'system';
  content: MessageContent;
  timestamp?: number;
}

type MessageContent =
  | string
  | ContentPart[];

interface ContentPart {
  type: 'text' | 'thinking' | 'tool_use' | 'tool_result';
  text?: string;
  thinking?: string;
  toolUse?: ToolUse;
  toolResult?: ToolResult;
}
```

### 3.2 工具接口

```typescript
// 工具定义
interface Tool {
  name: string;
  description: string;
  inputSchema: JSONSchema;
  execute(input: unknown, context: ToolContext): Promise<ToolResult>;
}

// 工具上下文
interface ToolContext {
  engine: KodaXEngine;
  session?: Session;
  abortSignal?: AbortSignal;
  permissions?: PermissionSet;
}

// 工具结果
interface ToolResult {
  success: boolean;
  output?: string;
  error?: string;
  metadata?: Record<string, unknown>;
}
```

### 3.3 Provider 接口

```typescript
// Provider 接口
interface Provider {
  readonly name: string;
  readonly models: string[];
  readonly defaultModel: string;
  readonly supportsThinking: boolean;

  // 流式调用
  stream(request: ProviderRequest): AsyncGenerator<ProviderEvent>;

  // 非流式调用
  complete(request: ProviderRequest): Promise<ProviderResponse>;
}

// Provider 请求
interface ProviderRequest {
  messages: Message[];
  tools: ToolDefinition[];
  systemPrompt: string;
  model?: string;
  options?: ProviderOptions;
}

// Provider 响应
interface ProviderResponse {
  content: ContentPart[];
  stopReason: 'end_turn' | 'tool_use' | 'max_tokens';
  usage: TokenUsage;
}
```

---

## 4. 重构步骤

### Phase 1: 代码审查与依赖分析

**目标**: 全面了解当前代码结构和依赖关系

**任务**:
1. 生成完整依赖关系图
2. 识别循环依赖
3. 标记需要解耦的模块
4. 确定接口边界

**产出**:
- 依赖关系图文档
- 模块边界定义
- 解耦优先级列表

### Phase 2: Core 模块重构

**目标**: 将 core 模块变成纯净的、可独立使用的引擎

**任务**:
1. 创建 `KodaXEngine` 主类
2. 实现标准化事件系统
3. 移除所有 Node.js 特定依赖
4. 重构 Provider 接口
5. 重构 Tool 接口
6. 添加完整的单元测试

**文件结构**:
```
packages/core/
├── src/
│   ├── engine.ts          # KodaXEngine 主类
│   ├── types.ts           # 类型定义
│   ├── events.ts          # 事件系统
│   ├── provider/
│   │   ├── index.ts       # Provider 接口
│   │   ├── registry.ts    # Provider 注册
│   │   ├── anthropic.ts
│   │   ├── openai.ts
│   │   └── ...
│   ├── tools/
│   │   ├── index.ts       # Tool 接口
│   │   ├── registry.ts    # Tool 注册
│   │   └── base.ts        # 基础工具类
│   └── utils/
│       └── ...
├── package.json
├── tsconfig.json
└── README.md
```

### Phase 3: CLI 模块重构

**目标**: 创建薄层 CLI 封装，依赖 core 模块

**任务**:
1. 实现命令注册系统
2. 重构参数解析
3. 标准化输出格式
4. 实现程序化调用接口
5. 添加集成测试

**文件结构**:
```
packages/cli/
├── src/
│   ├── cli.ts             # CLI 入口
│   ├── command.ts         # 命令接口
│   ├── registry.ts        # 命令注册
│   ├── commands/
│   │   ├── help.ts
│   │   ├── version.ts
│   │   ├── run.ts
│   │   └── ...
│   ├── output/
│   │   ├── formatter.ts
│   │   └── stream.ts
│   └── utils/
│       └── args.ts
├── package.json
├── tsconfig.json
└── README.md
```

### Phase 4: REPL 模块重构

**目标**: 将 REPL 模块重构为独立的交互式终端包

**任务**:
1. 重构会话管理系统
2. 独立化 UI 组件
3. 实现上下文管理
4. 重构命令系统
5. 添加主题支持
6. 添加 E2E 测试

**文件结构**:
```
packages/repl/
├── src/
│   ├── repl.ts            # REPL 入口
│   ├── session/
│   │   ├── manager.ts     # 会话管理
│   │   ├── storage.ts     # 会话持久化
│   │   └── history.ts     # 历史记录
│   ├── commands/
│   │   ├── index.ts
│   │   ├── mode.ts
│   │   ├── project.ts
│   │   └── ...
│   ├── ui/
│   │   ├── components/
│   │   ├── contexts/
│   │   ├── themes/
│   │   └── utils/
│   └── utils/
│       └── ...
├── package.json
├── tsconfig.json
└── README.md
```

### Phase 5: 集成测试与发布

**目标**: 验证模块独立性并发布 npm 包

**任务**:
1. 编写跨包集成测试
2. 验证独立使用能力
3. 编写使用文档
4. 发布到 npm
5. 更新主项目依赖

**验证标准**:
```typescript
// @kodax/core - 必须能独立使用，可在浏览器运行
import { KodaXEngine } from '@kodax/core';
const engine = new KodaXEngine({
  provider: 'anthropic',
  model: 'claude-sonnet-4-20250514'
});
const result = await engine.execute({
  messages: [{ role: 'user', content: 'Hello!' }]
});

// @kodax/cli - 必须能程序化调用，可自定义命令
import { createCLI } from '@kodax/cli';
const cli = createCLI({ provider: 'anthropic' });
const exitCode = await cli.run(['node', 'kodax', 'run', 'Hello']);

// @kodax/repl - 必须能嵌入其他应用，可自定义 UI
import { createREPL } from '@kodax/repl';
const repl = createREPL({ provider: 'anthropic' });
await repl.start();
```

---

## 5. 风险分析

### 5.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 破坏现有功能 | 高 | 完整的测试覆盖，渐进式重构 |
| 性能下降 | 中 | 性能基准测试，优化关键路径 |
| API 不兼容 | 中 | 版本化 API，提供迁移指南 |
| 依赖冲突 | 低 | 严格的依赖管理，peer dependencies |

### 5.2 时间风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 评估不足 | 高 | Phase 1 预留缓冲时间 |
| 阻塞问题 | 中 | 每日进度检查，及时调整 |
| 文档滞后 | 低 | 代码与文档同步更新 |

---

## 6. 里程碑

| 阶段 | 目标 | 状态 |
|------|------|------|
| Phase 1 | 代码审查与依赖分析 | 待开始 |
| Phase 2 | Core 模块重构 | 待开始 |
| Phase 3 | CLI 模块重构 | 待开始 |
| Phase 4 | REPL 模块重构 | 待开始 |
| Phase 5 | 集成测试与发布 | 待开始 |

---

## 7. 相关文档

- [DESIGN.md](../DESIGN.md) - 当前架构设计
- [README.md](./README.md) - 功能总览
- [KNOWN_ISSUES.md](../KNOWN_ISSUES.md) - 已知问题

---

## 变更历史

| 日期 | 版本 | 变更 |
|------|------|------|
| 2025-02-20 | 0.1.0 | 初始规划文档 |
