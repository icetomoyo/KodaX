# v0.4.0 Feature Designs

**ç‰ˆæœ¬**: v0.4.0
**çŠ¶æ€**: Planned
**Feature æ•°é‡**: 1

---

## FEATURE_005: v0.4.0 æ¶æ„é‡æ„ä¸æ¨¡å—è§£è€¦

**Status**: Planned
**Priority**: High
**Category**: Refactor

### 1. éœ€æ±‚æ¦‚è¿°

é‡å¤§æ¶æ„é‡æ„ï¼Œåˆ›å»ºä¸‰ä¸ªé«˜åº¦è§£è€¦ã€å¯ç‹¬ç«‹ä½¿ç”¨çš„æ¨¡å—ï¼š`@kodax/core`ã€`@kodax/cli`ã€`@kodax/repl`

**Goals**:
1. **@kodax/core**: çº¯ AI å¼•æ“ï¼Œç¯å¢ƒæ— å…³ï¼ˆNode.jsã€æµè§ˆå™¨ã€è¾¹ç¼˜è¿è¡Œæ—¶ï¼‰
2. **@kodax/cli**: è–„å±‚ CLI å°è£…ï¼Œå¸¦å‘½ä»¤æ³¨å†Œç³»ç»Ÿ
3. **@kodax/repl**: å®Œæ•´çš„äº¤äº’å¼ç»ˆç«¯ä½“éªŒ

**Key Changes**:
- æ¨¡å—é—´æ ‡å‡†åŒ–æ¥å£
- äº‹ä»¶é©±åŠ¨æ¶æ„
- Provider å’Œ Tool æ’ä»¶ç³»ç»Ÿ
- ç‹¬ç«‹çš„ npm åŒ…

### 2. å½“å‰ä»£ç åˆ†æ

#### 2.1 Core å±‚ç°çŠ¶

| æ–‡ä»¶/ç›®å½• | è¡Œæ•° | çŠ¶æ€ | è¯´æ˜ |
|-----------|------|------|------|
| `src/kodax_core.ts` | ~1786 | **é—ç•™** | åŸå§‹å•ä½“å®ç° |
| `src/core/` | 28 æ–‡ä»¶ | **æ´»è·ƒ** | æ¨¡å—åŒ–å®ç° |

**é—ç•™å¼•ç”¨è¯¦æƒ…**ï¼ˆéœ€è¿ç§»ï¼‰:

| æ–‡ä»¶ | è¡Œå· | å¯¼å…¥å†…å®¹ | ç›®æ ‡ä½ç½® |
|------|------|----------|----------|
| `src/interactive/context.ts` | 5 | `KodaXMessage` | `../core/index.js` |
| `src/interactive/commands.ts` | 8 | `estimateTokens`, `KODAX_PROVIDERS`, `getProviderList`, `saveConfig` | åˆ†æ‹†åˆ° `../core/index.js` å’Œ `../cli/utils.js` |

**âš ï¸ é‡è¦å‘ç°ï¼š`saveConfig` é‡å¤å®šä¹‰**:
- `src/kodax_core.ts:60` - é—ç•™ç‰ˆæœ¬
- `src/cli/utils.ts:83` - æ–°ç‰ˆæœ¬
- **å†³ç­–**: ä½¿ç”¨ `cli/utils.ts` ç‰ˆæœ¬ï¼Œåˆ é™¤ `kodax_core.ts` ç‰ˆæœ¬

**`src/core/` ç›®å½•ç»“æ„**ï¼ˆå·²å®Œæˆæ¨¡å—åŒ–ï¼‰:
```
src/core/
â”œâ”€â”€ index.ts           # ç»Ÿä¸€å¯¼å‡º
â”œâ”€â”€ types.ts           # ç±»å‹å®šä¹‰
â”œâ”€â”€ errors.ts          # é”™è¯¯ç±»
â”œâ”€â”€ constants.ts       # å¸¸é‡
â”œâ”€â”€ agent.ts           # runKodaX ä¸»å‡½æ•°
â”œâ”€â”€ client.ts          # KodaXClient ç±»
â”œâ”€â”€ session.ts         # ä¼šè¯å·¥å…·
â”œâ”€â”€ messages.ts        # æ¶ˆæ¯å¤„ç†
â”œâ”€â”€ tokenizer.ts       # Token ä¼°ç®—
â”œâ”€â”€ providers/         # Provider å®ç°
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ base.ts
â”‚   â”œâ”€â”€ registry.ts
â”‚   â”œâ”€â”€ anthropic.ts
â”‚   â””â”€â”€ openai.ts
â”œâ”€â”€ tools/             # Tool å®ç°
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ types.ts
â”‚   â”œâ”€â”€ registry.ts
â”‚   â”œâ”€â”€ read.ts
â”‚   â”œâ”€â”€ write.ts
â”‚   â”œâ”€â”€ edit.ts
â”‚   â”œâ”€â”€ bash.ts
â”‚   â”œâ”€â”€ glob.ts
â”‚   â”œâ”€â”€ grep.ts
â”‚   â””â”€â”€ undo.ts
â””â”€â”€ prompts/           # System prompts
    â”œâ”€â”€ index.ts
    â”œâ”€â”€ builder.ts
    â”œâ”€â”€ system.ts
    â””â”€â”€ long-running.ts
```

**`src/core/index.ts` å·²å¯¼å‡ºçš„å†…å®¹**:
```typescript
// ä» core/index.ts å¯è·å–ï¼š
- æ‰€æœ‰ç±»å‹ï¼ˆKodaXMessage, KodaXOptions, KodaXResult ç­‰ï¼‰
- estimateTokens
- KODAX_PROVIDERS, getProvider, getProviderList, isProviderConfigured
- runKodaX, KodaXClient
- æ‰€æœ‰é”™è¯¯ç±»
- æ‰€æœ‰å¸¸é‡
```

#### 2.2 CLI å±‚ç°çŠ¶

| æ–‡ä»¶/ç›®å½• | è¡Œæ•° | çŠ¶æ€ | è¯´æ˜ |
|-----------|------|------|------|
| `src/kodax_cli.ts` | ~1149 | **æ´»è·ƒ** | CLI å…¥å£ + è¿‡å¤šä¸šåŠ¡é€»è¾‘ |
| `src/cli/` | 3 æ–‡ä»¶ | **è¾…åŠ©** | å·¥å…·å‡½æ•° |

**`kodax_cli.ts` èŒè´£è¿‡é‡**ï¼ˆéœ€æ‹†åˆ†ï¼‰:

| èŒè´£ | è¡Œæ•°èŒƒå›´ | åº”å½’å± | ä¼˜å…ˆçº§ |
|------|----------|--------|--------|
| å‚æ•°è§£æ (Commander) | 704-734 | @kodax/cli | ä¿æŒ |
| å‘½ä»¤æ³¨å†Œç³»ç»Ÿ | 49-154 | @kodax/cli | ä¿æŒ |
| Spinner åŠ¨ç”» | 180-232 | @kodax/repl | è¿ç§» |
| FileSessionStorage | 236-306 | @kodax/repl | è¿ç§» |
| CLI äº‹ä»¶å¤„ç†å™¨ | 326-456 | @kodax/repl | è¿ç§» |
| å¸®åŠ©ç³»ç»Ÿ | 522-701 | @kodax/cli | ä¿æŒ |
| --init é€»è¾‘ | 904-972 | @kodax/cli | è¿ç§»åˆ° cli/ |
| --team é€»è¾‘ | 974-1047 | @kodax/cli | ä¿æŒ |
| --auto-continue é€»è¾‘ | 812-902 | @kodax/cli | ä¿æŒ |

#### 2.3 äº¤äº’å±‚ç°çŠ¶

| æ–‡ä»¶/ç›®å½• | è¯´æ˜ |
|-----------|------|
| `src/interactive/` | REPL å‘½ä»¤å’Œäº¤äº’é€»è¾‘ |
| `src/ui/` | Ink UI ç»„ä»¶ |

**`src/interactive/` ç›®å½•**:
```
src/interactive/
â”œâ”€â”€ index.ts           # å¯¼å‡º
â”œâ”€â”€ commands.ts        # REPL å‘½ä»¤å¤„ç†
â”œâ”€â”€ context.ts         # äº¤äº’ä¸Šä¸‹æ–‡
â”œâ”€â”€ repl.ts            # REPL ä¸»é€»è¾‘
â””â”€â”€ project-commands.ts # /project å‘½ä»¤å®ç°
```

**`src/ui/` ç›®å½•**:
```
src/ui/
â”œâ”€â”€ index.ts           # ç»Ÿä¸€å¯¼å‡º
â”œâ”€â”€ App.tsx            # ä¸»åº”ç”¨ç»„ä»¶
â”œâ”€â”€ InkREPL.tsx        # Ink REPL é€‚é…å™¨
â”œâ”€â”€ components/        # UI ç»„ä»¶
â”œâ”€â”€ hooks/             # React Hooks
â”œâ”€â”€ utils/             # UI å·¥å…·
â”œâ”€â”€ themes/            # ä¸»é¢˜
â””â”€â”€ types.ts           # ç±»å‹å®šä¹‰
```

### 3. å½±å“èŒƒå›´

**å½“å‰é—®é¢˜**:
1. **é—ç•™ä»£ç æœªæ¸…ç†**: `kodax_core.ts` ä»è¢«å¼•ç”¨ï¼Œä¸ `core/` åŠŸèƒ½é‡å¤
2. **CLI èŒè´£è¿‡é‡**: `kodax_cli.ts` åŒ…å« UI å±‚é€»è¾‘ï¼ˆSpinnerã€äº‹ä»¶å¤„ç†ï¼‰
3. **æ¨¡å—è¾¹ç•Œæ¨¡ç³Š**: SessionStorageã€äº‹ä»¶å¤„ç†å½’å±ä¸æ˜ç¡®
4. **éš¾ä»¥ç‹¬ç«‹ä½¿ç”¨**: æ— æ³•å°†å•ä¸ªæ¨¡å—ä½œä¸ºç‹¬ç«‹åº“ä½¿ç”¨

**éœ€è¦åˆ›å»ºçš„ packages ç»“æ„**:
```
packages/
â”œâ”€â”€ core/                    # @kodax/core
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.ts         # ç»Ÿä¸€å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ engine.ts        # KodaXEngine ä¸»ç±»ï¼ˆé‡æ„è‡ª agent.tsï¼‰
â”‚   â”‚   â”œâ”€â”€ types.ts         # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ events.ts        # äº‹ä»¶ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ errors.ts        # é”™è¯¯ç±»
â”‚   â”‚   â”œâ”€â”€ constants.ts     # å¸¸é‡
â”‚   â”‚   â”œâ”€â”€ session.ts       # ä¼šè¯å·¥å…·
â”‚   â”‚   â”œâ”€â”€ messages.ts      # æ¶ˆæ¯å¤„ç†
â”‚   â”‚   â”œâ”€â”€ tokenizer.ts     # Token ä¼°ç®—
â”‚   â”‚   â”œâ”€â”€ providers/       # Provider å®ç°
â”‚   â”‚   â”œâ”€â”€ tools/           # Tool å®ç°
â”‚   â”‚   â””â”€â”€ prompts/         # System prompts
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”‚
â”œâ”€â”€ cli/                     # @kodax/cli
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.ts         # ç»Ÿä¸€å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ cli.ts           # CLI å…¥å£ï¼ˆé‡æ„è‡ª kodax_cli.tsï¼‰
â”‚   â”‚   â”œâ”€â”€ parser.ts        # å‚æ•°è§£æ
â”‚   â”‚   â”œâ”€â”€ commands/        # å‘½ä»¤ç³»ç»Ÿ
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ registry.ts  # å‘½ä»¤æ³¨å†Œ
â”‚   â”‚   â”‚   â”œâ”€â”€ loader.ts    # å‘½ä»¤åŠ è½½
â”‚   â”‚   â”‚   â””â”€â”€ types.ts     # å‘½ä»¤ç±»å‹
â”‚   â”‚   â”œâ”€â”€ config.ts        # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ init.ts          # --init ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ team.ts          # --team ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ auto.ts          # --auto-continue ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ help.ts          # å¸®åŠ©ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ utils.ts         # CLI å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”‚
â””â”€â”€ repl/                    # @kodax/repl
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ index.ts         # ç»Ÿä¸€å¯¼å‡º
    â”‚   â”œâ”€â”€ repl.ts          # REPL å…¥å£
    â”‚   â”œâ”€â”€ session/         # ä¼šè¯ç®¡ç†
    â”‚   â”‚   â”œâ”€â”€ index.ts
    â”‚   â”‚   â”œâ”€â”€ storage.ts   # FileSessionStorage
    â”‚   â”‚   â””â”€â”€ manager.ts   # ä¼šè¯ç®¡ç†å™¨
    â”‚   â”œâ”€â”€ events/          # äº‹ä»¶å¤„ç†
    â”‚   â”‚   â”œâ”€â”€ index.ts
    â”‚   â”‚   â”œâ”€â”€ cli-events.ts # CLI äº‹ä»¶å¤„ç†å™¨
    â”‚   â”‚   â””â”€â”€ spinner.ts   # Spinner åŠ¨ç”»
    â”‚   â”œâ”€â”€ interactive/     # äº¤äº’å‘½ä»¤
    â”‚   â”‚   â”œâ”€â”€ index.ts
    â”‚   â”‚   â”œâ”€â”€ commands.ts  # REPL å‘½ä»¤
    â”‚   â”‚   â”œâ”€â”€ context.ts   # äº¤äº’ä¸Šä¸‹æ–‡
    â”‚   â”‚   â””â”€â”€ project.ts   # /project å‘½ä»¤
    â”‚   â””â”€â”€ ui/              # Ink UI ç»„ä»¶
    â”‚       â”œâ”€â”€ index.ts
    â”‚       â”œâ”€â”€ app.tsx      # ä¸»åº”ç”¨
    â”‚       â”œâ”€â”€ input.tsx    # è¾“å…¥ç»„ä»¶
    â”‚       â”œâ”€â”€ message.tsx  # æ¶ˆæ¯æ˜¾ç¤º
    â”‚       â””â”€â”€ status.tsx   # çŠ¶æ€æ˜¾ç¤º
    â”œâ”€â”€ package.json
    â””â”€â”€ tsconfig.json
```

### 4. æŠ€æœ¯æ–¹æ¡ˆ

**ç›®æ ‡æ¶æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      KodaX v0.4.0                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  @kodax/core â”‚ â† â”‚  @kodax/cli  â”‚ â† â”‚  @kodax/repl â”‚     â”‚
â”‚  â”‚              â”‚   â”‚              â”‚   â”‚              â”‚     â”‚
â”‚  â”‚  æ ¸å¿ƒå¼•æ“     â”‚   â”‚  CLI å…¥å£    â”‚   â”‚  äº¤äº’å¼ç»ˆç«¯   â”‚     â”‚
â”‚  â”‚  Provider    â”‚   â”‚  å‘½ä»¤è§£æ    â”‚   â”‚  Ink UI      â”‚     â”‚
â”‚  â”‚  Agent       â”‚   â”‚  å‚æ•°å¤„ç†    â”‚   â”‚  ä¼šè¯ç®¡ç†    â”‚     â”‚
â”‚  â”‚  Tools       â”‚   â”‚  é…ç½®ç®¡ç†    â”‚   â”‚  å†å²è®°å½•    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â†‘                  â†‘                  â†‘              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                          æ ‡å‡†åŒ–æ¥å£                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒåŸåˆ™**:
| æ¨¡å— | è®¾è®¡åŸåˆ™ | èŒè´£è¾¹ç•Œ | ä¸åº”åŒ…å« |
|------|----------|----------|----------|
| `@kodax/core` | **æç®€ã€æ™ºèƒ½ã€æ— å‰¯ä½œç”¨** | åªè´Ÿè´£ AI äº¤äº’ | âŒ fs/path, âŒ é…ç½®æ–‡ä»¶, âŒ å…¨å±€çŠ¶æ€ |
| `@kodax/cli` | **æç®€ã€æ™ºèƒ½ã€è–„å±‚** | åªè´Ÿè´£å‘½ä»¤è§£æå’Œå‚æ•°å¤„ç† | âŒ UI ç»„ä»¶, âŒ Spinner, âŒ ä¼šè¯æŒä¹…åŒ– |
| `@kodax/repl` | **æ™ºèƒ½ã€æ¸…æ™°ã€é«˜å¯é ** | è´Ÿè´£äº¤äº’å¼ä½“éªŒå’ŒçŠ¶æ€ç®¡ç† | âŒ Provider é€»è¾‘, âŒ Tool æ‰§è¡Œ |

**æ¨¡å—èƒ½åŠ›çŸ©é˜µ**:

| èƒ½åŠ› | @kodax/core | @kodax/cli | @kodax/repl |
|------|:-----------:|:----------:|:-----------:|
| Provider æŠ½è±¡å±‚ | âœ… | - | - |
| Tool æ‰§è¡Œå¼•æ“ | âœ… | - | - |
| Agent ä¸»å¾ªç¯ | âœ… | - | - |
| äº‹ä»¶ç³»ç»Ÿ | âœ… | - | - |
| Token ä¼°ç®— | âœ… | - | - |
| System Prompt | âœ… | - | - |
| å‚æ•°è§£æ | - | âœ… | - |
| å‘½ä»¤æ³¨å†Œ | - | âœ… | - |
| é…ç½®è¯»å†™ | - | âœ… | - |
| --init é€»è¾‘ | - | âœ… | - |
| --team é€»è¾‘ | - | âœ… | - |
| --auto-continue | - | âœ… | - |
| Ink UI | - | - | âœ… |
| Spinner | - | - | âœ… |
| FileSessionStorage | - | - | âœ… |
| äº¤äº’å‘½ä»¤ | - | - | âœ… |
| ä¼šè¯æŒä¹…åŒ– | - | - | âœ… |

### 5. æ¥å£å¥‘çº¦

#### 5.1 @kodax/core å¯¼å‡º

```typescript
// ===== ä¸»è¦ API =====

// æ ¸å¿ƒå¼•æ“å‡½æ•°ï¼ˆä¿æŒç°æœ‰ APIï¼‰
export function runKodaX(options: KodaXOptions, prompt: string): Promise<KodaXResult>;

// Client ç±»
export class KodaXClient {
  constructor(options: KodaXOptions);
  send(prompt: string): Promise<KodaXResult>;
  getMessages(): KodaXMessage[];
}

// ===== ç±»å‹å¯¼å‡º =====
export type {
  KodaXContentBlock,
  KodaXTextBlock,
  KodaXToolUseBlock,
  KodaXToolResultBlock,
  KodaXThinkingBlock,
  KodaXRedactedThinkingBlock,
  KodaXMessage,
  KodaXSessionMeta,
  KodaXStreamResult,
  KodaXToolDefinition,
  KodaXProviderConfig,
  KodaXProviderStreamOptions,
  KodaXEvents,
  KodaXSessionOptions,
  KodaXContextOptions,
  KodaXOptions,
  KodaXResult,
  KodaXSessionStorage,
  KodaXToolExecutionContext,
  KodaXConfig,
};

// ===== é”™è¯¯ç±» =====
export {
  KodaXError,
  KodaXProviderError,
  KodaXToolError,
  KodaXRateLimitError,
  KodaXSessionError,
  KodaXTerminalError,
};

// ===== å¸¸é‡ =====
export {
  KODAX_MAX_TOKENS,
  KODAX_DEFAULT_TIMEOUT,
  KODAX_HARD_TIMEOUT,
  KODAX_COMPACT_THRESHOLD,
  KODAX_COMPACT_KEEP_RECENT,
  KODAX_MAX_RETRIES,
  KODAX_RETRY_BASE_DELAY,
  KODAX_MAX_INCOMPLETE_RETRIES,
  KODAX_STAGGER_DELAY,
  KODAX_API_MIN_INTERVAL,
  KODAX_TOOL_REQUIRED_PARAMS,
};

// ===== Provider =====
export {
  KodaXBaseProvider,
  KodaXAnthropicCompatProvider,
  KodaXOpenAICompatProvider,
  KODAX_PROVIDERS,
  KODAX_DEFAULT_PROVIDER,
  getProvider,
  isProviderConfigured,
  getProviderModel,
  getProviderList,
  ProviderName,
  isProviderName,
};

// ===== Tools =====
export {
  type ToolHandler,
  type ToolRegistry,
  KODAX_TOOLS,
  registerTool,
  getTool,
  listTools,
  executeTool,
};

// ===== å·¥å…·å‡½æ•° =====
export {
  generateSessionId,
  extractTitleFromMessages,
  compactMessages,
  checkIncompleteToolCalls,
  estimateTokens,
  checkPromiseSignal,
  buildSystemPrompt,
};
```

#### 5.2 @kodax/cli å¯¼å‡º

```typescript
// ===== ä¸»è¦ API =====

// CLI å…¥å£å‡½æ•°
export function runCLI(argv: string[]): Promise<number>;

// ç¨‹åºåŒ–è°ƒç”¨
export function createCLI(options: CLIOptions): CLI;

interface CLIOptions {
  provider?: string;
  thinking?: boolean;
  auto?: boolean;
}

interface CLI {
  run(argv: string[]): Promise<number>;
  execute(prompt: string): Promise<KodaXResult>;
}

// ===== å‘½ä»¤ç³»ç»Ÿ =====
export interface KodaXCommand {
  name: string;
  description: string;
  content: string;
  type: 'prompt' | 'programmable';
  execute?: (context: KodaXCommandContext) => Promise<string>;
}

export function loadCommands(dir?: string): Promise<Map<string, KodaXCommand>>;
export function parseCommandCall(input: string): [string, string?] | null;
export function processCommandCall(
  name: string,
  args: string | undefined,
  commands: Map<string, KodaXCommand>,
  runAgent: (prompt: string) => Promise<KodaXResult>
): Promise<string | null>;

// ===== é…ç½®ç®¡ç† =====
export function loadConfig(): KodaXConfig;
export function saveConfig(config: Partial<KodaXConfig>): void;
export const KODAX_CONFIG_FILE: string;

// ===== å·¥å…·å‡½æ•° =====
export function getVersion(): string;
export function getGitRoot(): Promise<string | null>;
export function getProviderList(): Array<{ name: string; model: string; configured: boolean }>;
export function buildInitPrompt(task: string, date?: string, os?: string): string;
export function getFeatureProgress(): [completed: number, total: number];
export function checkAllFeaturesComplete(): boolean;
```

#### 5.3 @kodax/repl å¯¼å‡º

```typescript
// ===== ä¸»è¦ API =====

// REPL å…¥å£
export function createREPL(options: REPLOptions): REPL;
export function runInkInteractiveMode(options: InteractiveOptions): Promise<void>;

interface REPLOptions {
  provider: string;
  thinking?: boolean;
  auto?: boolean;
  maxIter?: number;
  parallel?: boolean;
  mode?: 'code' | 'ask';
  storage?: KodaXSessionStorage;
}

interface REPL {
  start(): Promise<void>;
  stop(): void;
  send(message: string): Promise<void>;
}

// ===== ä¼šè¯å­˜å‚¨ =====
export class FileSessionStorage implements KodaXSessionStorage {
  save(id: string, data: SessionData): Promise<void>;
  load(id: string): Promise<SessionData | null>;
  list(gitRoot?: string): Promise<SessionInfo[]>;
  delete(id: string): Promise<void>;
  deleteAll(gitRoot?: string): Promise<void>;
}

// ===== äº‹ä»¶å¤„ç†å™¨ =====
export function createCliEvents(showSessionId?: boolean): KodaXEvents;

// ===== äº¤äº’å‘½ä»¤ =====
export function registerInteractiveCommands(context: InteractiveContext): void;
export function handleInteractiveCommand(input: string): Promise<boolean>;

// ===== UI ç»„ä»¶ =====
export { App } from './ui/app.js';
export { Input } from './ui/input.js';
export { Message } from './ui/message.js';
export { Status } from './ui/status.js';
```

### 6. å®ç°æ­¥éª¤

---

## æ›´æ–°æ—¥å¿—

### 2026-02-22: èåˆå·²çŸ¥é—®é¢˜
- æ·»åŠ  ISSUE_037 (ä¸¤å¥—é”®ç›˜äº‹ä»¶ç³»ç»Ÿå†²çª) è§£å†³æ–¹æ¡ˆåˆ° Phase 5
- æ·»åŠ  ISSUE_039 (æ­»ä»£ç  printStartupBanner) è§£å†³æ–¹æ¡ˆåˆ° Phase 5
- æ›´æ–° Phase 5 æ—¶é—´ä¼°ç®—ï¼ˆåŒ…å« Issue ä¿®å¤æ—¶é—´ï¼‰
- æ›´æ–°ç‰ˆæœ¬æ€»ç»“ï¼Œåˆ—å‡ºåŒæ­¥è§£å†³çš„å·²çŸ¥é—®é¢˜

---

## ğŸ”’ å®‰å…¨æ£€æŸ¥æ¸…å•

æ¯ä¸ª Phase æ‰§è¡Œå‰å¿…é¡»ç¡®è®¤ä»¥ä¸‹æ£€æŸ¥é¡¹ï¼š

### é€šç”¨æ£€æŸ¥é¡¹ï¼ˆæ‰€æœ‰ Phaseï¼‰

| æ£€æŸ¥é¡¹ | è¯´æ˜ |
|--------|------|
| â˜ Git çŠ¶æ€å¹²å‡€ | `git status` æ— æœªæäº¤æ›´æ”¹ |
| â˜ æ„å»ºæˆåŠŸ | `npm run build` æ— é”™è¯¯ |
| â˜ æµ‹è¯•é€šè¿‡ | `npm test` å…¨éƒ¨é€šè¿‡ |
| â˜ åˆ›å»ºå¤‡ä»½åˆ†æ”¯ | `git branch backup-phase-N` |

### å›æ»šç­–ç•¥

| åœºæ™¯ | å›æ»šå‘½ä»¤ |
|------|----------|
| Phase å¤±è´¥ | `git checkout .` æˆ– `git reset --hard backup-phase-N` |
| å‘å¸ƒåå‘ç°é—®é¢˜ | `npm unpublish @kodax/xxx@0.4.0` æˆ–å‘å¸ƒ patch ç‰ˆæœ¬ä¿®å¤ |

---

#### Phase 0: æ¸…ç†é—ç•™ä»£ç 

**ç›®æ ‡**: ç§»é™¤ `kodax_core.ts`ï¼Œç»Ÿä¸€ä½¿ç”¨ `core/` æ¨¡å—

**â±ï¸ é¢„ä¼°æ—¶é—´**: 30 åˆ†é’Ÿ

**ğŸ“‹ å‰ç½®æ¡ä»¶**:
- [ ] å½“å‰åœ¨ `main` åˆ†æ”¯
- [ ] `git status` å¹²å‡€
- [ ] `npm run build` æˆåŠŸ

**ğŸ“ è¯¦ç»†æ­¥éª¤**:

**Step 0.1: åˆ›å»ºå¤‡ä»½åˆ†æ”¯**
```bash
git checkout -b refactor/phase0-cleanup-kodax-core
git push -u origin refactor/phase0-cleanup-kodax-core
```

**Step 0.2: è¿ç§» `interactive/context.ts`**

å½“å‰ä»£ç ï¼ˆç¬¬5è¡Œï¼‰:
```typescript
import { KodaXMessage } from '../kodax_core.js';
```

ä¿®æ”¹ä¸º:
```typescript
import { KodaXMessage } from '../core/index.js';
```

**å½±å“åˆ†æ**:
| å½±å“é¡¹ | åˆ†æ |
|--------|------|
| åŠŸèƒ½å˜åŒ– | æ— ï¼Œ`KodaXMessage` ç±»å‹å®šä¹‰å®Œå…¨ç›¸åŒ |
| ä¾èµ–å˜åŒ– | ä» `kodax_core.ts` æ”¹ä¸º `core/index.ts` |
| æ½œåœ¨é—®é¢˜ | æ— ï¼Œ`core/index.ts` å·²å¯¼å‡º `KodaXMessage` |

**éªŒè¯å‘½ä»¤**:
```bash
npm run build
# æœŸæœ›ï¼šæ— ç¼–è¯‘é”™è¯¯
```

**Step 0.3: è¿ç§» `interactive/commands.ts`**

å½“å‰ä»£ç ï¼ˆç¬¬8è¡Œï¼‰:
```typescript
import { estimateTokens, KODAX_PROVIDERS, getProviderList, saveConfig } from '../kodax_core.js';
```

ä¿®æ”¹ä¸º:
```typescript
import { estimateTokens, KODAX_PROVIDERS, getProviderList } from '../core/index.js';
import { saveConfig } from '../cli/utils.js';
```

**å½±å“åˆ†æ**:
| å½±å“é¡¹ | åˆ†æ |
|--------|------|
| åŠŸèƒ½å˜åŒ– | æ— ï¼Œæ‰€æœ‰å¯¼å‡ºå‡½æ•°ç­¾åå…¼å®¹ |
| ä¾èµ–å˜åŒ– | `saveConfig` æ”¹ä» `cli/utils.ts` å¯¼å…¥ |
| âš ï¸ æ³¨æ„ | `saveConfig` åœ¨ä¸¤å¤„å®šä¹‰ï¼Œä½¿ç”¨ `cli/utils.ts` ç‰ˆæœ¬ |

**éªŒè¯å‘½ä»¤**:
```bash
npm run build
# æœŸæœ›ï¼šæ— ç¼–è¯‘é”™è¯¯
```

**Step 0.4: éªŒè¯æ— å…¶ä»–å¼•ç”¨**
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–æ–‡ä»¶å¼•ç”¨ kodax_core
grep -r "from.*kodax_core" src/
# æœŸæœ›ï¼šæ— è¾“å‡ºï¼ˆæˆ–ä»…æ˜¾ç¤ºå·²ä¿®æ”¹çš„æ–‡ä»¶ï¼‰
```

**Step 0.5: åˆ é™¤ `kodax_core.ts`**
```bash
rm src/kodax_core.ts
```

**Step 0.6: å®Œæ•´éªŒè¯**
```bash
npm run build
npm test
# æœŸæœ›ï¼šå…¨éƒ¨é€šè¿‡
```

**Step 0.7: åŠŸèƒ½å›å½’æµ‹è¯•**

æ‰‹åŠ¨æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ç¡®ä¿æ­£å¸¸ï¼š
```bash
# æµ‹è¯• 1: äº¤äº’æ¨¡å¼
kodax
# è¾“å…¥: /status
# æœŸæœ›: æ˜¾ç¤ºä¼šè¯çŠ¶æ€

# æµ‹è¯• 2: /model å‘½ä»¤
# è¾“å…¥: /model
# æœŸæœ›: æ˜¾ç¤ºæ‰€æœ‰ provider åˆ—è¡¨

# æµ‹è¯• 3: /thinking å‘½ä»¤
# è¾“å…¥: /thinking on
# æœŸæœ›: "Thinking enabled"

# æµ‹è¯• 4: é€€å‡º
# è¾“å…¥: /exit
# æœŸæœ›: æ­£å¸¸é€€å‡º
```

**Step 0.8: æäº¤**
```bash
git add .
git commit -m "refactor(phase0): remove kodax_core.ts, migrate to core/ module"
```

**âœ… éªŒæ”¶æ ‡å‡†**:
- [ ] `kodax_core.ts` å·²åˆ é™¤
- [ ] æ‰€æœ‰å¼•ç”¨å·²è¿ç§»åˆ° `core/index.js` æˆ– `cli/utils.js`
- [ ] `npm run build` æˆåŠŸ
- [ ] `npm test` é€šè¿‡
- [ ] æ‰‹åŠ¨åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] Git æäº¤å®Œæˆ

**ğŸ”„ å›æ»šæ­¥éª¤**ï¼ˆå¦‚æœå¤±è´¥ï¼‰:
```bash
git checkout .
git checkout main
git branch -D refactor/phase0-cleanup-kodax-core
```

---

#### Phase 1: æ‹†åˆ† kodax_cli.ts

**ç›®æ ‡**: å°† `kodax_cli.ts` ä¸­çš„ UI å±‚é€»è¾‘è¿ç§»åˆ°åˆé€‚ä½ç½®

**â±ï¸ é¢„ä¼°æ—¶é—´**: 1-2 å°æ—¶

**ğŸ“‹ å‰ç½®æ¡ä»¶**:
- [ ] Phase 0 å·²å®Œæˆå¹¶åˆå¹¶
- [ ] `git status` å¹²å‡€
- [ ] `npm run build` æˆåŠŸ

**ğŸ“ è¯¦ç»†æ­¥éª¤**:

**Step 1.1: åˆ›å»ºå¤‡ä»½åˆ†æ”¯**
```bash
git checkout -b refactor/phase1-split-kodax-cli
git push -u origin refactor/phase1-split-kodax-cli
```

**Step 1.2: æå– FileSessionStorage**

åˆ›å»ºæ–°æ–‡ä»¶ `src/interactive/storage.ts`:

```typescript
/**
 * KodaX ä¼šè¯å­˜å‚¨ - æ–‡ä»¶ç³»ç»Ÿå®ç°
 */

import fs from 'fs/promises';
import fsSync from 'fs';
import path from 'path';
import os from 'os';
import { KodaXMessage, KodaXSessionStorage } from '../core/index.js';
import { getGitRoot } from '../cli/utils.js';

export const KODAX_SESSIONS_DIR = path.join(os.homedir(), '.kodax', 'sessions');

export class FileSessionStorage implements KodaXSessionStorage {
  async save(id: string, data: { messages: KodaXMessage[]; title: string; gitRoot: string }): Promise<void> {
    await fs.mkdir(KODAX_SESSIONS_DIR, { recursive: true });
    const meta = { _type: 'meta', title: data.title, id, gitRoot: data.gitRoot, createdAt: new Date().toISOString() };
    const lines = [JSON.stringify(meta), ...data.messages.map(m => JSON.stringify(m))];
    await fs.writeFile(path.join(KODAX_SESSIONS_DIR, `${id}.jsonl`), lines.join('\n'), 'utf-8');
  }

  async load(id: string): Promise<{ messages: KodaXMessage[]; title: string; gitRoot: string } | null> {
    const filePath = path.join(KODAX_SESSIONS_DIR, `${id}.jsonl`);
    if (!fsSync.existsSync(filePath)) return null;
    const lines = (await fs.readFile(filePath, 'utf-8')).trim().split('\n');
    const messages: KodaXMessage[] = [];
    let title = '', gitRoot = '';
    for (let i = 0; i < lines.length; i++) {
      const data = JSON.parse(lines[i]!);
      if (i === 0 && data._type === 'meta') { title = data.title ?? ''; gitRoot = data.gitRoot ?? ''; }
      else messages.push(data);
    }

    const currentGitRoot = await getGitRoot();
    if (currentGitRoot && gitRoot && currentGitRoot !== gitRoot) {
      console.log(chalk.yellow(`\n[Warning] Session project mismatch:`));
      console.log(`  Current:  ${currentGitRoot}`);
      console.log(`  Session:  ${gitRoot}`);
      console.log(`  Continuing anyway...\n`);
    }

    return { messages, title, gitRoot };
  }

  async list(gitRoot?: string): Promise<Array<{ id: string; title: string; msgCount: number }>> {
    await fs.mkdir(KODAX_SESSIONS_DIR, { recursive: true });
    const currentGitRoot = gitRoot ?? await getGitRoot();
    const files = (await fs.readdir(KODAX_SESSIONS_DIR)).filter(f => f.endsWith('.jsonl'));
    const sessions = [];
    for (const f of files) {
      try {
        const content = (await fs.readFile(path.join(KODAX_SESSIONS_DIR, f), 'utf-8')).trim();
        const firstLine = content.split('\n')[0];
        if (!firstLine) continue;
        const first = JSON.parse(firstLine);
        if (first._type === 'meta') {
          const sessionGitRoot = first.gitRoot ?? '';
          if (currentGitRoot && sessionGitRoot && currentGitRoot !== sessionGitRoot) continue;
          const lineCount = content.split('\n').length;
          sessions.push({ id: f.replace('.jsonl', ''), title: first.title ?? '', msgCount: lineCount - 1 });
        } else {
          const lineCount = content.split('\n').length;
          sessions.push({ id: f.replace('.jsonl', ''), title: '', msgCount: lineCount });
        }
      } catch { continue; }
    }
    return sessions.sort((a, b) => b.id.localeCompare(a.id)).slice(0, 10);
  }

  async delete(id: string): Promise<void> {
    const filePath = path.join(KODAX_SESSIONS_DIR, `${id}.jsonl`);
    if (fsSync.existsSync(filePath)) {
      await fs.unlink(filePath);
    }
  }

  async deleteAll(gitRoot?: string): Promise<void> {
    const currentGitRoot = gitRoot ?? await getGitRoot();
    const sessions = await this.list(currentGitRoot ?? undefined);
    for (const s of sessions) {
      await this.delete(s.id);
    }
  }
}
```

**å½±å“åˆ†æ**:
| å½±å“é¡¹ | åˆ†æ |
|--------|------|
| æ–°æ–‡ä»¶ | `src/interactive/storage.ts` |
| ä¾èµ–å˜åŒ– | éœ€è¦å¯¼å…¥ `chalk`ï¼ˆç”¨äº warning è¾“å‡ºï¼‰ |
| è¡Œä¸ºå˜åŒ– | æ— ï¼Œä»£ç ä» `kodax_cli.ts` ç›´æ¥ç§»åŠ¨ |

**Step 1.3: æ›´æ–° `kodax_cli.ts` å¯¼å…¥**

ä¿®æ”¹ `src/kodax_cli.ts`:
```diff
+ import { FileSessionStorage, KODAX_SESSIONS_DIR } from './interactive/storage.js';
```

åˆ é™¤ `kodax_cli.ts` ä¸­çš„ `FileSessionStorage` ç±»å®šä¹‰ï¼ˆçº¦ 70 è¡Œï¼‰ã€‚

**Step 1.4: æå– CLI Events å’Œ Spinner**

åˆ›å»ºæ–°æ–‡ä»¶ `src/ui/cli-events.ts`:

```typescript
/**
 * KodaX CLI äº‹ä»¶å¤„ç†å™¨
 */

import chalk from 'chalk';
import { KodaXEvents } from '../core/index.js';

// Spinner ç›¸å…³å¸¸é‡å’Œå‡½æ•°
const SPINNER_FRAMES = ['â ‹', 'â ™', 'â ¹', 'â ¸', 'â ¼', 'â ´', 'â ¦', 'â §', 'â ‡', 'â '];
const SPINNER_COLORS = ['\x1b[36m', '\x1b[35m', '\x1b[34m'];

let globalSpinner: {
  stop: () => void;
  isStopped: () => boolean;
  updateText: (text: string) => void;
} | null = null;

let spinnerNewlined = false;

export function startWaitingDots(): { stop: () => void; updateText: (text: string) => void; isStopped: () => boolean } {
  // ... ä» kodax_cli.ts å¤åˆ¶å®ç°
}

export function createCliEvents(showSessionId = true): KodaXEvents {
  // ... ä» kodax_cli.ts å¤åˆ¶å®ç°
}
```

**Step 1.5: æ›´æ–° `kodax_cli.ts` å¯¼å…¥**

```diff
+ import { createCliEvents } from './ui/cli-events.js';
```

åˆ é™¤ `kodax_cli.ts` ä¸­çš„ `SPINNER_*` å¸¸é‡ã€`startWaitingDots` å‡½æ•°ã€`createCliEvents` å‡½æ•°ï¼ˆçº¦ 130 è¡Œï¼‰ã€‚

**Step 1.6: éªŒè¯æ„å»º**
```bash
npm run build
# æœŸæœ›ï¼šæ— ç¼–è¯‘é”™è¯¯
```

**Step 1.7: åŠŸèƒ½å›å½’æµ‹è¯•**

```bash
# æµ‹è¯• 1: Print æ¨¡å¼
kodax -p "say hello"
# æœŸæœ›ï¼šæ­£å¸¸è¾“å‡ºï¼Œspinner å·¥ä½œ

# æµ‹è¯• 2: äº¤äº’æ¨¡å¼
kodax
# è¾“å…¥: test message
# æœŸæœ›ï¼šæ­£å¸¸å“åº”ï¼Œspinner å·¥ä½œ

# æµ‹è¯• 3: ä¼šè¯æŒä¹…åŒ–
# è¾“å…¥: /save
# æœŸæœ›ï¼šSession saved
# è¾“å…¥: /sessions
# æœŸæœ›ï¼šæ˜¾ç¤ºä¼šè¯åˆ—è¡¨
```

**Step 1.8: æäº¤**
```bash
git add .
git commit -m "refactor(phase1): extract FileSessionStorage and CLI events from kodax_cli.ts"
```

**âœ… éªŒæ”¶æ ‡å‡†**:
- [ ] `src/interactive/storage.ts` å·²åˆ›å»º
- [ ] `src/ui/cli-events.ts` å·²åˆ›å»º
- [ ] `kodax_cli.ts` è¡Œæ•°å‡å°‘åˆ° < 700 è¡Œ
- [ ] `npm run build` æˆåŠŸ
- [ ] `npm test` é€šè¿‡
- [ ] æ‰‹åŠ¨åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] Git æäº¤å®Œæˆ

**ğŸ”„ å›æ»šæ­¥éª¤**ï¼ˆå¦‚æœå¤±è´¥ï¼‰:
```bash
git checkout .
git checkout main
git branch -D refactor/phase1-split-kodax-cli
```

---

#### Phase 2: åˆ›å»º packages ç›®å½•ç»“æ„

**ç›®æ ‡**: åˆ›å»º monorepo åŸºç¡€ç»“æ„ï¼Œé…ç½®ç‹¬ç«‹çš„ package

**â±ï¸ é¢„ä¼°æ—¶é—´**: 30-45 åˆ†é’Ÿ

**ğŸ“‹ å‰ç½®æ¡ä»¶**:
- [ ] Phase 1 å·²å®Œæˆå¹¶åˆå¹¶åˆ° main
- [ ] `git status` å¹²å‡€
- [ ] `npm run build` æˆåŠŸ

**ğŸ“ è¯¦ç»†æ­¥éª¤**:

**Step 2.1: åˆ›å»ºå¤‡ä»½åˆ†æ”¯**
```bash
git checkout -b refactor/phase2-packages-structure
git push -u origin refactor/phase2-packages-structure
```

**Step 2.2: åˆ›å»ºç›®å½•ç»“æ„**
```bash
mkdir -p packages/core/src
mkdir -p packages/cli/src
mkdir -p packages/repl/src
```

**Step 2.3: åˆ›å»º @kodax/core package.json**

åˆ›å»º `packages/core/package.json`:
```json
{
  "name": "@kodax/core",
  "version": "0.4.0",
  "description": "KodaX Core - ç¯å¢ƒæ— å…³çš„ AI Agent å¼•æ“",
  "type": "module",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch",
    "clean": "rm -rf dist/",
    "test": "vitest run",
    "test:watch": "vitest"
  },
  "dependencies": {
    "@anthropic-ai/sdk": "^0.40.0",
    "openai": "^4.85.0"
  },
  "devDependencies": {
    "@types/node": "^22.13.4",
    "typescript": "^5.7.3",
    "vitest": "^3.2.4"
  },
  "peerDependencies": {
    "@anthropic-ai/sdk": ">=0.40.0",
    "openai": ">=4.0.0"
  },
  "engines": {
    "node": ">=18.0.0"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/icetomoyo/KodaX.git",
    "directory": "packages/core"
  },
  "license": "MIT"
}
```

**Step 2.4: åˆ›å»º @kodax/core tsconfig.json**

åˆ›å»º `packages/core/tsconfig.json`:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "lib": ["ES2022"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "declaration": true,
    "sourceMap": true,
    "resolveJsonModule": true,
    "allowSyntheticDefaultImports": true
  },
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules", "dist"]
}
```

**Step 2.5: åˆ›å»º @kodax/cli package.json**

åˆ›å»º `packages/cli/package.json`:
```json
{
  "name": "@kodax/cli",
  "version": "0.4.0",
  "description": "KodaX CLI - è–„å±‚ CLI å°è£…",
  "type": "module",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "bin": {
    "kodax": "./dist/cli.js"
  },
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch",
    "clean": "rm -rf dist/",
    "test": "vitest run"
  },
  "dependencies": {
    "@kodax/core": "0.4.0",
    "chalk": "^5.4.1",
    "commander": "^13.1.0",
    "glob": "^11.0.1"
  },
  "devDependencies": {
    "@types/node": "^22.13.4",
    "typescript": "^5.7.3",
    "vitest": "^3.2.4"
  },
  "engines": {
    "node": ">=18.0.0"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/icetomoyo/KodaX.git",
    "directory": "packages/cli"
  },
  "license": "MIT"
}
```

**Step 2.6: åˆ›å»º @kodax/cli tsconfig.json**

åˆ›å»º `packages/cli/tsconfig.json`:
```json
{
  "extends": "../core/tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules", "dist"]
}
```

**Step 2.7: åˆ›å»º @kodax/repl package.json**

åˆ›å»º `packages/repl/package.json`:
```json
{
  "name": "@kodax/repl",
  "version": "0.4.0",
  "description": "KodaX REPL - äº¤äº’å¼ç»ˆç«¯ä½“éªŒ",
  "type": "module",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch",
    "clean": "rm -rf dist/",
    "test": "vitest run"
  },
  "dependencies": {
    "@kodax/core": "0.4.0",
    "@kodax/cli": "0.4.0",
    "chalk": "^5.4.1",
    "ink": "^5.0.0",
    "ink-spinner": "^5.0.0",
    "ink-text-input": "^6.0.0",
    "react": "^18.2.0",
    "string-width": "^7.0.0"
  },
  "devDependencies": {
    "@types/node": "^22.13.4",
    "@types/react": "^18.2.0",
    "ink-testing-library": "^4.0.0",
    "typescript": "^5.7.3",
    "vitest": "^3.2.4"
  },
  "peerDependencies": {
    "react": ">=18.0.0"
  },
  "engines": {
    "node": ">=18.0.0"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/icetomoyo/KodaX.git",
    "directory": "packages/repl"
  },
  "license": "MIT"
}
```

**Step 2.8: åˆ›å»º @kodax/repl tsconfig.json**

åˆ›å»º `packages/repl/tsconfig.json`:
```json
{
  "extends": "../core/tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src",
    "jsx": "react-jsx"
  },
  "include": ["src/**/*.ts", "src/**/*.tsx"],
  "exclude": ["node_modules", "dist"]
}
```

**Step 2.9: é…ç½®æ ¹ç›®å½• workspaces**

ä¿®æ”¹æ ¹ç›®å½• `package.json`ï¼Œæ·»åŠ  workspaces é…ç½®ï¼š
```diff
{
  "name": "kodax",
  "version": "0.3.3",
+ "workspaces": [
+   "packages/*"
+ ],
  "scripts": {
+   "build:all": "npm run build -w @kodax/core -w @kodax/cli -w @kodax/repl",
+   "test:all": "npm run test -w @kodax/core -w @kodax/cli -w @kodax/repl",
  }
}
```

**Step 2.10: å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨ workspacesï¼‰**
```bash
# åœ¨æ ¹ç›®å½•ä¸€æ¬¡æ€§å®‰è£…æ‰€æœ‰ä¾èµ–
npm install

# éªŒè¯ workspaces é“¾æ¥
ls node_modules/@kodax/
# æœŸæœ›è¾“å‡º: core  cli  repl (ç¬¦å·é“¾æ¥)
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨ workspaces åï¼Œä¸éœ€è¦åœ¨æ¯ä¸ª package ç›®å½•å•ç‹¬ `npm install`
- npm ä¼šè‡ªåŠ¨åœ¨ `node_modules/@kodax/` åˆ›å»ºç¬¦å·é“¾æ¥
- å†…éƒ¨ä¾èµ–ï¼ˆå¦‚ `@kodax/cli` ä¾èµ– `@kodax/core`ï¼‰ä¼šè‡ªåŠ¨è§£æ

**Step 2.11: éªŒè¯ç›®å½•ç»“æ„**
```bash
# æ£€æŸ¥ç›®å½•ç»“æ„
find packages -type f -name "package.json" | head -5
# æœŸæœ›è¾“å‡ºï¼š
# packages/core/package.json
# packages/cli/package.json
# packages/repl/package.json
```

**Step 2.12: é…ç½® TypeScript Project Referencesï¼ˆæ¨èï¼‰**

åˆ›å»ºæ ¹ç›®å½• `tsconfig.build.json`ï¼š
```json
{
  "references": [
    { "path": "./packages/core" },
    { "path": "./packages/cli" },
    { "path": "./packages/repl" }
  ],
  "files": []
}
```

æ›´æ–°æ¯ä¸ª package çš„ `tsconfig.json`ï¼Œæ·»åŠ  `composite` é…ç½®ï¼š

`packages/core/tsconfig.json`:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "lib": ["ES2022"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "declaration": true,
    "sourceMap": true,
    "resolveJsonModule": true,
    "allowSyntheticDefaultImports": true,
    "composite": true,
    "declarationMap": true
  },
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules", "dist"]
}
```

`packages/cli/tsconfig.json`:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "lib": ["ES2022"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "declaration": true,
    "sourceMap": true,
    "resolveJsonModule": true,
    "allowSyntheticDefaultImports": true,
    "composite": true,
    "declarationMap": true
  },
  "references": [
    { "path": "../core" }
  ],
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules", "dist"]
}
```

`packages/repl/tsconfig.json`:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "lib": ["ES2022"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "declaration": true,
    "sourceMap": true,
    "resolveJsonModule": true,
    "allowSyntheticDefaultImports": true,
    "jsx": "react-jsx",
    "composite": true,
    "declarationMap": true
  },
  "references": [
    { "path": "../core" },
    { "path": "../cli" }
  ],
  "include": ["src/**/*.ts", "src/**/*.tsx"],
  "exclude": ["node_modules", "dist"]
}
```

**Project References çš„å¥½å¤„**ï¼š
- å¢é‡æ„å»ºï¼šåªé‡æ–°ç¼–è¯‘ä¿®æ”¹è¿‡çš„ package
- æ›´å¿«çš„æ„å»ºï¼šTypeScript å¯ä»¥è·³è¿‡æœªæ›´æ”¹çš„ package
- æ›´å¥½çš„ IDE æ”¯æŒï¼šè·¨ package çš„ç±»å‹è·³è½¬

**æ„å»ºå‘½ä»¤æ›´æ–°**ï¼š
```bash
# ä½¿ç”¨ Project References æ„å»ºï¼ˆå¢é‡ã€æ›´å¿«ï¼‰
tsc --build tsconfig.build.json

# å¼ºåˆ¶é‡æ–°æ„å»ºæ‰€æœ‰
tsc --build tsconfig.build.json --force
```

**Step 2.13: æäº¤**
```bash
git add packages/
git commit -m "refactor(phase2): create packages directory structure with package.json and tsconfig.json"
```

**âœ… éªŒæ”¶æ ‡å‡†**:
- [ ] `packages/core/`, `packages/cli/`, `packages/repl/` ç›®å½•å·²åˆ›å»º
- [ ] æ¯ä¸ª package éƒ½æœ‰ `package.json` å’Œ `tsconfig.json`
- [ ] ä¾èµ–å®‰è£…æˆåŠŸï¼ˆæ—  npm é”™è¯¯ï¼‰
- [ ] Git æäº¤å®Œæˆ

**ğŸ”„ å›æ»šæ­¥éª¤**ï¼ˆå¦‚æœå¤±è´¥ï¼‰:
```bash
git checkout .
rm -rf packages/
```

---

#### Phase 3: è¿ç§» Core æ¨¡å—

**ç›®æ ‡**: å°† `src/core/` è¿ç§»åˆ° `packages/core/src/`

**â±ï¸ é¢„ä¼°æ—¶é—´**: 2-3 å°æ—¶

**ğŸ“‹ å‰ç½®æ¡ä»¶**:
- [ ] Phase 2 å·²å®Œæˆ
- [ ] `git status` å¹²å‡€

**ğŸ“ è¯¦ç»†æ­¥éª¤**:

**Step 3.1: åˆ›å»ºå¤‡ä»½åˆ†æ”¯**
```bash
git checkout -b refactor/phase3-migrate-core
```

**Step 3.2: å¤åˆ¶ Core æ–‡ä»¶**
```bash
cp -r src/core/* packages/core/src/
```

**Step 3.3: éªŒè¯æ–‡ä»¶å¤åˆ¶**
```bash
# æ£€æŸ¥æ–‡ä»¶æ•°é‡
find packages/core/src -type f -name "*.ts" | wc -l
# æœŸæœ›ï¼šçº¦ 22 ä¸ªæ–‡ä»¶ï¼ˆä¸ src/core/ ç›¸åŒï¼‰
```

**Step 3.4: æ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆå…³é”®æ­¥éª¤ï¼‰**

ç”±äº `src/core/` ç›´æ¥å¤åˆ¶åˆ° `packages/core/src/`ï¼Œå†…éƒ¨å¯¼å…¥è·¯å¾„**æ— éœ€ä¿®æ”¹**ã€‚

**éªŒè¯å¯¼å…¥è·¯å¾„**ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯çš„å¯¼å…¥è·¯å¾„ï¼ˆæŒ‡å‘ src/coreï¼‰
grep -r "from '\.\./\.\./core" packages/core/src/ || echo "âœ… æ— é”™è¯¯å¯¼å…¥"
grep -r "from '.*kodax_core" packages/core/src/ || echo "âœ… æ— é—ç•™å¯¼å…¥"
```

**Core æ¨¡å—å†…éƒ¨å¯¼å…¥è¯´æ˜**ï¼š
| æ–‡ä»¶ | å¯¼å…¥ç±»å‹ | æ˜¯å¦éœ€è¦ä¿®æ”¹ |
|------|----------|--------------|
| `packages/core/src/index.ts` | `from './types.js'` ç­‰ | âŒ ä¸éœ€è¦ |
| `packages/core/src/agent.ts` | `from './types.js'` ç­‰ | âŒ ä¸éœ€è¦ |
| `packages/core/src/client.ts` | `from './types.js'` ç­‰ | âŒ ä¸éœ€è¦ |
| `packages/core/src/tools/*.ts` | `from '../types.js'` ç­‰ | âŒ ä¸éœ€è¦ |
| `packages/core/src/providers/*.ts` | `from '../types.js'` ç­‰ | âŒ ä¸éœ€è¦ |
| `packages/core/src/prompts/*.ts` | `from '../types.js'` ç­‰ | âŒ ä¸éœ€è¦ |

**Step 3.5: æ„å»ºéªŒè¯**
```bash
cd packages/core
npm run build
# æœŸæœ›ï¼šæ— ç¼–è¯‘é”™è¯¯
```

**Step 3.6: åˆ›å»ºå•å…ƒæµ‹è¯•æ–‡ä»¶**

åˆ›å»º `packages/core/vitest.config.ts`:
```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    include: ['src/**/*.test.ts'],
  },
});
```

**Step 3.7: éªŒè¯ç‹¬ç«‹ä½¿ç”¨**

åˆ›å»ºä¸´æ—¶æµ‹è¯•æ–‡ä»¶ `packages/core/test-standalone.ts`:
```typescript
import { estimateTokens, KODAX_MAX_TOKENS } from './src/index.js';

console.log('KODAX_MAX_TOKENS:', KODAX_MAX_TOKENS);
console.log('estimateTokens("hello"):', estimateTokens('hello'));
console.log('âœ… @kodax/core can be used independently!');
```

è¿è¡Œæµ‹è¯•:
```bash
cd packages/core
npx tsx test-standalone.ts
rm test-standalone.ts
```

**Step 3.8: æäº¤**
```bash
git add packages/core/
git commit -m "refactor(phase3): migrate core module to packages/core"
```

**âœ… éªŒæ”¶æ ‡å‡†**:
- [ ] `packages/core/src/` åŒ…å«æ‰€æœ‰ core æ–‡ä»¶
- [ ] å†…éƒ¨å¯¼å…¥è·¯å¾„å·²æ›´æ–°
- [ ] `npm run build` åœ¨ `packages/core/` æˆåŠŸ
- [ ] ç‹¬ç«‹ä½¿ç”¨éªŒè¯é€šè¿‡
- [ ] Git æäº¤å®Œæˆ

**ğŸ”„ å›æ»šæ­¥éª¤**ï¼ˆå¦‚æœå¤±è´¥ï¼‰:
```bash
git checkout .
rm -rf packages/core/src/
```

---

#### Phase 4: è¿ç§» CLI æ¨¡å—

**ç›®æ ‡**: å°† CLI ç›¸å…³ä»£ç è¿ç§»åˆ° `packages/cli/`

**â±ï¸ é¢„ä¼°æ—¶é—´**: 2-3 å°æ—¶

**ğŸ“‹ å‰ç½®æ¡ä»¶**:
- [ ] Phase 3 å·²å®Œæˆ
- [ ] `packages/core` å¯ç‹¬ç«‹æ„å»º
- [ ] `git status` å¹²å‡€

**ğŸ“ è¯¦ç»†æ­¥éª¤**:

**Step 4.1: åˆ›å»ºå¤‡ä»½åˆ†æ”¯**
```bash
git checkout -b refactor/phase4-migrate-cli
```

**Step 4.2: å¤åˆ¶ CLI å·¥å…·æ–‡ä»¶**
```bash
cp src/cli/utils.ts packages/cli/src/
cp src/cli/plan-mode.ts packages/cli/src/
cp src/cli/plan-storage.ts packages/cli/src/
```

**Step 4.3: æ›´æ–° CLI å·¥å…·å¯¼å…¥**

ä¿®æ”¹ `packages/cli/src/utils.ts`:
```diff
- import { getProvider, KODAX_PROVIDERS } from '../core/index.js';
+ import { getProvider, KODAX_PROVIDERS } from '@kodax/core';
```

**Step 4.4: æå– CLI å…¥å£ä»£ç **

åˆ›å»º `packages/cli/src/cli.ts`ï¼ˆä» `kodax_cli.ts` æå–æ ¸å¿ƒé€»è¾‘ï¼‰:

```typescript
#!/usr/bin/env node
/**
 * @kodax/cli å…¥å£
 */

import { Command } from 'commander';
import { runKodaX, type KodaXOptions, type KodaXResult } from '@kodax/core';
import { getVersion, loadConfig, saveConfig, getProviderList, buildInitPrompt } from './utils.js';

const program = new Command();

// ... Commander é…ç½®ï¼ˆä» kodax_cli.ts æå–ï¼‰

export async function runCLI(argv: string[]): Promise<number> {
  // ... ä¸»å…¥å£é€»è¾‘
  return 0;
}

// ç¨‹åºåŒ–è°ƒç”¨ API
export function createCLI(options: CLIOptions): CLI {
  return {
    run: (argv) => runCLI(argv),
    execute: (prompt) => runKodaX({ provider: options.provider ?? 'anthropic' }, prompt),
  };
}

export interface CLIOptions {
  provider?: string;
  thinking?: boolean;
  auto?: boolean;
}

export interface CLI {
  run(argv: string[]): Promise<number>;
  execute(prompt: string): Promise<KodaXResult>;
}
```

**Step 4.5: åˆ›å»º CLI index.ts**

åˆ›å»º `packages/cli/src/index.ts`:
```typescript
/**
 * @kodax/cli - è–„å±‚ CLI å°è£…
 */

// ä¸»å…¥å£
export { runCLI, createCLI } from './cli.js';
export type { CLIOptions, CLI } from './cli.js';

// å‘½ä»¤ç³»ç»Ÿ
export { loadCommands, parseCommandCall, processCommandCall } from './commands.js';
export type { KodaXCommand, KodaXCommandContext } from './commands.js';

// é…ç½®ç®¡ç†
export { loadConfig, saveConfig, KODAX_CONFIG_FILE } from './utils.js';

// å·¥å…·å‡½æ•°
export {
  getVersion,
  getGitRoot,
  getProviderList,
  buildInitPrompt,
  getFeatureProgress,
  checkAllFeaturesComplete
} from './utils.js';
```

**Step 4.6: æ„å»ºéªŒè¯**
```bash
cd packages/cli
npm run build
# æœŸæœ›ï¼šæ— ç¼–è¯‘é”™è¯¯
```

**Step 4.7: CLI åŠŸèƒ½æµ‹è¯•**
```bash
cd packages/cli
node dist/cli.js --version
# æœŸæœ›ï¼š0.4.0

node dist/cli.js --help
# æœŸæœ›ï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

**Step 4.8: æäº¤**
```bash
git add packages/cli/
git commit -m "refactor(phase4): migrate CLI module to packages/cli"
```

**âœ… éªŒæ”¶æ ‡å‡†**:
- [ ] `packages/cli/src/` åŒ…å« CLI ç›¸å…³æ–‡ä»¶
- [ ] å¯¼å…¥ä½¿ç”¨ `@kodax/core` è€Œéç›¸å¯¹è·¯å¾„
- [ ] `npm run build` åœ¨ `packages/cli/` æˆåŠŸ
- [ ] `node dist/cli.js --version` æ­£å¸¸å·¥ä½œ
- [ ] Git æäº¤å®Œæˆ

**ğŸ”„ å›æ»šæ­¥éª¤**ï¼ˆå¦‚æœå¤±è´¥ï¼‰:
```bash
git checkout .
rm -rf packages/cli/src/
```

---

#### Phase 5: è¿ç§» REPL æ¨¡å—

**ç›®æ ‡**: å°† REPL/äº¤äº’å¼ç›¸å…³ä»£ç è¿ç§»åˆ° `packages/repl/`

**â±ï¸ é¢„ä¼°æ—¶é—´**: 2-3 å°æ—¶

**ğŸ“‹ å‰ç½®æ¡ä»¶**:
- [ ] Phase 4 å·²å®Œæˆ
- [ ] `packages/cli` å¯ç‹¬ç«‹æ„å»º
- [ ] `git status` å¹²å‡€

**ğŸ“ è¯¦ç»†æ­¥éª¤**:

**Step 5.1: åˆ›å»ºå¤‡ä»½åˆ†æ”¯**
```bash
git checkout -b refactor/phase5-migrate-repl
```

**Step 5.2: å¤åˆ¶äº¤äº’å¼æ¨¡å—æ–‡ä»¶**
```bash
# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p packages/repl/src/interactive
mkdir -p packages/repl/src/ui
mkdir -p packages/repl/src/session
mkdir -p packages/repl/src/events

# å¤åˆ¶äº¤äº’å¼æ¨¡å—
cp -r src/interactive/* packages/repl/src/interactive/

# å¤åˆ¶ UI æ¨¡å—
cp -r src/ui/* packages/repl/src/ui/

# å¤åˆ¶ä¼šè¯å­˜å‚¨ï¼ˆä» Phase 1 åˆ›å»ºçš„æ–‡ä»¶ï¼‰
cp src/interactive/storage.ts packages/repl/src/session/storage.ts

# å¤åˆ¶ CLI äº‹ä»¶ï¼ˆä» Phase 1 åˆ›å»ºçš„æ–‡ä»¶ï¼‰
cp src/ui/cli-events.ts packages/repl/src/events/cli-events.ts
```

**Step 5.3: æ›´æ–°å¯¼å…¥è·¯å¾„**

ä¿®æ”¹ `packages/repl/src/interactive/commands.ts`:
```diff
- import { estimateTokens, KODAX_PROVIDERS, getProviderList } from '../core/index.js';
- import { saveConfig } from '../cli/utils.js';
+ import { estimateTokens, KODAX_PROVIDERS, getProviderList, saveConfig } from '@kodax/core';
+ import { saveConfig as saveCliConfig } from '@kodax/cli';
```

ä¿®æ”¹ `packages/repl/src/interactive/context.ts`:
```diff
- import { KodaXMessage } from '../core/index.js';
+ import { KodaXMessage } from '@kodax/core';
```

**Step 5.4: åˆ›å»º REPL å…¥å£**

åˆ›å»º `packages/repl/src/repl.ts`:
```typescript
/**
 * @kodax/repl å…¥å£
 */

import { runKodaX, type KodaXOptions, type KodaXResult, type KodaXSessionStorage } from '@kodax/core';
import { loadConfig, saveConfig } from '@kodax/cli';
import { FileSessionStorage } from './session/storage.js';
import { createCliEvents } from './events/cli-events.js';
import { runInkInteractiveMode } from './ui/app.js';

export interface REPLOptions {
  provider: string;
  thinking?: boolean;
  auto?: boolean;
  maxIter?: number;
  parallel?: boolean;
  mode?: 'code' | 'ask';
  storage?: KodaXSessionStorage;
}

export interface REPL {
  start(): Promise<void>;
  stop(): void;
  send(message: string): Promise<void>;
}

export function createREPL(options: REPLOptions): REPL {
  const storage = options.storage ?? new FileSessionStorage();

  return {
    start: async () => {
      await runInkInteractiveMode({
        ...options,
        storage,
      });
    },
    stop: () => {
      process.exit(0);
    },
    send: async (message: string) => {
      await runKodaX({
        provider: options.provider,
        thinking: options.thinking,
        auto: options.auto,
        session: { storage },
      }, message);
    },
  };
}

export { runInkInteractiveMode } from './ui/app.js';
export { FileSessionStorage } from './session/storage.js';
export { createCliEvents } from './events/cli-events.js';
```

**Step 5.5: åˆ›å»º REPL index.ts**

åˆ›å»º `packages/repl/src/index.ts`:
```typescript
/**
 * @kodax/repl - äº¤äº’å¼ç»ˆç«¯ä½“éªŒ
 */

// ä¸»å…¥å£
export { createREPL, runInkInteractiveMode } from './repl.js';
export type { REPLOptions, REPL } from './repl.js';

// ä¼šè¯å­˜å‚¨
export { FileSessionStorage } from './session/storage.js';

// äº‹ä»¶å¤„ç†å™¨
export { createCliEvents } from './events/cli-events.js';

// äº¤äº’å‘½ä»¤
export { registerInteractiveCommands, handleInteractiveCommand } from './interactive/commands.js';

// UI ç»„ä»¶
export { App } from './ui/app.js';
export { Input } from './ui/components/input.js';
export { Message } from './ui/components/message.js';
export { Status } from './ui/components/status.js';
```

**Step 5.6: æ„å»ºéªŒè¯**
```bash
cd packages/repl
npm run build
# æœŸæœ›ï¼šæ— ç¼–è¯‘é”™è¯¯
```

**Step 5.7: REPL åŠŸèƒ½æµ‹è¯•**
```bash
cd packages/repl
node dist/repl.js
# æœŸæœ›ï¼šè¿›å…¥äº¤äº’æ¨¡å¼

# æµ‹è¯•äº¤äº’å‘½ä»¤
# è¾“å…¥: /status
# æœŸæœ›ï¼šæ˜¾ç¤ºçŠ¶æ€
# è¾“å…¥: /exit
# æœŸæœ›ï¼šæ­£å¸¸é€€å‡º
```

**Step 5.8: æäº¤**
```bash
git add packages/repl/
git commit -m "refactor(phase5): migrate REPL module to packages/repl"
```

**âœ… éªŒæ”¶æ ‡å‡†**:
- [ ] `packages/repl/src/` åŒ…å«æ‰€æœ‰ REPL ç›¸å…³æ–‡ä»¶
- [ ] å¯¼å…¥ä½¿ç”¨ `@kodax/core` å’Œ `@kodax/cli`
- [ ] `npm run build` åœ¨ `packages/repl/` æˆåŠŸ
- [ ] äº¤äº’æ¨¡å¼æ­£å¸¸å¯åŠ¨
- [ ] `/status`, `/exit` å‘½ä»¤æ­£å¸¸å·¥ä½œ
- [ ] Git æäº¤å®Œæˆ

**ğŸ”„ å›æ»šæ­¥éª¤**ï¼ˆå¦‚æœå¤±è´¥ï¼‰:
```bash
git checkout .
rm -rf packages/repl/src/
```

---

#### Phase 6: é›†æˆæµ‹è¯•ä¸å‘å¸ƒ

**ç›®æ ‡**: æ›´æ–°ä¸»é¡¹ç›®ä½¿ç”¨ packagesï¼Œå®Œæˆé›†æˆæµ‹è¯•ï¼Œå‘å¸ƒåˆ° npm

**â±ï¸ é¢„ä¼°æ—¶é—´**: 2-3 å°æ—¶

**ğŸ“‹ å‰ç½®æ¡ä»¶**:
- [ ] Phase 5 å·²å®Œæˆ
- [ ] æ‰€æœ‰ packages å¯ç‹¬ç«‹æ„å»º
- [ ] `git status` å¹²å‡€

**ğŸ“ è¯¦ç»†æ­¥éª¤**:

**Step 6.1: åˆ›å»ºå¤‡ä»½åˆ†æ”¯**
```bash
git checkout -b refactor/phase6-integration-release
```

**Step 6.2: æ›´æ–°ä¸»é¡¹ç›® package.json**

ä¿®æ”¹æ ¹ç›®å½• `package.json`ï¼ˆæ³¨æ„ï¼šworkspaces åœ¨ Phase 2 å·²é…ç½®ï¼‰:

```json
{
  "name": "kodax",
  "version": "0.4.0",
  "description": "æè‡´è½»é‡åŒ– Coding Agent - TypeScript å®ç°ï¼Œæ”¯æŒ7ç§LLMæä¾›å•†",
  "type": "module",
  "main": "packages/core/dist/index.js",
  "types": "packages/core/dist/index.d.ts",
  "bin": {
    "kodax": "./packages/cli/dist/cli.js"
  },
  "exports": {
    ".": {
      "types": "./packages/core/dist/index.d.ts",
      "import": "./packages/core/dist/index.js"
    },
    "./core": {
      "types": "./packages/core/dist/index.d.ts",
      "import": "./packages/core/dist/index.js"
    },
    "./cli": {
      "types": "./packages/cli/dist/index.d.ts",
      "import": "./packages/cli/dist/index.js"
    },
    "./repl": {
      "types": "./packages/repl/dist/index.d.ts",
      "import": "./packages/repl/dist/index.js"
    }
  },
  "workspaces": [
    "packages/*"
  ],
  "scripts": {
    "build": "npm run build:core && npm run build:cli && npm run build:repl",
    "build:core": "npm run build -w @kodax/core",
    "build:cli": "npm run build -w @kodax/cli",
    "build:repl": "npm run build -w @kodax/repl",
    "build:all": "tsc --build tsconfig.build.json",
    "dev": "npm run dev -w @kodax/cli",
    "start": "node packages/cli/dist/cli.js",
    "test": "vitest run",
    "test:core": "npm run test -w @kodax/core",
    "test:cli": "npm run test -w @kodax/cli",
    "test:repl": "npm run test -w @kodax/repl",
    "clean": "npm run clean -ws && rm -rf node_modules"
  },
  "keywords": [
    "ai",
    "coding-agent",
    "llm",
    "anthropic",
    "openai",
    "cli"
  ],
  "author": "",
  "license": "MIT",
  "engines": {
    "node": ">=18.0.0"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/icetomoyo/KodaX.git"
  }
}
```

**å…³é”®å˜æ›´è¯´æ˜**ï¼š
| å­—æ®µ | æ—§å€¼ | æ–°å€¼ | è¯´æ˜ |
|------|------|------|------|
| `main` | `dist/index.js` | `packages/core/dist/index.js` | æŒ‡å‘ core åŒ… |
| `types` | `dist/index.d.ts` | `packages/core/dist/index.d.ts` | æŒ‡å‘ core åŒ… |
| `bin.kodax` | `./dist/kodax_cli.js` | `./packages/cli/dist/cli.js` | æŒ‡å‘ cli åŒ… |
| `exports` | ä»… `.` å’Œ `./core` | æ–°å¢ `./cli` å’Œ `./repl` | æ”¯æŒå­è·¯å¾„å¯¼å…¥ |
| `scripts.build` | `tsc` | åˆ†æ­¥æ„å»º | ä½¿ç”¨ workspaces æ„å»º |
| `scripts.test` | `vitest run` | `vitest run` | ä½¿ç”¨ vitest workspace |

**Step 6.3: å®‰è£… workspace ä¾èµ–**
```bash
npm install
```

**Step 6.4: æ„å»ºæ‰€æœ‰ packages**
```bash
npm run build
# æœŸæœ›ï¼šæ‰€æœ‰ packages æ„å»ºæˆåŠŸ
```

**Step 6.5: è¿è¡Œæ‰€æœ‰æµ‹è¯•**
```bash
npm test
# æœŸæœ›ï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡
```

**Step 6.6: é›†æˆæµ‹è¯• - CLI æ¨¡å¼**
```bash
# æµ‹è¯• print æ¨¡å¼
kodax -p "say hello"
# æœŸæœ›ï¼šæ­£å¸¸è¾“å‡º

# æµ‹è¯•å¸¦å‚æ•°æ¨¡å¼
kodax -p "what is 2+2" --provider openai
# æœŸæœ›ï¼šæ­£å¸¸è¾“å‡ºï¼ˆå¦‚æœ OpenAI é…ç½®ï¼‰

# æµ‹è¯• --init æ¨¡å¼
mkdir /tmp/test-init && cd /tmp/test-init
kodax --init "simple calculator"
# æœŸæœ›ï¼šåˆ›å»º feature_list.json å’Œ PROGRESS.md
```

**Step 6.7: é›†æˆæµ‹è¯• - REPL æ¨¡å¼**
```bash
kodax
# æµ‹è¯• 1: åŸºæœ¬å¯¹è¯
# è¾“å…¥: hello
# æœŸæœ›ï¼šæ­£å¸¸å“åº”

# æµ‹è¯• 2: å‘½ä»¤æµ‹è¯•
# è¾“å…¥: /status
# æœŸæœ›ï¼šæ˜¾ç¤ºçŠ¶æ€
# è¾“å…¥: /model
# æœŸæœ›ï¼šæ˜¾ç¤º provider åˆ—è¡¨
# è¾“å…¥: /thinking on
# æœŸæœ›ï¼šThinking enabled
# è¾“å…¥: /sessions
# æœŸæœ›ï¼šæ˜¾ç¤ºä¼šè¯åˆ—è¡¨
# è¾“å…¥: /exit
# æœŸæœ›ï¼šæ­£å¸¸é€€å‡º
```

**Step 6.8: é›†æˆæµ‹è¯• - ä½œä¸ºåº“ä½¿ç”¨**
```bash
# åˆ›å»ºä¸´æ—¶æµ‹è¯•æ–‡ä»¶
cat > /tmp/test-kodax-core.mjs << 'EOF'
import { runKodaX, estimateTokens, KODAX_MAX_TOKENS } from '@kodax/core';

console.log('Testing @kodax/core as library...');
console.log('KODAX_MAX_TOKENS:', KODAX_MAX_TOKENS);
console.log('estimateTokens("hello world"):', estimateTokens('hello world'));
console.log('âœ… @kodax/core library test passed!');
EOF

cd /tmp
node test-kodax-core.mjs
# æœŸæœ›ï¼šè¾“å‡ºæ­£å¸¸ï¼Œæ— é”™è¯¯
```

**Step 6.9: å‘å¸ƒå‰æ£€æŸ¥**
```bash
# æ£€æŸ¥æ‰€æœ‰ package.json ç‰ˆæœ¬ä¸€è‡´æ€§
grep '"version"' packages/*/package.json
# æœŸæœ›ï¼šæ‰€æœ‰ç‰ˆæœ¬éƒ½æ˜¯ 0.4.0

# æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§
grep '@kodax/core' packages/*/package.json
# æœŸæœ›ï¼šcli å’Œ repl ä¾èµ– @kodax/core: 0.4.0

grep '@kodax/cli' packages/*/package.json
# æœŸæœ›ï¼šrepl ä¾èµ– @kodax/cli: 0.4.0
```

**Step 6.10: å‘å¸ƒåˆ° npm**

```bash
# ç¡®ä¿å·²ç™»å½• npm
npm whoami
# å¦‚æœæœªç™»å½•ï¼šnpm login

# æŒ‰é¡ºåºå‘å¸ƒï¼ˆä¾èµ–é¡ºåºï¼‰
cd packages/core
npm publish --access public
cd ../..

cd packages/cli
npm publish --access public
cd ../..

cd packages/repl
npm publish --access public
cd ../..

# å‘å¸ƒä¸»åŒ…
npm publish --access public
```

**Step 6.11: å‘å¸ƒåéªŒè¯**
```bash
# åœ¨æ–°ç›®å½•æµ‹è¯•
mkdir /tmp/test-kodax && cd /tmp/test-kodax
npm init -y

# æµ‹è¯•å®‰è£… @kodax/core
npm install @kodax/core
node -e "const { estimateTokens } = require('@kodax/core'); console.log(estimateTokens('test'));"
# æœŸæœ›ï¼šæ­£å¸¸è¾“å‡º

# æµ‹è¯•å…¨å±€å®‰è£… kodax
npm install -g kodax@0.4.0
kodax --version
# æœŸæœ›ï¼š0.4.0
```

**Step 6.12: åˆå¹¶åˆ° main å¹¶æ‰“ tag**
```bash
git checkout main
git merge refactor/phase6-integration-release
git tag v0.4.0
git push origin main --tags
```

**Step 6.13: æ¸…ç†é—ç•™ä»£ç ï¼ˆå¯é€‰ï¼‰**
```bash
# åˆ é™¤ä¸å†éœ€è¦çš„ src/ æ–‡ä»¶ï¼ˆå·²è¢« packages æ›¿ä»£ï¼‰
# æ³¨æ„ï¼šæ­¤æ­¥éª¤åº”åœ¨ç¡®è®¤æ‰€æœ‰åŠŸèƒ½æ­£å¸¸åæ‰§è¡Œ
rm -rf src/core/
rm -rf src/cli/
rm -rf src/interactive/
rm -rf src/ui/
rm src/kodax_cli.ts
rm src/kodax_core.ts
rm src/index.ts

# æ›´æ–°æ ¹ç›®å½• tsconfig.json
# åªä¿ç•™ src/kodax.ts ä½œä¸ºå…¥å£ï¼ˆå¦‚æœéœ€è¦ï¼‰
```

**Step 6.14: æœ€ç»ˆæäº¤**
```bash
git add .
git commit -m "release(v0.4.0): complete monorepo refactoring

- @kodax/core: environment-agnostic AI agent engine
- @kodax/cli: thin CLI wrapper with command system
- @kodax/repl: interactive terminal experience

BREAKING CHANGE: package structure changed to monorepo"
git push origin main
```

**âœ… éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰ packages æ„å»ºæˆåŠŸ
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] CLI æ¨¡å¼é›†æˆæµ‹è¯•é€šè¿‡
- [ ] REPL æ¨¡å¼é›†æˆæµ‹è¯•é€šè¿‡
- [ ] ä½œä¸ºåº“ä½¿ç”¨æµ‹è¯•é€šè¿‡
- [ ] npm å‘å¸ƒæˆåŠŸï¼ˆ4 ä¸ªåŒ…ï¼‰
- [ ] å‘å¸ƒåå®‰è£…éªŒè¯é€šè¿‡
- [ ] Git tag v0.4.0 å·²åˆ›å»º
- [ ] GitHub å·²æ¨é€

**ğŸ”„ å›æ»šæ­¥éª¤**ï¼ˆå¦‚æœå‘å¸ƒå¤±è´¥ï¼‰:
```bash
# æ’¤å› npm å‘å¸ƒï¼ˆ24å°æ—¶å†…ï¼‰
npm unpublish @kodax/core@0.4.0
npm unpublish @kodax/cli@0.4.0
npm unpublish @kodax/repl@0.4.0
npm unpublish kodax@0.4.0

# Git å›æ»š
git checkout main
git reset --hard HEAD~1
git tag -d v0.4.0
git push origin main --force
git push origin --delete v0.4.0
```

---

### 7. éªŒæ”¶æ ‡å‡†

#### 7.1 @kodax/core éªŒæ”¶

**ç‹¬ç«‹ä½¿ç”¨éªŒè¯**:
```typescript
import { runKodaX } from '@kodax/core';

const result = await runKodaX(
  {
    provider: 'anthropic',
    maxIter: 50,
    events: {
      onTextDelta: (text) => console.log(text),
      onToolResult: (result) => console.log(`[Result] ${result.content}`),
    }
  },
  "åˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨"
);

console.log(result.success);    // true/false
console.log(result.messages);   // å®Œæ•´å¯¹è¯å†å²
```

**çº¦æŸæ¡ä»¶**:
- [ ] ä¸ä¾èµ– Node.js ç‰¹å®š APIï¼ˆfsã€pathã€child_processï¼‰
- [ ] ä¸ç›´æ¥è¿›è¡Œ I/O æ“ä½œ
- [ ] ä¸ç»´æŠ¤å…¨å±€çŠ¶æ€
- [ ] å¯åœ¨æµè§ˆå™¨/è¾¹ç¼˜è¿è¡Œæ—¶ä½¿ç”¨

#### 7.2 @kodax/cli éªŒæ”¶

**ç¨‹åºåŒ–è°ƒç”¨éªŒè¯**:
```typescript
import { createCLI } from '@kodax/cli';

const cli = createCLI({ provider: 'anthropic' });

// æ–¹å¼ 1: ä¼ å‚è°ƒç”¨
const exitCode = await cli.run(['node', 'kodax', '-p', 'Hello']);
console.log(`Exit code: ${exitCode}`);

// æ–¹å¼ 2: ç›´æ¥æ‰§è¡Œ
const result = await cli.execute('Create a file');
console.log(result.lastText);
```

**çº¦æŸæ¡ä»¶**:
- [ ] å¯ç¨‹åºåŒ–è°ƒç”¨ï¼ˆä¸ä¾èµ– process.exitï¼‰
- [ ] è¿”å›æ ‡å‡† exit code
- [ ] å®Œæ•´çš„ç±»å‹å®šä¹‰

#### 7.3 @kodax/repl éªŒæ”¶

**åµŒå…¥éªŒè¯**:
```typescript
import { createREPL } from '@kodax/repl';

const repl = createREPL({
  provider: 'anthropic',
  thinking: true,
});

// å¯åŠ¨äº¤äº’å¼ä¼šè¯
await repl.start();

// æˆ–å‘é€æ¶ˆæ¯
await repl.send('Hello');
```

**çº¦æŸæ¡ä»¶**:
- [ ] å¯åµŒå…¥å…¶ä»–åº”ç”¨
- [ ] å®Œæ•´çš„ UI ç»„ä»¶å¯¼å‡º
- [ ] ä¼šè¯ç®¡ç†ç‹¬ç«‹

### 8. åŒæ­¥è§£å†³çš„å·²çŸ¥é—®é¢˜

v0.4.0 é‡æ„è¿‡ç¨‹ä¸­å°†åŒæ­¥è§£å†³ä»¥ä¸‹ KNOWN_ISSUESï¼š

#### ISSUE_037: ä¸¤å¥—é”®ç›˜äº‹ä»¶ç³»ç»Ÿå†²çª

**ä¼˜å…ˆçº§**: Medium | **çŠ¶æ€**: å°†åœ¨ v0.4.0 è§£å†³

**é—®é¢˜æè¿°**:
- é¡¹ç›®å­˜åœ¨ä¸¤å¥—é”®ç›˜äº‹ä»¶å¤„ç†ç³»ç»Ÿï¼š
  1. `KeypressContext.tsx` - ä¼˜å…ˆçº§ç³»ç»Ÿï¼Œæ”¯æŒå¤šä¸ªå¤„ç†å™¨
  2. `InputPrompt.tsx` - ç›´æ¥ä½¿ç”¨ Ink çš„ `useInput`
- ä¸¤è€…æ— æ³•åŒæ—¶ä½¿ç”¨ï¼Œå¯¼è‡´ä¼˜å…ˆçº§ç³»ç»Ÿæ— æ³•ç”¨äº REPL

**è§£å†³æ–¹æ¡ˆ** (Phase 5 å®æ–½æ—¶):
1. è¿ç§» `InputPrompt` ä½¿ç”¨ `KeypressContext`
2. æ³¨å†Œè¾“å…¥å¤„ç†å™¨ä¸º `KeypressHandlerPriority.Normal`
3. æ³¨å†Œå…¨å±€å¿«æ·é”®ä¸º `KeypressHandlerPriority.Critical`
4. å…è®¸å»ºè®®å¯¼èˆªæ³¨å†Œä¸º `KeypressHandlerPriority.High`

**ä»£ç ä¿®æ”¹**:

ä¿®æ”¹ `packages/repl/src/ui/components/InputPrompt.tsx`:
```typescript
// æ—§ä»£ç  - ç›´æ¥ä½¿ç”¨ useInput
useInput(handleInput, { isActive: focus });

// æ–°ä»£ç  - ä½¿ç”¨ KeypressContext
import { useKeypressContext, KeypressHandlerPriority } from '../contexts/KeypressContext.js';

const { registerHandler, unregisterHandler } = useKeypressContext();

useEffect(() => {
  if (focus) {
    const handlerId = registerHandler(handleInput, KeypressHandlerPriority.Normal);
    return () => unregisterHandler(handlerId);
  }
}, [focus, handleInput, registerHandler, unregisterHandler]);
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] InputPrompt ä½¿ç”¨ KeypressContext è€Œéç›´æ¥ useInput
- [ ] å…¨å±€å¿«æ·é”®ï¼ˆCtrl+C, Ctrl+Dï¼‰æ­£å¸¸å·¥ä½œ
- [ ] å»ºè®®å¯¼èˆªåŠŸèƒ½æ­£å¸¸ï¼ˆä¸Šä¸‹é”®é€‰æ‹©å»ºè®®ï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–æ–°å®ç°

**Files to Change**: `packages/repl/src/ui/components/InputPrompt.tsx`, `packages/repl/src/ui/contexts/KeypressContext.tsx`

---

#### ISSUE_039: æ­»ä»£ç  printStartupBanner

**ä¼˜å…ˆçº§**: Low | **çŠ¶æ€**: å°†åœ¨ v0.4.0 è§£å†³

**é—®é¢˜æè¿°**:
- `InkREPL.tsx` ä¸­å®šä¹‰äº† `printStartupBanner()` å‡½æ•°ï¼ˆè¡Œ 761-796ï¼‰
- è¯¥å‡½æ•°å·²è¢« `Banner` ç»„ä»¶æ›¿ä»£ï¼Œä½†æœªåˆ é™¤
- ä»£ç æ³¨é‡Šè¡¨æ˜è¿ç§»å·²å®Œæˆ

**è§£å†³æ–¹æ¡ˆ** (Phase 5 å®æ–½æ—¶):
åœ¨è¿ç§» `src/ui/` åˆ° `packages/repl/src/ui/` æ—¶ï¼Œç›´æ¥ä¸å¤åˆ¶è¯¥å‡½æ•°ã€‚

**éªŒæ”¶æ ‡å‡†**:
- [ ] `printStartupBanner()` å‡½æ•°å·²åˆ é™¤
- [ ] Banner ç»„ä»¶æ­£å¸¸æ˜¾ç¤º
- [ ] æ— ç¼–è¯‘é”™è¯¯

**Files to Change**: `packages/repl/src/ui/InkREPL.tsx` (è¿ç§»æ—¶åˆ é™¤è¯¥å‡½æ•°)

---

### 9. æ—¶é—´ä¼°ç®—

| Phase | é¢„ä¼°æ—¶é—´ | ç´¯è®¡ | é£é™©ç­‰çº§ |
|-------|----------|------|----------|
| Phase 0: æ¸…ç†é—ç•™ä»£ç  | 30 åˆ†é’Ÿ | 0.5h | ğŸŸ¢ ä½ |
| Phase 1: æ‹†åˆ† kodax_cli.ts | 1-2 å°æ—¶ | 2.5h | ğŸŸ¡ ä¸­ |
| Phase 2: åˆ›å»ºç›®å½•ç»“æ„ | 30 åˆ†é’Ÿ | 3h | ğŸŸ¢ ä½ |
| Phase 3: è¿ç§» Core | 2-3 å°æ—¶ | 6h | ğŸŸ¡ ä¸­ |
| Phase 4: è¿ç§» CLI | 2-3 å°æ—¶ | 9h | ğŸŸ¡ ä¸­ |
| Phase 5: è¿ç§» REPL + è§£å†³ Issue 037/039 | 2-3 å°æ—¶ | 12h | ğŸŸ¡ ä¸­ |
| Phase 6: é›†æˆæµ‹è¯•ä¸å‘å¸ƒ | 2-3 å°æ—¶ | 15h | ğŸ”´ é«˜ |

**æ€»è®¡**: çº¦ 12-15 å°æ—¶ï¼ˆ2 ä¸ªå·¥ä½œæ—¥ï¼‰

---

## ç‰ˆæœ¬æ€»ç»“

| Feature | Status | ä¼˜å…ˆçº§ |
|---------|--------|--------|
| 005 v0.4.0 æ¶æ„é‡æ„ä¸æ¨¡å—è§£è€¦ | Planned | High |

**è§„åˆ’æ—¥æœŸ**: 2026-02-22
**ä¸»è¦å˜æ›´**: å°† KodaX é‡æ„ä¸ºä¸‰ä¸ªç‹¬ç«‹çš„ npm åŒ…ï¼š@kodax/coreã€@kodax/cliã€@kodax/repl

**åŒæ­¥è§£å†³çš„å·²çŸ¥é—®é¢˜**:
| Issue ID | æ ‡é¢˜ | ä¼˜å…ˆçº§ |
|----------|------|--------|
| 037 | ä¸¤å¥—é”®ç›˜äº‹ä»¶ç³»ç»Ÿå†²çª | Medium |
| 039 | æ­»ä»£ç  printStartupBanner | Low |

## é£é™©åˆ†æ

### æŠ€æœ¯é£é™©
| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| Phase 0 å¯¼å…¥è·¯å¾„é”™è¯¯ | é«˜ | ä½ | é€æ–‡ä»¶ä¿®æ”¹ï¼Œç«‹å³éªŒè¯æ„å»º |
| Phase 1 åŠŸèƒ½å›å½’ | é«˜ | ä¸­ | å®Œæ•´çš„æ‰‹åŠ¨åŠŸèƒ½æµ‹è¯•æ¸…å• |
| å¾ªç¯ä¾èµ– | é«˜ | ä½ | ä¸¥æ ¼æŒ‰ç…§ core â† cli â† repl ä¾èµ–æ–¹å‘ |
| å‘å¸ƒå¤±è´¥ | ä¸­ | ä½ | é¢„å…ˆéªŒè¯ npm è´¦å·å’Œæƒé™ |
| API ä¸å…¼å®¹ | ä¸­ | ä½ | ä¿æŒç°æœ‰ `runKodaX` API ä¸å˜ |

### å›æ»šè®¡åˆ’
| é˜¶æ®µ | å›æ»šæ–¹å¼ |
|------|----------|
| Phase 0-1 | `git checkout .` æ¢å¤æ–‡ä»¶ |
| Phase 2-5 | åˆ é™¤ packages/ ç›®å½• |
| Phase 6 | `npm unpublish` æ’¤å›å‘å¸ƒ |

### ä¾èµ–é£é™©
| ä¾èµ– | é£é™© | ç¼“è§£æªæ–½ |
|------|------|----------|
| @anthropic-ai/sdk | ç‰ˆæœ¬å…¼å®¹ | é”å®šç‰ˆæœ¬å· |
| openai | ç‰ˆæœ¬å…¼å®¹ | é”å®šç‰ˆæœ¬å· |
| ink | React 18 å…¼å®¹ | å·²éªŒè¯å…¼å®¹ |

## é™„å½•

### A. æ–‡ä»¶å˜æ›´æ¸…å•

**Phase 0 å˜æ›´**:
| æ–‡ä»¶ | æ“ä½œ | è¡Œæ•°å˜åŒ– |
|------|------|----------|
| `src/interactive/context.ts` | ä¿®æ”¹å¯¼å…¥ | -1 +1 |
| `src/interactive/commands.ts` | ä¿®æ”¹å¯¼å…¥ | -1 +2 |
| `src/kodax_core.ts` | åˆ é™¤ | -1786 |

**Phase 1 å˜æ›´**:
| æ–‡ä»¶ | æ“ä½œ | è¡Œæ•°å˜åŒ– |
|------|------|----------|
| `src/interactive/storage.ts` | æ–°å»º | +75 |
| `src/ui/cli-events.ts` | æ–°å»º | +135 |
| `src/kodax_cli.ts` | ä¿®æ”¹ | -200 |

### B. æµ‹è¯•æ¸…å•

**Phase 0 åŠŸèƒ½æµ‹è¯•**:
- [ ] `kodax` è¿›å…¥äº¤äº’æ¨¡å¼
- [ ] `/status` æ˜¾ç¤ºçŠ¶æ€
- [ ] `/model` æ˜¾ç¤º provider åˆ—è¡¨
- [ ] `/thinking on` å¯ç”¨ thinking
- [ ] `/exit` é€€å‡º

**Phase 1 åŠŸèƒ½æµ‹è¯•**:
- [ ] `kodax -p "test"` print æ¨¡å¼
- [ ] Spinner åŠ¨ç”»æ­£å¸¸
- [ ] `/save` ä¿å­˜ä¼šè¯
- [ ] `/sessions` æ˜¾ç¤ºä¼šè¯åˆ—è¡¨
- [ ] `/load <id>` åŠ è½½ä¼šè¯

---

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

æ¯ä¸ª package éœ€è¦æœ‰ç‹¬ç«‹çš„å•å…ƒæµ‹è¯•ï¼š

#### æ ¹ç›®å½• vitest workspace é…ç½®

åˆ›å»º `vitest.workspace.ts`ï¼ˆmonorepo ç»Ÿä¸€æµ‹è¯•å…¥å£ï¼‰ï¼š
```typescript
import { defineWorkspace } from 'vitest/config';

export default defineWorkspace([
  'packages/core/vitest.config.ts',
  'packages/cli/vitest.config.ts',
  'packages/repl/vitest.config.ts',
]);
```

è¿™æ ·å¯ä»¥åœ¨æ ¹ç›®å½•è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼š
```bash
# è¿è¡Œæ‰€æœ‰ package çš„æµ‹è¯•
vitest run

# è¿è¡Œç‰¹å®š package çš„æµ‹è¯•
vitest run --project=@kodax/core
```

#### @kodax/core æµ‹è¯•

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•å†…å®¹ | è¦†ç›–ç›®æ ‡ |
|----------|----------|----------|
| `tokenizer.test.ts` | Token ä¼°ç®—å‡½æ•° | 90%+ |
| `messages.test.ts` | æ¶ˆæ¯å‹ç¼©å’Œæ£€æµ‹ | 85%+ |
| `session.test.ts` | ä¼šè¯ ID ç”Ÿæˆ | 90%+ |
| `providers/registry.test.ts` | Provider æ³¨å†Œå’Œè·å– | 85%+ |
| `tools/registry.test.ts` | Tool æ³¨å†Œå’Œæ‰§è¡Œ | 85%+ |

**æµ‹è¯•é…ç½®** `packages/core/vitest.config.ts`:
```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    include: ['src/**/*.test.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: ['node_modules/', 'dist/', '**/*.test.ts'],
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 70,
        statements: 80
      }
    }
  },
});
```

#### @kodax/cli æµ‹è¯•

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•å†…å®¹ | è¦†ç›–ç›®æ ‡ |
|----------|----------|----------|
| `utils.test.ts` | å·¥å…·å‡½æ•° | 85%+ |
| `commands.test.ts` | å‘½ä»¤ç³»ç»Ÿ | 80%+ |
| `config.test.ts` | é…ç½®ç®¡ç† | 85%+ |

#### @kodax/repl æµ‹è¯•

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•å†…å®¹ | è¦†ç›–ç›®æ ‡ |
|----------|----------|----------|
| `storage.test.ts` | æ–‡ä»¶ä¼šè¯å­˜å‚¨ | 85%+ |
| `events.test.ts` | CLI äº‹ä»¶å¤„ç†å™¨ | 75%+ |
| `ui/components/*.test.tsx` | UI ç»„ä»¶ | 70%+ |

### é›†æˆæµ‹è¯•

#### æµ‹è¯•åœºæ™¯ 1: CLI å®Œæ•´æµç¨‹

```typescript
// tests/integration/cli-flow.test.ts
describe('CLI Integration', () => {
  it('should execute print mode successfully', async () => {
    const result = await runCLI(['node', 'kodax', '-p', 'say hello']);
    expect(result).toBe(0);
  });

  it('should handle --init flag', async () => {
    // åˆ›å»ºä¸´æ—¶ç›®å½•
    const tmpDir = await fs.mkdtemp(path.join(os.tmpdir(), 'kodax-test-'));
    process.chdir(tmpDir);

    const result = await runCLI(['node', 'kodax', '--init', 'test project']);

    // éªŒè¯æ–‡ä»¶åˆ›å»º
    expect(fs.existsSync(path.join(tmpDir, 'feature_list.json'))).toBe(true);
    expect(fs.existsSync(path.join(tmpDir, 'PROGRESS.md'))).toBe(true);
  });
});
```

#### æµ‹è¯•åœºæ™¯ 2: ä¼šè¯æŒä¹…åŒ–

```typescript
// tests/integration/session.test.ts
describe('Session Persistence', () => {
  it('should save and load session', async () => {
    const storage = new FileSessionStorage();
    const sessionId = generateSessionId();

    // ä¿å­˜
    await storage.save(sessionId, {
      messages: [{ role: 'user', content: 'test' }],
      title: 'Test Session',
      gitRoot: '/tmp/test',
    });

    // åŠ è½½
    const loaded = await storage.load(sessionId);
    expect(loaded).not.toBeNull();
    expect(loaded?.messages).toHaveLength(1);
    expect(loaded?.title).toBe('Test Session');
  });
});
```

#### æµ‹è¯•åœºæ™¯ 3: å¤š Provider æ”¯æŒ

```typescript
// tests/integration/providers.test.ts
describe('Provider Integration', () => {
  it('should work with anthropic provider', async () => {
    if (!process.env.ANTHROPIC_API_KEY) {
      return; // Skip if not configured
    }

    const result = await runKodaX(
      { provider: 'anthropic', maxIter: 1 },
      'say "test ok"'
    );

    expect(result.success).toBe(true);
    expect(result.lastText).toContain('test ok');
  });

  it('should work with openai provider', async () => {
    if (!process.env.OPENAI_API_KEY) {
      return; // Skip if not configured
    }

    const result = await runKodaX(
      { provider: 'openai', maxIter: 1 },
      'say "test ok"'
    );

    expect(result.success).toBe(true);
  });
});
```

### E2E æµ‹è¯•

#### æµ‹è¯•æ¸…å•

| æµ‹è¯• ID | åœºæ™¯ | æ­¥éª¤ | é¢„æœŸç»“æœ |
|---------|------|------|----------|
| E2E-001 | CLI Print æ¨¡å¼ | `kodax -p "hello"` | è¾“å‡ºåŒ…å« AI å“åº” |
| E2E-002 | CLI --init æ¨¡å¼ | `kodax --init "project"` | åˆ›å»º feature_list.json |
| E2E-003 | CLI --team æ¨¡å¼ | `kodax --team "task"` | å¯åŠ¨å¤š Agent æ¨¡å¼ |
| E2E-004 | REPL å¯åŠ¨ | `kodax` â†’ è¿›å…¥äº¤äº’ | æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯ |
| E2E-005 | REPL å‘½ä»¤ | `/status` | æ˜¾ç¤ºä¼šè¯çŠ¶æ€ |
| E2E-006 | REPL ä¼šè¯ | `/save` â†’ `/sessions` | æ˜¾ç¤ºä¿å­˜çš„ä¼šè¯ |
| E2E-007 | REPL åˆ‡æ¢ Provider | `/model openai` | Provider åˆ‡æ¢æˆåŠŸ |
| E2E-008 | REPL Thinking | `/thinking on` | Thinking æ¨¡å¼å¯ç”¨ |
| E2E-009 | ä½œä¸ºåº“ä½¿ç”¨ | `import { runKodaX }` | å‡½æ•°å¯è°ƒç”¨ |
| E2E-010 | å¤šè½®å¯¹è¯ | å‘é€ 3 æ¡æ¶ˆæ¯ | ä¸Šä¸‹æ–‡ä¿æŒ |

### æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

| Package | è¡Œè¦†ç›–ç‡ | å‡½æ•°è¦†ç›–ç‡ | åˆ†æ”¯è¦†ç›–ç‡ |
|---------|----------|------------|------------|
| @kodax/core | â‰¥80% | â‰¥80% | â‰¥70% |
| @kodax/cli | â‰¥80% | â‰¥80% | â‰¥70% |
| @kodax/repl | â‰¥75% | â‰¥75% | â‰¥65% |
| **æ€»ä½“** | **â‰¥80%** | **â‰¥80%** | **â‰¥70%** |

---

## å‘å¸ƒæµç¨‹

### ç‰ˆæœ¬åŒæ­¥æœºåˆ¶

ç”±äºä½¿ç”¨ç»Ÿä¸€ç‰ˆæœ¬ç­–ç•¥ï¼Œéœ€è¦ç¡®ä¿æ‰€æœ‰ package ç‰ˆæœ¬å·ä¸€è‡´ã€‚

#### æ–¹å¼ 1: npm version --workspacesï¼ˆæ¨èï¼‰

```bash
# åŒæ­¥æ›´æ–°æ‰€æœ‰ package ç‰ˆæœ¬
npm version 0.4.0 --workspaces

# éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
grep '"version"' packages/*/package.json package.json
# æœŸæœ›ï¼šæ‰€æœ‰è¾“å‡ºéƒ½æ˜¯ "version": "0.4.0"
```

#### æ–¹å¼ 2: æ‰‹åŠ¨è„šæœ¬

åˆ›å»º `scripts/sync-versions.js`ï¼š
```javascript
#!/usr/bin/env node
import fs from 'fs';
import path from 'path';

const rootPkg = JSON.parse(fs.readFileSync('package.json'));
const version = rootPkg.version;

const packages = ['core', 'cli', 'repl'];
for (const pkg of packages) {
  const pkgPath = path.join('packages', pkg, 'package.json');
  const pkgJson = JSON.parse(fs.readFileSync(pkgPath));
  pkgJson.version = version;

  // æ›´æ–°å†…éƒ¨ä¾èµ–ç‰ˆæœ¬
  if (pkgJson.dependencies) {
    for (const dep of Object.keys(pkgJson.dependencies)) {
      if (dep.startsWith('@kodax/')) {
        pkgJson.dependencies[dep] = version;
      }
    }
  }

  fs.writeFileSync(pkgPath, JSON.stringify(pkgJson, null, 2) + '\n');
  console.log(`âœ… Synced ${pkg} to version ${version}`);
}
```

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
# 1. å…ˆæ›´æ–°æ ¹ package.json ç‰ˆæœ¬
npm version 0.4.0 --no-git-tag-version

# 2. åŒæ­¥æ‰€æœ‰ package ç‰ˆæœ¬
node scripts/sync-versions.js

# 3. æäº¤ç‰ˆæœ¬æ›´æ–°
git add .
git commit -m "chore: bump version to 0.4.0"
```

#### ç‰ˆæœ¬åŒæ­¥æ£€æŸ¥è„šæœ¬

åˆ›å»º `scripts/check-versions.js`ï¼š
```javascript
#!/usr/bin/env node
import fs from 'fs';

const rootVersion = JSON.parse(fs.readFileSync('package.json')).version;
const packages = ['core', 'cli', 'repl'];

let hasError = false;
for (const pkg of packages) {
  const pkgPath = `packages/${pkg}/package.json`;
  const pkgVersion = JSON.parse(fs.readFileSync(pkgPath)).version;
  if (pkgVersion !== rootVersion) {
    console.error(`âŒ ${pkg}: ${pkgVersion} !== ${rootVersion}`);
    hasError = true;
  } else {
    console.log(`âœ… ${pkg}: ${pkgVersion}`);
  }
}

process.exit(hasError ? 1 : 0);
```

### å‘å¸ƒå‰æ£€æŸ¥æ¸…å•

#### ä»£ç è´¨é‡
- [ ] æ‰€æœ‰ TypeScript ç¼–è¯‘æ— é”™è¯¯
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] E2E æµ‹è¯•é€šè¿‡
- [ ] ä»£ç è¦†ç›–ç‡è¾¾æ ‡ï¼ˆâ‰¥80%ï¼‰
- [ ] æ—  `console.log` è°ƒè¯•ä»£ç æ®‹ç•™
- [ ] æ—  `TODO` æˆ– `FIXME` æ³¨é‡Šï¼ˆæˆ–å·²è®°å½•ï¼‰

#### æ–‡æ¡£
- [ ] README.md å·²æ›´æ–°
- [ ] CHANGELOG.md å·²æ›´æ–°
- [ ] æ¯ä¸ª package çš„ README.md å·²åˆ›å»º
- [ ] API æ–‡æ¡£å·²æ›´æ–°

#### ç‰ˆæœ¬ä¸€è‡´æ€§
- [ ] æ‰€æœ‰ package.json ç‰ˆæœ¬å·ä¸€è‡´
- [ ] package-lock.json å·²æ›´æ–°
- [ ] Git tag ä¸ç‰ˆæœ¬å·åŒ¹é…

#### ä¾èµ–æ£€æŸ¥
- [ ] æ— å®‰å…¨æ¼æ´ï¼ˆ`npm audit`ï¼‰
- [ ] ä¾èµ–ç‰ˆæœ¬é”å®š
- [ ] peerDependencies æ­£ç¡®å£°æ˜

### å‘å¸ƒæ­¥éª¤

#### 1. å‡†å¤‡é˜¶æ®µ
```bash
# ç¡®ä¿åœ¨ main åˆ†æ”¯
git checkout main
git pull origin main

# è¿è¡Œå®Œæ•´æµ‹è¯•
npm run build
npm test

# æ£€æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§
./scripts/check-versions.sh
```

#### 2. ç‰ˆæœ¬æ›´æ–°
```bash
# æ›´æ–°æ‰€æœ‰ package ç‰ˆæœ¬
npm version 0.4.0 --workspaces

# æ›´æ–° CHANGELOG
# æ‰‹åŠ¨ç¼–è¾‘ CHANGELOG.md

# æäº¤ç‰ˆæœ¬æ›´æ–°
git add .
git commit -m "chore: bump version to 0.4.0"
```

#### 3. å‘å¸ƒåˆ° npm
```bash
# ç¡®ä¿å·²ç™»å½•
npm whoami

# æŒ‰ä¾èµ–é¡ºåºå‘å¸ƒ
npm publish --workspace=@kodax/core --access public
npm publish --workspace=@kodax/cli --access public
npm publish --workspace=@kodax/repl --access public
npm publish --access public
```

#### 4. Git æ ‡ç­¾
```bash
git tag -a v0.4.0 -m "Release v0.4.0: Monorepo Architecture"
git push origin main --tags
```

#### 5. GitHub Release
```bash
# ä½¿ç”¨ gh CLI åˆ›å»º release
gh release create v0.4.0 \
  --title "v0.4.0 - Monorepo Architecture" \
  --notes-file CHANGELOG.md
```

### å‘å¸ƒåéªŒè¯

```bash
# éªŒè¯ npm å‘å¸ƒ
npm view @kodax/core@0.4.0
npm view @kodax/cli@0.4.0
npm view @kodax/repl@0.4.0
npm view kodax@0.4.0

# éªŒè¯å®‰è£…
mkdir /tmp/verify-kodax && cd /tmp/verify-kodax
npm init -y
npm install kodax@0.4.0
npx kodax --version
# æœŸæœ›ï¼š0.4.0
```

### å›æ»šæµç¨‹

å¦‚æœå‘å¸ƒåå‘ç°é—®é¢˜ï¼š

#### è½¯å›æ»šï¼ˆå‘å¸ƒ patch ç‰ˆæœ¬ï¼‰
```bash
# ä¿®å¤é—®é¢˜å
npm version patch --workspaces
npm publish --workspace=@kodax/core
npm publish --workspace=@kodax/cli
npm publish --workspace=@kodax/repl
npm publish
```

#### ç¡¬å›æ»šï¼ˆæ’¤å›å‘å¸ƒï¼‰
```bash
# 24 å°æ—¶å†…å¯æ’¤å›
npm unpublish @kodax/core@0.4.0
npm unpublish @kodax/cli@0.4.0
npm unpublish @kodax/repl@0.4.0
npm unpublish kodax@0.4.0

# åˆ é™¤ Git tag
git tag -d v0.4.0
git push origin :refs/tags/v0.4.0

# åˆ é™¤ GitHub release
gh release delete v0.4.0
```

---

## å®‰å…¨æ£€æŸ¥æ¸…å•

### Phase æ‰§è¡Œå‰æ£€æŸ¥

| æ£€æŸ¥é¡¹ | å‘½ä»¤ | é€šè¿‡æ¡ä»¶ |
|--------|------|----------|
| Git çŠ¶æ€å¹²å‡€ | `git status` | æ— æœªæäº¤æ›´æ”¹ |
| æ„å»ºæˆåŠŸ | `npm run build` | é€€å‡ºç  0 |
| æµ‹è¯•é€šè¿‡ | `npm test` | æ‰€æœ‰æµ‹è¯•é€šè¿‡ |
| æ— å®‰å…¨æ¼æ´ | `npm audit` | æ—  high/critical |

### ä»£ç å®‰å…¨æ£€æŸ¥

| æ£€æŸ¥é¡¹ | è¯´æ˜ | éªŒè¯æ–¹æ³• |
|--------|------|----------|
| æ— ç¡¬ç¼–ç å¯†é’¥ | æ£€æŸ¥ API keyã€å¯†ç ç­‰ | `grep -r "api_key\|password\|secret" src/` |
| æ— æ•æ„Ÿæ–‡ä»¶ | .env ç­‰ä¸åº”æäº¤ | `git status` ä¸æ˜¾ç¤º .env |
| ä¾èµ–å®‰å…¨ | æ— å·²çŸ¥æ¼æ´ | `npm audit` |
| è¾“å…¥éªŒè¯ | ç”¨æˆ·è¾“å…¥å·²éªŒè¯ | ä»£ç å®¡æŸ¥ |

### å‘å¸ƒå‰å®‰å…¨æ£€æŸ¥

| æ£€æŸ¥é¡¹ | è¯´æ˜ | éªŒè¯æ–¹æ³• |
|--------|------|----------|
| .npmignore é…ç½® | æ’é™¤æ•æ„Ÿæ–‡ä»¶ | æ£€æŸ¥æ–‡ä»¶å†…å®¹ |
| ä¾èµ–é”å®š | package-lock.json å­˜åœ¨ | æ–‡ä»¶å­˜åœ¨ |
| npm 2FA | å¯ç”¨åŒå› ç´ è®¤è¯ | npm profile get |

---

## æœ€ç»ˆ Review æ£€æŸ¥æ¸…å•

### è®¾è®¡å®Œæ•´æ€§

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| ç›®æ ‡æ˜ç¡® | âœ… | ä¸‰ä¸ªç‹¬ç«‹ package çš„èŒè´£æ¸…æ™° |
| ä¾èµ–å…³ç³»æ¸…æ™° | âœ… | core â† cli â† repl å•å‘ä¾èµ– |
| æ¥å£å®šä¹‰å®Œæ•´ | âœ… | æ¯ä¸ª package çš„å¯¼å‡ºå·²å®šä¹‰ |
| å®ç°æ­¥éª¤è¯¦ç»† | âœ… | Phase 0-6 æ¯æ­¥éƒ½æœ‰è¯¦ç»†è¯´æ˜ |
| é£é™©åˆ†æå®Œæ•´ | âœ… | æŠ€æœ¯é£é™©å’Œç¼“è§£æªæ–½å·²åˆ—å‡º |
| å›æ»šç­–ç•¥æ˜ç¡® | âœ… | æ¯ä¸ª Phase éƒ½æœ‰å›æ»šæ­¥éª¤ |
| workspaces é…ç½® | âœ… | æ ¹ç›®å½• package.json å·²é…ç½® |
| TypeScript References | âœ… | å¢é‡æ„å»ºé…ç½®å·²æ·»åŠ  |
| ç‰ˆæœ¬åŒæ­¥æœºåˆ¶ | âœ… | è„šæœ¬å’Œæ£€æŸ¥æ–¹æ³•å·²å®šä¹‰ |
| FAQ å’Œè¿ç§»æ¸…å• | âœ… | å¸¸è§é—®é¢˜å’Œæ£€æŸ¥é¡¹å·²åˆ—å‡º |

### å®‰å…¨æ€§

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| æ— ç ´åæ€§ API å˜æ›´ | âœ… | `runKodaX` API ä¿æŒå…¼å®¹ |
| æ¸è¿›å¼è¿ç§» | âœ… | æ¯ä¸ª Phase å¯ç‹¬ç«‹éªŒè¯ |
| Git åˆ†æ”¯éš”ç¦» | âœ… | æ¯ä¸ª Phase ä½¿ç”¨ç‹¬ç«‹åˆ†æ”¯ |
| åŠŸèƒ½æµ‹è¯•æ¸…å• | âœ… | æ¯ä¸ª Phase æœ‰éªŒæ”¶æ ‡å‡† |

### å¯æ‰§è¡Œæ€§

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| å‘½ä»¤å¯æ‰§è¡Œ | âœ… | æ‰€æœ‰å‘½ä»¤å·²éªŒè¯è¯­æ³• |
| ä¾èµ–å®‰è£…æ˜ç¡® | âœ… | package.json å·²å®šä¹‰ |
| éªŒè¯æ­¥éª¤æ¸…æ™° | âœ… | æ¯ä¸ª Step æœ‰éªŒè¯å‘½ä»¤ |
| æ—¶é—´ä¼°ç®—åˆç† | âœ… | æ€»è®¡ 12-15 å°æ—¶ |

### æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

| é—®é¢˜ | å½±å“ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| `saveConfig` é‡å¤å®šä¹‰ | ä¸­ | Phase 0 å·²æ˜ç¡®ä½¿ç”¨ `cli/utils.ts` ç‰ˆæœ¬ |
| å¾ªç¯ä¾èµ–é£é™© | é«˜ | ä¸¥æ ¼éµå¾ª core â† cli â† repl ä¾èµ–æ–¹å‘ |
| å‘å¸ƒé¡ºåºé”™è¯¯ | ä¸­ | æŒ‰ä¾èµ–é¡ºåºå‘å¸ƒï¼šcore â†’ cli â†’ repl |
| ç‰ˆæœ¬ä¸ä¸€è‡´ | ä½ | ä½¿ç”¨ `--workspaces` æ ‡å¿—åŒæ­¥ç‰ˆæœ¬ |

### ç¡®è®¤äº‹é¡¹

- [x] æ‰€æœ‰æ–‡ä»¶å¯¼å…¥è·¯å¾„å˜æ›´å·²åˆ—å‡º
- [x] æ¯ä¸ª Phase çš„å‰ç½®æ¡ä»¶å·²å®šä¹‰
- [x] æ¯ä¸ª Phase çš„éªŒæ”¶æ ‡å‡†å·²å®šä¹‰
- [x] å›æ»šæ­¥éª¤å·²å®šä¹‰
- [x] æµ‹è¯•ç­–ç•¥å·²å®šä¹‰
- [x] å‘å¸ƒæµç¨‹å·²å®šä¹‰
- [x] å®‰å…¨æ£€æŸ¥å·²å®šä¹‰

---

## ç»“è®º

**v0.4.0 è®¾è®¡çŠ¶æ€**: âœ… å®Œå¤‡

è¯¥è®¾è®¡æ–‡æ¡£å·²åŒ…å«ï¼š
1. âœ… å®Œæ•´çš„ä»£ç åˆ†æå’Œå½±å“èŒƒå›´
2. âœ… è¯¦ç»†çš„ Phase 0-6 å®ç°æ­¥éª¤
3. âœ… æ¯ä¸ª Phase çš„å‰ç½®æ¡ä»¶ã€è¯¦ç»†æ­¥éª¤ã€éªŒè¯å‘½ä»¤ã€å›æ»šç­–ç•¥
4. âœ… å®Œæ•´çš„æµ‹è¯•ç­–ç•¥ï¼ˆå•å…ƒã€é›†æˆã€E2Eï¼‰
5. âœ… å®Œæ•´çš„å‘å¸ƒæµç¨‹å’Œå®‰å…¨æ£€æŸ¥
6. âœ… é£é™©åˆ†æå’Œç¼“è§£æªæ–½
7. âœ… npm workspaces é…ç½®
8. âœ… TypeScript Project References é…ç½®
9. âœ… ç‰ˆæœ¬åŒæ­¥æœºåˆ¶

**å»ºè®®**: å¯ä»¥æŒ‰ç…§ Phase 0 â†’ Phase 1 çš„é¡ºåºå¼€å§‹å®æ–½ã€‚æ¯ä¸ª Phase å®Œæˆååˆå¹¶åˆ° main åˆ†æ”¯ï¼Œç¡®ä¿æ¸è¿›å¼ã€å®‰å…¨çš„é‡æ„ã€‚

---

## å¸¸è§é—®é¢˜ (FAQ)

### Q1: ä¸ºä»€ä¹ˆè¦ç”¨ monorepo è€Œä¸æ˜¯å¤šä»“åº“ï¼Ÿ

| æ–¹é¢ | Monorepo | å¤šä»“åº“ |
|------|----------|--------|
| ä»£ç å…±äº« | âœ… å®¹æ˜“ | âŒ éœ€è¦ npm å‘å¸ƒ |
| ç‰ˆæœ¬åŒæ­¥ | âœ… ç»Ÿä¸€ | âŒ å„è‡ªç‹¬ç«‹ |
| é‡æ„ | âœ… ä¸€æ¬¡å®Œæˆ | âŒ éœ€è¦åè°ƒå¤šä¸ªä»“åº“ |
| CI/CD | âœ… ç»Ÿä¸€é…ç½® | âŒ å„è‡ªé…ç½® |
| å‘å¸ƒ | âš ï¸ éœ€è¦é¡ºåºå‘å¸ƒ | âœ… ç‹¬ç«‹å‘å¸ƒ |

### Q2: workspaces å’Œ lerna/changesets æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| å·¥å…· | åŠŸèƒ½ | æ˜¯å¦éœ€è¦ |
|------|------|----------|
| npm workspaces | åŸºç¡€ monorepo æ”¯æŒ | âœ… å¿…éœ€ï¼ˆå·²å†…ç½®ï¼‰ |
| lerna | ç‰ˆæœ¬ç®¡ç†ã€å‘å¸ƒè‡ªåŠ¨åŒ– | âš ï¸ å¯é€‰ |
| changesets | å˜æ›´æ—¥å¿—ã€ç‰ˆæœ¬ç®¡ç† | âš ï¸ å¯é€‰ |

**KodaX é€‰æ‹©**ï¼šä»…ä½¿ç”¨ npm workspacesï¼Œä¿æŒç®€å•ã€‚å¦‚æœæœªæ¥éœ€è¦æ›´å¤æ‚çš„å‘å¸ƒæµç¨‹ï¼Œå¯ä»¥è€ƒè™‘æ·»åŠ  changesetsã€‚

### Q3: å¦‚ä½•åœ¨æœ¬åœ°æµ‹è¯•æœªå‘å¸ƒçš„åŒ…ï¼Ÿ

```bash
# æ–¹å¼ 1ï¼šä½¿ç”¨ workspacesï¼ˆæ¨èï¼‰
# åœ¨ KodaX æ ¹ç›®å½•
npm install
npm link -g

# æ–¹å¼ 2ï¼šåœ¨å…¶ä»–é¡¹ç›®ä¸­æµ‹è¯•
cd /path/to/other-project
npm link @kodax/core  # é“¾æ¥åˆ°æœ¬åœ° @kodax/core
```

### Q4: å‘å¸ƒé¡ºåºé”™è¯¯ä¼šæ€æ ·ï¼Ÿ

å¦‚æœå…ˆå‘å¸ƒ `@kodax/cli` ä½† `@kodax/core` è¿˜æ²¡å‘å¸ƒï¼Œnpm ä¼šæŠ¥é”™ï¼š
```
npm ERR! 404 Not Found - GET https://registry.npmjs.org/@kodax/core
```

**è§£å†³æ–¹æ³•**ï¼šä¸¥æ ¼æŒ‰ç…§ `core â†’ cli â†’ repl` é¡ºåºå‘å¸ƒã€‚

### Q5: å¦‚ä½•å›æ»šåˆ°é‡æ„å‰çš„çŠ¶æ€ï¼Ÿ

```bash
# æ‰¾åˆ° Phase 0 ä¹‹å‰çš„ commit
git log --oneline | grep -i "phase0"

# å›æ»šåˆ°è¯¥ commit
git reset --hard <commit-hash>

# å¼ºåˆ¶æ¨é€ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
git push origin main --force
```

### Q6: TypeScript Project References æ˜¯å¿…éœ€çš„å—ï¼Ÿ

**ä¸æ˜¯å¿…éœ€çš„**ï¼Œä½†å¼ºçƒˆæ¨èï¼š
- ä¸ä½¿ç”¨ï¼šæ¯æ¬¡æ„å»ºéƒ½ä¼šé‡æ–°ç¼–è¯‘æ‰€æœ‰æ–‡ä»¶
- ä½¿ç”¨ï¼šå¢é‡æ„å»ºï¼Œåªç¼–è¯‘ä¿®æ”¹è¿‡çš„åŒ…

å¦‚æœä¸æƒ³ä½¿ç”¨ï¼Œå¯ä»¥è·³è¿‡ Step 2.12ï¼Œä½¿ç”¨å„ package ç‹¬ç«‹çš„ `tsc` å‘½ä»¤ã€‚

---

## è¿ç§»æ£€æŸ¥æ¸…å•

### å¼€å§‹è¿ç§»å‰

- [ ] å¤‡ä»½å½“å‰ä»£ç ï¼š`git branch backup-pre-v0.4.0`
- [ ] ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼š`npm test`
- [ ] ç¡®ä¿æ„å»ºæˆåŠŸï¼š`npm run build`
- [ ] ç¡®ä¿æ²¡æœ‰æœªæäº¤çš„æ›´æ”¹ï¼š`git status`
- [ ] é€šçŸ¥å›¢é˜Ÿæˆå‘˜å³å°†è¿›è¡Œå¤§è§„æ¨¡é‡æ„

### Phase 0 å®Œæˆå

- [ ] `kodax_core.ts` å·²åˆ é™¤
- [ ] æ‰€æœ‰å¼•ç”¨å·²è¿ç§»åˆ° `core/index.js`
- [ ] `npm run build` æˆåŠŸ
- [ ] `npm test` é€šè¿‡
- [ ] æ‰‹åŠ¨æµ‹è¯•åŸºæœ¬åŠŸèƒ½

### Phase 1 å®Œæˆå

- [ ] `FileSessionStorage` å·²è¿ç§»åˆ° `interactive/storage.ts`
- [ ] CLI äº‹ä»¶å’Œ Spinner å·²è¿ç§»åˆ° `ui/cli-events.ts`
- [ ] `kodax_cli.ts` è¡Œæ•° < 700
- [ ] æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

### Phase 2 å®Œæˆå

- [ ] `packages/core/`ã€`packages/cli/`ã€`packages/repl/` å·²åˆ›å»º
- [ ] æ¯ä¸ª package éƒ½æœ‰ `package.json` å’Œ `tsconfig.json`
- [ ] workspaces é…ç½®æ­£ç¡®
- [ ] `npm install` æˆåŠŸ

### Phase 3 å®Œæˆå

- [ ] `packages/core/src/` åŒ…å«æ‰€æœ‰ core æ–‡ä»¶
- [ ] `npm run build` åœ¨ `packages/core/` æˆåŠŸ
- [ ] `@kodax/core` å¯ç‹¬ç«‹ä½¿ç”¨

### Phase 4 å®Œæˆå

- [ ] CLI ç›¸å…³ä»£ç å·²è¿ç§»åˆ° `packages/cli/`
- [ ] å¯¼å…¥ä½¿ç”¨ `@kodax/core`
- [ ] `node dist/cli.js --version` æ­£å¸¸

### Phase 5 å®Œæˆå

- [ ] REPL ç›¸å…³ä»£ç å·²è¿ç§»åˆ° `packages/repl/`
- [ ] å¯¼å…¥ä½¿ç”¨ `@kodax/core` å’Œ `@kodax/cli`
- [ ] äº¤äº’æ¨¡å¼æ­£å¸¸å¯åŠ¨

### Phase 6 å®Œæˆå

- [ ] æ ¹ç›®å½• `package.json` å·²æ›´æ–°
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] CLI æ¨¡å¼é›†æˆæµ‹è¯•é€šè¿‡
- [ ] REPL æ¨¡å¼é›†æˆæµ‹è¯•é€šè¿‡
- [ ] ä½œä¸ºåº“ä½¿ç”¨æµ‹è¯•é€šè¿‡
- [ ] npm å‘å¸ƒæˆåŠŸ
- [ ] Git tag å·²åˆ›å»º
- [ ] GitHub Release å·²åˆ›å»º

### å‘å¸ƒå

- [ ] éªŒè¯ npm å®‰è£…ï¼š`npm view @kodax/core@0.4.0`
- [ ] éªŒè¯å…¨å±€å®‰è£…ï¼š`npm install -g kodax@0.4.0 && kodax --version`
- [ ] æ›´æ–°æ–‡æ¡£
- [ ] é€šçŸ¥ç”¨æˆ·æ–°ç‰ˆæœ¬å‘å¸ƒ
