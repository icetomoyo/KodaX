# v0.4.0 Feature Designs

**版本**: v0.4.0
**状态**: Planned
**Feature 数量**: 1

---

## FEATURE_005: v0.4.0 架构重构与模块解耦

**Status**: Planned
**Priority**: High
**Category**: Refactor

### 1. 需求概述

重大架构重构，创建三个高度解耦、可独立使用的模块：`@kodax/core`、`@kodax/cli`、`@kodax/repl`

**Goals**:
1. **@kodax/core**: 纯 AI 引擎，环境无关（Node.js、浏览器、边缘运行时）
2. **@kodax/cli**: 薄层 CLI 封装，带命令注册系统
3. **@kodax/repl**: 完整的交互式终端体验

**Key Changes**:
- 模块间标准化接口
- 事件驱动架构
- Provider 和 Tool 插件系统
- 独立的 npm 包

### 2. 影响范围

**当前问题**:
1. **模块耦合严重**: kodax_core、kodax_cli、repl 之间存在循环依赖
2. **接口不标准**: 各模块之间的数据传递方式不统一
3. **难以独立使用**: 无法将单个模块作为独立库使用
4. **测试困难**: 耦合导致单元测试需要大量 mock

**需要创建的文件结构**:
```
packages/core/
├── src/
│   ├── engine.ts          # KodaXEngine 主类
│   ├── types.ts           # 类型定义
│   ├── events.ts          # 事件系统
│   ├── provider/          # Provider 接口和实现
│   └── tools/             # Tool 接口和注册
└── package.json

packages/cli/
├── src/
│   ├── cli.ts             # CLI 入口
│   ├── command.ts         # 命令接口
│   ├── registry.ts        # 命令注册
│   └── commands/          # 预定义命令
└── package.json

packages/repl/
├── src/
│   ├── repl.ts            # REPL 入口
│   ├── session/           # 会话管理
│   ├── commands/          # REPL 命令
│   └── ui/                # UI 组件
└── package.json
```

### 3. 技术方案

**目标架构**:
```
┌─────────────────────────────────────────────────────────────┐
│                      KodaX v0.4.0                           │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐     │
│  │  @kodax/core │ ← │  @kodax/cli  │ ← │  @kodax/repl │     │
│  │              │   │              │   │              │     │
│  │  核心引擎     │   │  CLI 入口    │   │  交互式终端   │     │
│  │  Provider    │   │  命令解析    │   │  Ink UI      │     │
│  │  Agent       │   │  参数处理    │   │  会话管理    │     │
│  │  Tools       │   │  输出格式    │   │  历史记录    │     │
│  └──────────────┘   └──────────────┘   └──────────────┘     │
│         ↑                  ↑                  ↑              │
│         └──────────────────┴──────────────────┘              │
│                          标准化接口                           │
└─────────────────────────────────────────────────────────────┘
```

**核心原则**:
| 模块 | 设计原则 | 职责边界 |
|------|----------|----------|
| `@kodax/core` | **极简、智能、无副作用** | 只负责 AI 交互，不涉及 I/O |
| `@kodax/cli` | **极简、智能、薄层** | 只负责命令解析和参数处理 |
| `@kodax/repl` | **智能、清晰、高可靠** | 负责交互式体验和状态管理 |

### 4. 接口契约

**@kodax/core 主要导出**:
```typescript
// KodaXEngine - 核心引擎类
export class KodaXEngine {
  constructor(config: KodaXEngineConfig);

  async execute(input: EngineInput): Promise<KodaXResult>;
  async *stream(input: EngineInput): AsyncGenerator<KodaXEvent>;
  subscribe(handler: EventHandler): Unsubscribe;
  registerTool(name: string, tool: Tool): void;
  destroy(): void;
}

// 引擎配置
interface KodaXEngineConfig {
  provider: string | Provider;
  model?: string;
  tools?: Tool[];
  maxIterations?: number;
  systemPrompt?: string | (() => string | Promise<string>);
}
```

**统一事件接口**:
```typescript
interface KodaXEvent {
  type:
    | 'thinking_start' | 'thinking_delta' | 'thinking_end'
    | 'text_start' | 'text_delta' | 'text_end'
    | 'tool_start' | 'tool_input_delta' | 'tool_end' | 'tool_result'
    | 'error' | 'done';
  timestamp: number;
  data: unknown;
}
```

**Provider 接口**:
```typescript
interface Provider {
  readonly name: string;
  readonly models: string[];
  readonly defaultModel: string;
  readonly supportsThinking: boolean;

  stream(request: ProviderRequest): AsyncGenerator<ProviderEvent>;
  complete(request: ProviderRequest): Promise<ProviderResponse>;
}
```

**Tool 接口**:
```typescript
interface Tool {
  name: string;
  description: string;
  inputSchema: JSONSchema;
  execute(input: unknown, context: ToolContext): Promise<ToolResult>;
}
```

### 5. 实现步骤

**Phase 1: 代码审查与依赖分析**
- 生成完整依赖关系图
- 识别循环依赖
- 标记需要解耦的模块
- 确定接口边界

**Phase 2: Core 模块重构**
- 创建 `KodaXEngine` 主类
- 实现标准化事件系统
- 移除所有 Node.js 特定依赖
- 重构 Provider 接口
- 重构 Tool 接口
- 添加完整的单元测试

**Phase 3: CLI 模块重构**
- 实现命令注册系统
- 重构参数解析
- 标准化输出格式
- 实现程序化调用接口
- 添加集成测试

**Phase 4: REPL 模块重构**
- 重构会话管理系统
- 独立化 UI 组件
- 实现上下文管理
- 重构命令系统
- 添加主题支持
- 添加 E2E 测试

**Phase 5: 集成测试与发布**
- 编写跨包集成测试
- 验证独立使用能力
- 编写使用文档
- 发布到 npm
- 更新主项目依赖

### 6. 验收标准

**@kodax/core 独立使用验证**:
```typescript
import { KodaXEngine } from '@kodax/core';
const engine = new KodaXEngine({
  provider: 'anthropic',
  model: 'claude-sonnet-4-20250514'
});
const result = await engine.execute({
  messages: [{ role: 'user', content: 'Hello!' }]
});
```

**@kodax/cli 程序化调用验证**:
```typescript
import { createCLI } from '@kodax/cli';
const cli = createCLI({ provider: 'anthropic' });
const exitCode = await cli.run(['node', 'kodax', 'run', 'Hello']);
```

**@kodax/repl 嵌入验证**:
```typescript
import { createREPL } from '@kodax/repl';
const repl = createREPL({ provider: 'anthropic' });
await repl.start();
```

**约束条件验证**:
- [ ] @kodax/core 不依赖 Node.js 特定 API（如 fs、path）
- [ ] @kodax/core 不直接进行 I/O 操作
- [ ] @kodax/core 不维护全局状态
- [ ] @kodax/cli 可程序化调用（不依赖 process.exit）
- [ ] 所有包有完整的类型定义

---

## 版本总结

| Feature | Status | 优先级 |
|---------|--------|--------|
| 005 v0.4.0 架构重构与模块解耦 | Planned | High |

**规划日期**: 2026-02-20
**主要变更**: 将 KodaX 重构为三个独立的 npm 包：@kodax/core、@kodax/cli、@kodax/repl

## 风险分析

### 技术风险
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 破坏现有功能 | 高 | 完整的测试覆盖，渐进式重构 |
| 性能下降 | 中 | 性能基准测试，优化关键路径 |
| API 不兼容 | 中 | 版本化 API，提供迁移指南 |
| 依赖冲突 | 低 | 严格的依赖管理，peer dependencies |

### 时间风险
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 评估不足 | 高 | Phase 1 预留缓冲时间 |
| 阻塞问题 | 中 | 每日进度检查，及时调整 |
| 文档滞后 | 低 | 代码与文档同步更新 |
