# v0.3.1 Feature Designs

**版本**: v0.3.1
**状态**: Released
**Feature 数量**: 3

---

## FEATURE_001: Plan Mode

**Status**: Completed
**Priority**: High
**Category**: New

### 1. 需求概述

执行前计划系统，支持多步骤计划生成、存储、展示和执行。

**核心功能**:
- 通过 LLM 在代码变更前生成计划
- 计划持久化存储在 `.kodax/plans/` 目录
- 分步展示计划执行进度
- 每步执行需要用户确认
- 支持 `/plan on|off|once` 命令

### 2. 影响范围

**需要创建的文件**:
- src/cli/plan-storage.ts - 计划存储管理
- src/cli/plan-mode.ts - Plan Mode 主逻辑

**需要修改的文件**:
- src/kodax_core.ts - 添加 `beforeToolExecute` 钩子
- src/interactive/commands.ts - 添加 `/plan` 命令

**相关现有文件**（参考模式）:
- src/interactive/repl.ts - REPL 命令集成

### 3. 技术方案

**设计原则**:
- Core 层极简，CLI 层实现全部复杂逻辑
- 文本计划格式（不依赖 JSON 结构化，避免解析失败）
- 支持中断恢复

**架构**:
```
┌─────────────────────────────────────────────────────────┐
│                      分层架构                            │
├─────────────────────────────────────────────────────────┤
│   CLI 层（复杂交互）                                      │
│   ├── 计划生成（特殊提示词）                               │
│   ├── 计划存储（文件系统）                                │
│   ├── 计划展示（文本表格）                                │
│   └── 步骤确认（用户交互）                                │
│              │                                          │
│              ▼                                          │
│   Core 层（极简 - 仅 1 个钩子）                           │
│   └── beforeToolExecute: 执行前确认                      │
└─────────────────────────────────────────────────────────┘
```

**Core 层改动**:
```typescript
// KodaXToolExecutionContext 新增钩子
beforeToolExecute?: (tool: string, input: Record<string, unknown>) => Promise<boolean>;
```

### 4. 接口契约

**数据模型**:
```typescript
interface ExecutionPlan {
  id: string;
  title: string;
  originalPrompt: string;
  steps: {
    id: string;
    description: string;
    tool?: string;
    input?: Record<string, unknown>;
    status: 'pending' | 'done' | 'skipped' | 'failed';
    executedAt?: Date;
  }[];
  createdAt: Date;
  updatedAt: Date;
}
```

**REPL 命令**:
- `/plan on` - 启用 Plan Mode
- `/plan off` - 禁用 Plan Mode
- `/plan once <request>` - 单次 Plan Mode
- `/plan list` - 列出所有计划
- `/plan resume <id>` - 恢复指定计划
- `/plan clear` - 清除已完成计划

### 5. 实现步骤

1. **Core 层钩子** → `src/kodax_core.ts`
2. **计划存储类** → `src/cli/plan-storage.ts`
3. **Plan Mode 主逻辑** → `src/cli/plan-mode.ts`
4. **REPL 命令集成** → `src/interactive/commands.ts`

### 6. 验收标准

- [x] `/plan once` 能生成计划并展示
- [x] 计划可以逐步确认执行
- [x] 中断后可以通过 `/plan resume` 恢复
- [x] 计划持久化到 `.kodax/plans/` 目录

---

## FEATURE_002: 强化 Ask 模式

**Status**: Completed
**Priority**: High
**Category**: Enhancement

### 1. 需求概述

只读模式强制执行，在 Ask 模式下阻止文件修改操作。

**核心功能**:
- 在 Ask 模式下阻止 write、edit、bash 工具
- 使用 `beforeToolExecute` hook 实现
- 操作被阻止时提供清晰的错误信息
- 从系统提示自动检测模式

### 2. 影响范围

**需要修改的文件**:
- src/kodax_core.ts - 添加 mode 类型定义和工具执行检查
- src/kodax_cli.ts - 传递 mode 参数
- src/interactive/*.ts - 同步 mode 状态

### 3. 技术方案

**组合方案**:
1. 在系统提示中告知 AI 当前模式及可用工具
2. 在工具执行层强制执行权限检查（双重保险）

**架构**:
```
┌─────────────────────────────────────────────────────────────┐
│                        KodaXOptions                          │
│                    (新增 mode 字段)                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
         ┌─────────────┴─────────────┐
         │                           │
         ▼                           ▼
┌─────────────────┐        ┌─────────────────┐
│  buildSystemPrompt│        │ executeTool     │
│  (告知AI可用工具) │        │ (强制执行权限)   │
└─────────────────┘        └─────────────────┘
```

### 4. 接口契约

**类型定义**:
```typescript
type KodaXInteractionMode = 'code' | 'ask';

interface KodaXOptions {
  // ...
  mode?: KodaXInteractionMode;  // 默认 'code'
}
```

**Ask 模式可用工具**:
- read: 读取文件
- glob: 文件模式搜索
- grep: 正则表达式搜索
- undo: 撤销操作

### 5. 实现步骤

1. **添加 mode 类型** → `src/kodax_core.ts`
2. **工具层强制执行** → `executeTool` 函数
3. **系统提示增强** → `buildSystemPrompt` 函数
4. **CLI 层传递 mode** → `src/kodax_cli.ts`
5. **REPL 层同步 mode** → `src/interactive/*.ts`

### 6. 验收标准

- [x] `/mode ask` 后，AI 调用 `write` 返回错误提示
- [x] `/mode ask` 后，系统提示中包含可用工具列表
- [x] `/mode code` 后，所有工具恢复正常使用
- [x] 切换模式后，当前会话上下文保持

---

## FEATURE_003: 交互式项目模式

**Status**: Completed
**Priority**: High
**Category**: New

### 1. 需求概述

REPL 中的长运行项目管理，通过 `/project` 命令组实现。

**核心功能**:
- `/project init` - 初始化新项目并设定目标
- `/project status` - 显示当前项目状态和进度
- `/project goals` - 管理项目目标
- `/project cancel` - 取消当前项目
- 项目状态跨会话持久化
- 与 auto-continue 模式集成

### 2. 影响范围

**需要创建的文件**:
- src/interactive/project-state.ts - 状态接口定义
- src/interactive/project-storage.ts - 存储管理类
- src/interactive/project-commands.ts - 命令处理器

**需要修改的文件**:
- src/interactive/commands.ts - 添加 `/project` 命令
- src/interactive/repl.ts - 启动检测项目

### 3. 技术方案

**设计原则**:
- 与 CLI 共享状态：复用 `feature_list.json` 和 `PROGRESS.md`
- 细粒度控制：提供更灵活的人机协作体验
- 渐进增强：不修改 Core 层，仅在 CLI 层实现

**架构**:
```
┌─────────────────────────────────────────────────────────────┐
│                     交互式 REPL 层                           │
│  ├── commands.ts (/project 命令注册)                         │
│  ├── project-commands.ts (命令处理器)                        │
│  ├── project-storage.ts (存储管理)                           │
│  └── project-state.ts (状态接口)                             │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                     共享项目状态                             │
│  ├── feature_list.json  (功能列表)                          │
│  ├── PROGRESS.md        (进度日志)                          │
│  └── .kodax/            (会话计划)                          │
└─────────────────────────────────────────────────────────────┘
```

### 4. 接口契约

**数据模型**:
```typescript
interface ProjectState {
  taskId: string;
  initializedAt: string;
  lastUpdated: string;
  totalFeatures: number;
  completedFeatures: number;
  pendingFeatures: number;
  skippedFeatures: number;
  currentFeatureIndex?: number;
  autoContinue: boolean;
}
```

**REPL 命令**:
- `/project init <task>` - 初始化项目
- `/project status` - 显示状态
- `/project next [--no-confirm]` - 执行下一个功能
- `/project auto [--confirm] [--max=N]` - 自动执行
- `/project pause` - 暂停自动继续
- `/project list` - 列出所有功能
- `/project mark <n> [done|skip]` - 标记功能状态

### 5. 实现步骤

1. **状态接口定义** → `src/interactive/project-state.ts`
2. **存储管理类** → `src/interactive/project-storage.ts`
3. **命令处理器** → `src/interactive/project-commands.ts`
4. **REPL 命令注册** → `src/interactive/commands.ts`

### 6. 验收标准

- [x] `/project init` 能初始化项目并生成 feature_list.json
- [x] `/project status` 显示当前项目进度
- [x] `/project next` 能执行下一个功能并更新状态
- [x] 项目状态跨会话持久化

---

## 版本总结

| Feature | Status | 优先级 |
|---------|--------|--------|
| 001 Plan Mode | Completed | High |
| 002 强化 Ask 模式 | Completed | High |
| 003 交互式项目模式 | Completed | High |

**发布日期**: 2026-02-19
**主要变更**: 添加 Plan Mode、强化 Ask 模式强制执行、交互式项目模式
