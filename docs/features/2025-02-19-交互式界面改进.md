# äº¤äº’å¼ UI æ”¹è¿›è®¾è®¡æ–‡æ¡£ v2

> **çŠ¶æ€**: ğŸ”´ Phase 6 è§„åˆ’ä¸­ | **æ›´æ–°æ—¥æœŸ**: 2026-02-20
>
> **æŠ€æœ¯æ ˆ**: React + Ink (React for CLI) - ä¸ Claude Code / Gemini CLI ä¸€è‡´
>
> **å‚è€ƒå®ç°**: [Gemini CLI](https://github.com/google-gemini/gemini-cli)
>
> **æœ€æ–°åˆ†æ**: è¯¦è§ Section 10-12 (KodaX vs Gemini CLI å·®è·åˆ†æ)

---

## 1. èƒŒæ™¯ä¸åŠ¨æœº

### 1.1 ä¸ºä»€ä¹ˆé€‰æ‹© Ink æ¡†æ¶

ç»è¿‡å¯¹ Claude Codeã€Gemini CLI ç­‰ CLI å·¥å…·çš„æ·±å…¥ç ”ç©¶ï¼Œå‘ç°å®ƒä»¬éƒ½é‡‡ç”¨ **Ink æ¡†æ¶**ï¼ˆReact for CLIï¼‰æ„å»ºäº¤äº’å¼ç•Œé¢ï¼š

| å·¥å…· | æŠ€æœ¯æ ˆ | å‚è€ƒä»·å€¼ |
|------|--------|----------|
| **Claude Code** | Ink + React | å¤šè¡Œè¾“å…¥ã€å·¥å…·æ‰§è¡Œå¯è§†åŒ– |
| **Gemini CLI** | Ink + React | TextBuffer å®ç°ã€å®Œæ•´ç»„ä»¶åº“ |
| **OpenCode** | Go + Bubble Tea | Vim æ¨¡å¼ã€å¤šé¢æ¿å¸ƒå±€ |

**Ink çš„ä¼˜åŠ¿**ï¼š
1. **å£°æ˜å¼ UI** - ä½¿ç”¨ React ç»„ä»¶æ¨¡å¼ï¼Œä»£ç æ›´æ¸…æ™°
2. **æˆç†Ÿçš„ç”Ÿæ€ç³»ç»Ÿ** - ink-text-inputã€ink-spinner ç­‰ç°æˆç»„ä»¶
3. **Flexbox å¸ƒå±€** - ä½¿ç”¨ Yoga å¸ƒå±€å¼•æ“ï¼Œå“åº”å¼è®¾è®¡
4. **è‰¯å¥½çš„ç»ˆç«¯å…¼å®¹æ€§** - è‡ªåŠ¨å¤„ç† ANSI è½¬ä¹‰åºåˆ—
5. **å‚è€ƒä»£ç ä¸°å¯Œ** - å¯ç›´æ¥å‚è€ƒ Gemini CLI çš„å®ç°

### 1.2 å½“å‰é—®é¢˜

KodaX ç°æœ‰ REPL ä½¿ç”¨ Node.js `readline` æ¨¡å—ï¼š

```
é—®é¢˜ï¼š
â”œâ”€â”€ æ¯è¡Œå•ç‹¬æäº¤ï¼Œæ— æ³•åœ¨è¡Œé—´ç§»åŠ¨å…‰æ ‡
â”œâ”€â”€ ä¸æ”¯æŒ raw mode è¾“å…¥å¤„ç†
â”œâ”€â”€ ç¼ºä¹ç»„ä»¶åŒ–æ¶æ„
â””â”€â”€ éš¾ä»¥å®ç°å¤æ‚çš„äº¤äº’åŠŸèƒ½
```

### 1.3 ç›®æ ‡ä½“éªŒ

ç”¨æˆ·åº”è¯¥èƒ½å¤Ÿï¼š
1. **å¤šè¡Œç¼–è¾‘** - ä½¿ç”¨ `â†‘/â†“` åœ¨è¡Œé—´ç§»åŠ¨å…‰æ ‡ï¼Œ`Enter` æäº¤ï¼Œ`\` + `Enter` æ¢è¡Œ
2. **å®æ—¶è¡¥å…¨** - `@` æ–‡ä»¶è¡¥å…¨ã€`/` å‘½ä»¤è¡¥å…¨
3. **çŠ¶æ€å¯è§†åŒ–** - åº•éƒ¨çŠ¶æ€æ æ˜¾ç¤ºä¼šè¯ä¿¡æ¯
4. **æµç•…æ¸²æŸ“** - æµå¼ Markdownã€ä»£ç é«˜äº®

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        KodaX CLI App                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  App.tsx (Ink æ ¹ç»„ä»¶)                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ <MainContent> - æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“                          â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ <InputPrompt> - å¤šè¡Œè¾“å…¥æ¡†                            â”‚  â”‚
â”‚  â”‚  â””â”€â”€ <StatusBar> - åº•éƒ¨çŠ¶æ€æ                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Core Hooks                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ useTextBuffer - æ–‡æœ¬ç¼“å†²åŒºç®¡ç†                        â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ useKeypress - é”®ç›˜äº‹ä»¶å¤„ç†                            â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ useInputHistory - è¾“å…¥å†å²                            â”‚  â”‚
â”‚  â”‚  â””â”€â”€ useCompletion - è‡ªåŠ¨è¡¥å…¨                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Utilities                                                 â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ text-buffer.ts - TextBuffer ç±»                       â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ paste-detector.ts - ç²˜è´´æ£€æµ‹                         â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ text-utils.ts - Unicode å®‰å…¨æ“ä½œ                     â”‚  â”‚
â”‚  â”‚  â””â”€â”€ key-matcher.ts - å¿«æ·é”®åŒ¹é…                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ ui/                          # Ink UI ç»„ä»¶
â”‚   â”œâ”€â”€ App.tsx                  # æ ¹ç»„ä»¶
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ InputPrompt.tsx      # è¾“å…¥æ¡†ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ TextInput.tsx        # åº•å±‚æ–‡æœ¬è¾“å…¥
â”‚   â”‚   â”œâ”€â”€ MessageList.tsx      # æ¶ˆæ¯åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ StatusBar.tsx        # çŠ¶æ€æ 
â”‚   â”‚   â”œâ”€â”€ SuggestionsDisplay.tsx # è¡¥å…¨å»ºè®®
â”‚   â”‚   â””â”€â”€ MarkdownRenderer.tsx # Markdown æ¸²æŸ“
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useTextBuffer.ts     # TextBuffer Hook
â”‚   â”‚   â”œâ”€â”€ useKeypress.ts       # é”®ç›˜äº‹ä»¶
â”‚   â”‚   â”œâ”€â”€ useInputHistory.ts   # è¾“å…¥å†å²
â”‚   â”‚   â””â”€â”€ useCompletion.ts     # è‡ªåŠ¨è¡¥å…¨
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ text-buffer.ts       # TextBuffer ç±»
â”‚   â”‚   â”œâ”€â”€ paste-detector.ts    # ç²˜è´´æ£€æµ‹
â”‚   â”‚   â”œâ”€â”€ text-utils.ts        # Unicode å·¥å…·
â”‚   â”‚   â””â”€â”€ key-matcher.ts       # å¿«æ·é”®åŒ¹é…
â”‚   â”œâ”€â”€ themes/
â”‚   â”‚   â”œâ”€â”€ index.ts             # ä¸»é¢˜å¯¼å‡º
â”‚   â”‚   â””â”€â”€ dark.ts              # é»˜è®¤æš—è‰²ä¸»é¢˜
â”‚   â””â”€â”€ types.ts                 # ç±»å‹å®šä¹‰
â””â”€â”€ interactive/
    â””â”€â”€ repl.ts                  # REPL å…¥å£ï¼ˆé€‚é…å±‚ï¼‰
```

---

## 3. æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 3.1 TextBuffer - æ–‡æœ¬ç¼“å†²åŒº

å‚è€ƒ Gemini CLI çš„ `text-buffer.ts` å®ç°ï¼š

```typescript
// src/ui/utils/text-buffer.ts

export interface CursorPosition {
  row: number;  // é€»è¾‘è¡Œå· (0-based)
  col: number;  // åˆ—ä½ç½® (code point index)
}

export class TextBuffer {
  private _text: string = '';
  private _lines: string[] = [''];
  private _cursor: CursorPosition = { row: 0, col: 0 };
  private _rememberedCol: number = 0;  // ä¸Šä¸‹ç§»åŠ¨æ—¶è®°ä½çš„åˆ—

  // === Getters ===
  get text(): string { return this._text; }
  get lines(): string[] { return [...this._lines]; }
  get cursor(): CursorPosition { return { ...this._cursor }; }
  get lineCount(): number { return this._lines.length; }

  // === æ–‡æœ¬æ“ä½œ ===
  setText(text: string): void;
  insert(text: string, options?: { paste?: boolean }): void;
  newline(): void;
  backspace(): void;

  // === å…‰æ ‡ç§»åŠ¨ ===
  move(direction: 'up' | 'down' | 'left' | 'right' | 'home' | 'end'): void;

  // === è¡Œæ“ä½œ ===
  killLineRight(): void;  // Ctrl+K
  killLineLeft(): void;   // Ctrl+U
  deleteWordLeft(): void; // Ctrl+W
}
```

### 3.2 useTextBuffer Hook

```typescript
// src/ui/hooks/useTextBuffer.ts

export interface UseTextBufferReturn {
  buffer: TextBuffer;
  text: string;
  cursor: CursorPosition;
  setText: (text: string) => void;
  insert: (text: string, options?: { paste?: boolean }) => void;
  newline: () => void;
  backspace: () => void;
  move: (direction: string) => void;
  handleInput: (key: KeyInfo) => boolean;
}

export function useTextBuffer(onSubmit: (text: string) => void): UseTextBufferReturn;
```

### 3.3 InputPrompt ç»„ä»¶

```typescript
// src/ui/components/InputPrompt.tsx

export interface InputPromptProps {
  onSubmit: (text: string) => void;
  placeholder?: string;
  prompt?: string;
  focus?: boolean;
}

export const InputPrompt: React.FC<InputPromptProps>;
```

### 3.4 App æ ¹ç»„ä»¶

```typescript
// src/ui/App.tsx

export interface AppProps {
  model: string;
  provider: string;
  onSubmit: (input: string) => Promise<void>;
}

export const App: React.FC<AppProps>;
```

---

## 4. å¿«æ·é”®è®¾è®¡

| å¿«æ·é”® | åŠŸèƒ½ | ä¸Šä¸‹æ–‡ |
|--------|------|--------|
| `â†‘` | ä¸Šç§»ä¸€è¡Œ / å†å²ä¸Šä¸€æ¡ | å¤šè¡Œæ—¶ç§»åŠ¨å…‰æ ‡ï¼Œç¬¬ä¸€è¡Œæ—¶æŸ¥çœ‹å†å² |
| `â†“` | ä¸‹ç§»ä¸€è¡Œ / å†å²ä¸‹ä¸€æ¡ | å¤šè¡Œæ—¶ç§»åŠ¨å…‰æ ‡ï¼Œæœ€åä¸€è¡Œæ—¶æŸ¥çœ‹å†å² |
| `â†` | å·¦ç§»ä¸€å­—ç¬¦ | - |
| `â†’` | å³ç§»ä¸€å­—ç¬¦ | - |
| `Enter` | æäº¤ | å¦‚æœè¡Œå°¾æ˜¯ `\` åˆ™æ¢è¡Œ |
| `Shift+Enter` | æ¢è¡Œ | å§‹ç»ˆæ¢è¡Œ |
| `Ctrl+A` | ç§»åˆ°è¡Œé¦– | - |
| `Ctrl+E` | ç§»åˆ°è¡Œå°¾ | - |
| `Ctrl+K` | åˆ é™¤åˆ°è¡Œå°¾ | - |
| `Ctrl+U` | åˆ é™¤åˆ°è¡Œé¦– | - |
| `Ctrl+W` | åˆ é™¤å‰ä¸€è¯ | - |
| `Ctrl+C` | æ¸…ç©º/é€€å‡º | æœ‰å†…å®¹æ—¶æ¸…ç©ºï¼Œæ— å†…å®¹æ—¶é€€å‡º |

---

## 5. ä¾èµ–é¡¹

```json
{
  "dependencies": {
    "ink": "^5.0.0",
    "react": "^18.2.0",
    "ink-text-input": "^6.0.0",
    "ink-spinner": "^5.0.0",
    "string-width": "^7.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.0"
  }
}
```

---

## 6. å®ç°è®¡åˆ’

### Phase 1: åŸºç¡€æ¶æ„ âœ… å·²å®Œæˆ
- [x] æ·»åŠ  inkã€react ä¾èµ–
- [x] å®ç° TextBuffer ç±» (`src/ui/utils/text-buffer.ts`)
- [x] å®ç° useTextBuffer Hook (`src/ui/hooks/useTextBuffer.ts`)
- [x] å®ç° useKeypress Hook (`src/ui/hooks/useKeypress.ts`)

### Phase 2: æ ¸å¿ƒç»„ä»¶ âœ… å·²å®Œæˆ
- [x] TextInput ç»„ä»¶ (`src/ui/components/TextInput.tsx`)
- [x] InputPrompt ç»„ä»¶ (`src/ui/components/InputPrompt.tsx`)
- [x] useInputHistory Hook (`src/ui/hooks/useInputHistory.ts`)
- [x] App æ ¹ç»„ä»¶ (`src/ui/App.tsx`)

### Phase 3: å¢å¼ºåŠŸèƒ½ âœ… å·²å®Œæˆ
- [x] StatusBar ç»„ä»¶ (`src/ui/components/StatusBar.tsx`)
- [x] MessageList ç»„ä»¶ (`src/ui/components/MessageList.tsx`)
- [ ] useCompletion Hook (å¾…å®ç°)
- [x] ç²˜è´´æ£€æµ‹ (åœ¨ useTextBuffer ä¸­å®ç°)

### Phase 4: é›†æˆä¸ä¼˜åŒ– âœ… å®Œæˆ
- [x] REPL é€‚é…å±‚ (`src/ui/InkREPL.tsx`)
- [x] é›†æˆåˆ°ç°æœ‰ kodax_cli.ts (`--ink` å‚æ•°)
- [x] ä¸»é¢˜ç³»ç»Ÿ (`src/ui/themes/`)
- [x] å‘½ä»¤å¤„ç†é›†æˆ
- [x] TextBuffer å•å…ƒæµ‹è¯• (`tests/text-buffer.test.ts` - 48 tests)

**ä½¿ç”¨æ–¹å¼**: `kodax --ink` å¯ç”¨ Ink UI æ¨¡å¼

### Phase 5: ç”¨æˆ·ä½“éªŒå¢å¼º âœ… å·²å®Œæˆ

#### 5.1 å¯åŠ¨æ¨ªå¹…è®¾è®¡ (Startup Banner)

**ç›®æ ‡**: æ˜¾ç¤ºå®Œæ•´çš„ ASCII è‰ºæœ¯ Logo å’Œå®Œå¤‡çš„ä¼šè¯ä¿¡æ¯ï¼Œæä¾›æ¸…æ™°çš„ç”¨æˆ·ç•Œé¢ã€‚

**æœ€ç»ˆè®¾è®¡**:
```
  â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
  â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—  â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ•”â•
  â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—
  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•— â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—
  â•šâ•â•  â•šâ•â•  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•   â•šâ•â•  â•šâ•â•  â•šâ•â•  â•šâ•â•

  v0.3.2 | minimax-coding/MiniMax-M2.5 | code +think +auto
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Session: 20260220_143203 | Working: C:\Works\Projects\MarkXbook
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

**æ˜¾ç¤ºå†…å®¹**:
1. **ASCII è‰ºæœ¯ Logo** - 6 è¡Œé«˜çš„ KodaX å­—æ¯è‰ºæœ¯
2. **ç‰ˆæœ¬ä¿¡æ¯** - å½“å‰ç‰ˆæœ¬å·
3. **Provider/Model** - å½“å‰ä½¿ç”¨çš„ AI æ¨¡å‹
4. **æ¨¡å¼çŠ¶æ€** - code/ask æ¨¡å¼ï¼Œ+think/+auto/+plan çŠ¶æ€
5. **ä¼šè¯ä¿¡æ¯** - å®Œæ•´ Session IDï¼ˆæ ¼å¼: YYYYMMDD_HHMMSSï¼‰
6. **å·¥ä½œç›®å½•** - å½“å‰é¡¹ç›®è·¯å¾„

**æ–‡ä»¶æ”¹åŠ¨**:
- `src/ui/InkREPL.tsx` - å®Œæ•´ Banner ç»„ä»¶

#### 5.2 ä¼šè¯å†å²æ˜¾ç¤º (Session History Display) âœ… å·²å®Œæˆ

**é—®é¢˜**: æ¢å¤ä¼šè¯æ—¶ï¼ˆ`-c` æˆ– `-r`ï¼‰ï¼Œç”¨æˆ·æ— æ³•å¿«é€Ÿäº†è§£ä¹‹å‰çš„å¯¹è¯å†…å®¹ã€‚

**ç›®æ ‡**: å¯åŠ¨æ—¶æ˜¾ç¤ºæœ€è¿‘ 3-5 æ¡å¯¹è¯å†å²ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿæ¢å¤ä¸Šä¸‹æ–‡ã€‚

**è®¾è®¡**:
```
  [æ¢å¤ä¼šè¯ - æœ€è¿‘ 5 æ¡å¯¹è¯]
  [ç”¨æˆ·] å¸®æˆ‘ä¿®å¤ Backspace é”®çš„é—®é¢˜
  [åŠ©æ‰‹] å·²ä¿®å¤ï¼Œé—®é¢˜æ˜¯ raw mode ä¸‹çš„é”®ç›˜äº‹ä»¶å¤„ç†...
  [ç”¨æˆ·] è¿è¡Œæµ‹è¯•
  [åŠ©æ‰‹] æ‰€æœ‰ 416 ä¸ªæµ‹è¯•é€šè¿‡ âœ“
```

**å®ç°è¦ç‚¹**:
1. åœ¨ `InkREPL` ç»„ä»¶ä¸­è·å–å†å²æ¶ˆæ¯
2. åˆ›å»º `SessionHistory` ç»„ä»¶æ˜¾ç¤ºå†å²
3. é™åˆ¶æ˜¾ç¤ºæ¡æ•°ï¼ˆé»˜è®¤ 5 æ¡ï¼‰
4. è¶…é•¿æ¶ˆæ¯æˆªæ–­æ˜¾ç¤ºï¼ˆå¸¦çœç•¥å·ï¼‰
5. ä»…åœ¨æ¢å¤ä¼šè¯æ—¶æ˜¾ç¤ºï¼ˆæ–°ä¼šè¯ä¸æ˜¾ç¤ºï¼‰

**æ–‡ä»¶**:
- `src/ui/components/SessionHistory.tsx`

**æ¥å£è®¾è®¡**:
```typescript
interface SessionHistoryProps {
  messages: Array<{
    role: 'user' | 'assistant';
    content: string;
    timestamp?: Date;
  }>;
  maxDisplay?: number;  // é»˜è®¤ 5
  maxLength?: number;   // æ¯æ¡æ¶ˆæ¯æœ€å¤§é•¿åº¦ï¼Œé»˜è®¤ 100
}

export const SessionHistory: React.FC<SessionHistoryProps>;
```

#### 5.3 è¿è´¯çš„å†å²å¯¼èˆª (Connected History Navigation)

**é—®é¢˜**: å½“å‰çš„å†å²å¯¼èˆªï¼ˆä¸Šä¸‹é”®ï¼‰åªåœ¨å½“å‰å¤šè¡Œå—å†…ç§»åŠ¨ï¼Œæ— æ³•è¿ç»­æµè§ˆæ‰€æœ‰å†å²è®°å½•ã€‚

**ç›®æ ‡**: å®ç°ç±»ä¼¼ Claude Code çš„è¿è´¯å†å²å¯¼èˆªï¼š
- `â†‘` åœ¨å½“å‰è¡Œæ˜¯ç¬¬ä¸€è¡Œæ—¶ï¼ŒåŠ è½½ä¸Šä¸€æ¡å†å²è®°å½•
- `â†“` åœ¨å½“å‰è¡Œæ˜¯æœ€åä¸€è¡Œæ—¶ï¼ŒåŠ è½½ä¸‹ä¸€æ¡å†å²è®°å½•
- å†å²è®°å½•å¯ä»¥åŒ…å«å¤šè¡Œå†…å®¹ï¼Œæ­£ç¡®å¡«å……åˆ° TextBuffer

**è¡Œä¸ºè®¾è®¡**:

| å…‰æ ‡ä½ç½® | æŒ‰é”® | è¡Œä¸º |
|---------|------|------|
| å¤šè¡Œå—å†…éƒ¨ | `â†‘` | ç§»åŠ¨åˆ°ä¸Šä¸€è¡Œ |
| å¤šè¡Œå—å†…éƒ¨ | `â†“` | ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ |
| ç¬¬ä¸€è¡Œç¬¬ä¸€åˆ— | `â†‘` | åŠ è½½ä¸Šä¸€æ¡å†å² |
| æœ€åä¸€è¡Œæœ«å°¾ | `â†“` | åŠ è½½ä¸‹ä¸€æ¡å†å² |
| å•è¡Œè¾“å…¥ | `â†‘` | åŠ è½½ä¸Šä¸€æ¡å†å² |
| å•è¡Œè¾“å…¥ | `â†“` | åŠ è½½ä¸‹ä¸€æ¡å†å² |

**å®ç°è¦ç‚¹**:
1. ä¿®æ”¹ `useInputHistory` Hookï¼Œæ”¯æŒå¤šè¡Œå†å²è®°å½•
2. ä¿®æ”¹ `useTextBuffer` æˆ– `InputPrompt`ï¼Œå¤„ç†è¾¹ç•Œæ¡ä»¶
3. å†å²è®°å½•å­˜å‚¨æ—¶ä¿ç•™æ¢è¡Œç¬¦
4. å¯¼èˆªæ—¶å…‰æ ‡ç§»åŠ¨åˆ°å¯¹åº”ä½ç½®ï¼ˆé¦–è¡Œæˆ–æœ«è¡Œï¼‰

**æ–‡ä»¶æ”¹åŠ¨**:
- `src/ui/hooks/useInputHistory.ts` - æ”¯æŒå¤šè¡Œå†å²
- `src/ui/components/InputPrompt.tsx` - è¾¹ç•Œå¯¼èˆªé€»è¾‘
- `src/ui/utils/text-buffer.ts` - å¯èƒ½éœ€è¦è¾…åŠ©æ–¹æ³•

**ä»£ç ç¤ºä¾‹**:
```typescript
// useInputHistory.ts
interface HistoryEntry {
  text: string;       // å¯èƒ½åŒ…å«æ¢è¡Œç¬¦
  timestamp: number;
}

// InputPrompt.tsx
const handleNavigate = (direction: 'up' | 'down') => {
  const { cursor, lineCount } = buffer;

  if (direction === 'up') {
    // å¦‚æœåœ¨ç¬¬ä¸€è¡Œï¼Œå°è¯•åŠ è½½ä¸Šä¸€æ¡å†å²
    if (cursor.row === 0 && cursor.col === 0) {
      const prevHistory = history.previous();
      if (prevHistory) {
        buffer.setText(prevHistory.text);
        buffer.moveToStart(); // æˆ– moveToEnd()
      }
    } else {
      buffer.move('up');
    }
  }

  if (direction === 'down') {
    // å¦‚æœåœ¨æœ€åä¸€è¡Œæœ«å°¾ï¼Œå°è¯•åŠ è½½ä¸‹ä¸€æ¡å†å²
    const lastCol = buffer.currentLineLength;
    if (cursor.row === lineCount - 1 && cursor.col >= lastCol) {
      const nextHistory = history.next();
      if (nextHistory) {
        buffer.setText(nextHistory.text);
        buffer.moveToEnd();
      }
    } else {
      buffer.move('down');
    }
  }
};
```

#### 5.4 æ¸²æŸ“ç¨³å®šæ€§ä¼˜åŒ– (Render Stability) âœ… å·²å®Œæˆ

**é—®é¢˜**: äº¤äº’ä¸€æ¬¡å Banner æ¶ˆå¤±æˆ–ä½ç½®é”™è¯¯ï¼Œå‘½ä»¤è¾“å‡ºä¸ Ink æ¸²æŸ“æ··åœ¨ä¸€èµ·å¯¼è‡´è§†è§‰æ··ä¹±ã€‚

**æ ¹æœ¬åŸå› **: æ··åˆä½¿ç”¨ `console.log`ï¼ˆå‘½ä»¤è¾“å‡ºï¼‰å’Œ Ink æ¸²æŸ“ï¼ŒåŠ ä¸Š `showBanner` çŠ¶æ€å˜åŒ–å¯¼è‡´å¸ƒå±€é‡æ¸²æŸ“ã€‚

**ç ”ç©¶å‘ç°** (å‚è€ƒ Claude Code / Gemini CLI):
- **Claude Code ä¸ä½¿ç”¨ alternate screen buffer** - ä¿ç•™ç»ˆç«¯æ»šåŠ¨å†å²
- **Gemini CLI æ¡ä»¶ä½¿ç”¨** - æ£€æµ‹å±å¹•é˜…è¯»å™¨æ—¶ç¦ç”¨
- **ä¸¤è€…éƒ½é¿å…æ··åˆ console.log å’Œ Ink æ¸²æŸ“**

**æœ€ç»ˆè§£å†³æ–¹æ¡ˆ**:
1. **Banner åœ¨ Ink å¯åŠ¨å‰æ‰“å°** - åˆ›å»º `printStartupBanner()` å‡½æ•°ï¼Œåœ¨ `render()` è°ƒç”¨å‰æ‰§è¡Œ
2. **ç§»é™¤ç»„ä»¶å†…çš„åŠ¨æ€å†…å®¹** - åˆ é™¤æ¶ˆæ¯åˆ—è¡¨ã€çŠ¶æ€æ ç­‰ä¼šéšçŠ¶æ€å˜åŒ–çš„ç»„ä»¶
3. **ä½¿ç”¨ `patchConsole: false`** - å…è®¸å‘½ä»¤è¾“å‡ºæ­£å¸¸å·¥ä½œ
4. **ç”¨æˆ·æ¶ˆæ¯ç”¨ console.log è¾“å‡º** - è€Œä¸æ˜¯åœ¨ç»„ä»¶å†…æ¸²æŸ“

**å…³é”®æ”¹åŠ¨**:
```typescript
// åœ¨ Ink render() ä¹‹å‰è°ƒç”¨
printStartupBanner(currentConfig, context.sessionId, workingDir);

// Ink ç»„ä»¶åªä¿ç•™è¾“å…¥æ¡†
const InkREPL = () => (
  <Box flexDirection="column">
    <InputPrompt onSubmit={handleSubmit} ... />
  </Box>
);

// ç”¨æˆ·æ¶ˆæ¯é€šè¿‡ console.log è¾“å‡º
console.log(chalk.cyan(`You: ${input}`));
```

**é¢„æœŸæ•ˆæœ**:
- Banner å¯åŠ¨æ—¶æ˜¾ç¤ºä¸€æ¬¡ï¼Œéšå†…å®¹å‘ä¸Šè‡ªç„¶æ»šåŠ¨ï¼ˆç±»ä¼¼ Claude Codeï¼‰
- ç”¨æˆ·æ¶ˆæ¯ä¸ä¼šé‡å¤æ¸²æŸ“
- å‘½ä»¤è¾“å‡ºæ­£ç¡®è¿½åŠ 
- ç»ˆç«¯æ»šåŠ¨å†å²å®Œæ•´ä¿ç•™

**æ–‡ä»¶æ”¹åŠ¨**:
- `src/ui/InkREPL.tsx` - ç§»é™¤æ¶ˆæ¯åˆ—è¡¨ï¼Œç®€åŒ–ç»„ä»¶ï¼Œbanner æ‰“å°ç§»åˆ° render() å‰
- `tests/banner.test.ts` - æ–°å¢ Banner ç¨³å®šæ€§æµ‹è¯•

#### Phase 5 ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | æ–‡ä»¶ | çŠ¶æ€ |
|------|--------|------|------|
| 5.1.1 æ¢å¤å®Œæ•´ ASCII è‰ºæœ¯ Logo | P0 | `InkREPL.tsx` | âœ… å·²å®Œæˆ |
| 5.1.2 æ˜¾ç¤ºç‰ˆæœ¬/Provider/Mode ä¿¡æ¯ | P0 | `InkREPL.tsx` | âœ… å·²å®Œæˆ |
| 5.1.3 æ˜¾ç¤º Session ID å’Œå·¥ä½œç›®å½• | P0 | `InkREPL.tsx` | âœ… å·²å®Œæˆ |
| 5.2.1 åˆ›å»º SessionHistory ç»„ä»¶ | P1 | `SessionHistory.tsx` | âœ… å·²å®Œæˆ |
| 5.2.2 é›†æˆåˆ° InkREPL å¯åŠ¨æµç¨‹ | P1 | `InkREPL.tsx` | âœ… å·²å®Œæˆ |
| 5.3.1 ä¿®æ”¹ useInputHistory æ”¯æŒå¤šè¡Œ | P0 | `useInputHistory.ts` | âœ… å·²æ”¯æŒ |
| 5.3.2 å®ç°è¾¹ç•Œå†å²å¯¼èˆªé€»è¾‘ | P0 | `InputPrompt.tsx` | âœ… å·²å®Œæˆ |
| 5.3.3 æ·»åŠ å•å…ƒæµ‹è¯• | P1 | `tests/` | âœ… å·²å®Œæˆ |
| 5.4.1 ä¿®å¤æ¸²æŸ“ç¨³å®šæ€§é—®é¢˜ | P0 | `InkREPL.tsx` | âœ… å·²å®Œæˆ |
| 5.4.2 ç§»é™¤æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶ | P1 | `InkREPL.tsx` | âœ… å·²å®Œæˆ |
| 5.4.3 Banner ç§»åˆ° Ink render() å‰ | P0 | `InkREPL.tsx` | âœ… å·²å®Œæˆ |
| 5.4.4 æ·»åŠ  Banner ç¨³å®šæ€§æµ‹è¯• | P2 | `tests/banner.test.ts` | âœ… å·²å®Œæˆ |

---

## 7. å‚è€ƒ

- [Gemini CLI text-buffer.ts](https://github.com/google-gemini/gemini-cli/blob/master/packages/cli/src/ui/components/shared/text-buffer.ts)
- [Gemini CLI InputPrompt.tsx](https://github.com/google-gemini/gemini-cli/blob/master/packages/cli/src/ui/components/InputPrompt.tsx)
- [Ink GitHub](https://github.com/vadimdemedes/ink)
- [Memo Code è¾“å…¥æ¡†å®ç°](https://juejin.cn/post/7605800124883288070)

---

## 8. é£é™©ä¸å›æ»š

| é£é™© | å¯èƒ½æ€§ | åº”å¯¹æªæ–½ |
|------|--------|----------|
| Ink ä¸ç°æœ‰ CLI å†²çª | ä½ | ä½¿ç”¨é€‚é…å±‚éš”ç¦» |
| React é¦–æ¬¡æ¸²æŸ“å»¶è¿Ÿ | ä½ | ä½¿ç”¨é™æ€å†…å®¹ä¼˜åŒ– |
| ç»ˆç«¯å…¼å®¹æ€§é—®é¢˜ | ä¸­ | æ£€æµ‹ç»ˆç«¯èƒ½åŠ›é™çº§ |

### å›æ»šæ–¹æ¡ˆ
- ä¿ç•™åŸæœ‰ `repl.ts` ä½œä¸º `repl-legacy.ts`
- é€šè¿‡ `--legacy-ui` å‚æ•°åˆ‡æ¢

### 4.1 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     äº¤äº’å¼ REPL å±‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  repl.ts (ä¸»å¾ªç¯)                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å¤šè¡Œè¾“å…¥å¤„ç†                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å¿«æ·é”®ç»‘å®š                                      â”‚   â”‚
â”‚  â”‚  â””â”€â”€ çŠ¶æ€æ é›†æˆ                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  status-bar.ts (æ–°å»º)                                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ StatusBar ç±»                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ render() - æ¸²æŸ“çŠ¶æ€æ                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ update() - æ›´æ–°çŠ¶æ€                              â”‚   â”‚
â”‚  â”‚  â””â”€â”€ hide()/show() - æ˜¾ç¤ºæ§åˆ¶                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  autocomplete.ts (æ–°å»º)                              â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ completeFilePath() - æ–‡ä»¶è·¯å¾„è¡¥å…¨                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ completeCommand() - å‘½ä»¤è¡¥å…¨                     â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Completer æ¥å£                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  themes.ts (æ–°å»º)                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Theme æ¥å£                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ themes.dark / themes.light / themes.minimal     â”‚   â”‚
â”‚  â”‚  â””â”€â”€ applyTheme()                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLI è¾“å‡ºå±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  kodax_cli.ts                                        â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æµå¼ Markdown æ¸²æŸ“                              â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ ä»£ç è¯­æ³•é«˜äº®                                    â”‚   â”‚
â”‚  â”‚  â””â”€â”€ å·¥å…·è¿›åº¦å¯è§†åŒ–                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ•°æ®ç»“æ„

#### 4.2.1 StatusBar æ¥å£

```typescript
// src/interactive/status-bar.ts

export interface StatusBarState {
  sessionId: string;           // ç®€çŸ­ä¼šè¯ ID
  mode: 'code' | 'ask';        // å½“å‰æ¨¡å¼
  provider: string;            // Provider åç§°
  model: string;               // æ¨¡å‹åç§°
  tokenUsage?: {
    input: number;
    output: number;
    total: number;
  };
  currentTool?: string;        // å½“å‰æ‰§è¡Œçš„å·¥å…·
  projectInfo?: {
    name: string;
    completedFeatures: number;
    totalFeatures: number;
  };
}

export class StatusBar {
  private state: StatusBarState;
  private visible: boolean;
  private terminalWidth: number;

  constructor(initialState: StatusBarState);

  render(): void;
  update(updates: Partial<StatusBarState>): void;
  show(): void;
  hide(): void;
  setPosition(x: number, y: number): void;
}
```

#### 4.2.2 Completer æ¥å£

```typescript
// src/interactive/autocomplete.ts

export interface Completion {
  text: string;                // è¡¥å…¨æ–‡æœ¬
  display: string;             // æ˜¾ç¤ºæ–‡æœ¬
  description?: string;        // æè¿°
  type: 'file' | 'command' | 'argument';
}

export interface Completer {
  canComplete(input: string, cursorPos: number): boolean;
  getCompletions(input: string, cursorPos: number): Promise<Completion[]>;
}

export class FileCompleter implements Completer {
  // @file è¡¥å…¨
}

export class CommandCompleter implements Completer {
  // /command è¡¥å…¨
}
```

#### 4.2.3 Theme æ¥å£

```typescript
// src/interactive/themes.ts

export interface ThemeColors {
  primary: string;             // ä¸»è‰²è°ƒ
  secondary: string;           // æ¬¡è¦é¢œè‰²
  accent: string;              // å¼ºè°ƒè‰²
  text: string;                // æ–‡æœ¬é¢œè‰²
  dim: string;                 // æš—æ·¡æ–‡æœ¬
  success: string;             // æˆåŠŸçŠ¶æ€
  warning: string;             // è­¦å‘ŠçŠ¶æ€
  error: string;               // é”™è¯¯çŠ¶æ€
  spinner: string[];           // Spinner é¢œè‰²åºåˆ—
}

export interface Theme {
  name: string;
  colors: ThemeColors;
  symbols: {
    prompt: string;
    success: string;
    error: string;
    warning: string;
    spinner: string[];
  };
}

export const themes: Record<string, Theme>;
```

### 4.3 å‘½ä»¤å¤„ç†å™¨

```typescript
// src/interactive/repl.ts

// å¿«æ·é”®æ˜ å°„
const KEYBOARD_SHORTCUTS: Record<string, () => void> = {
  // Ctrl+O: åˆ‡æ¢å·¥å…·è¾“å‡ºæ˜¾ç¤º
  '\x0f': () => toggleToolOutput(),

  // Ctrl+T: æ˜¾ç¤º Todo åˆ—è¡¨
  '\x14': () => showTodoList(),

  // Ctrl+R: å†å²æœç´¢ (readline å†…ç½®)
  // Ctrl+C: å–æ¶ˆ (readline å†…ç½®)

  // Ctrl+J: å¤šè¡Œè¾“å…¥æ¢è¡Œ
  '\x0a': () => insertNewline(),
};

// å¤šè¡Œè¾“å…¥å¤„ç†
function handleMultilineInput(input: string): string[] {
  const lines: string[] = [];
  let currentLine = input;

  while (true) {
    if (currentLine.endsWith('\\')) {
      // ç»­è¡Œç¬¦
      lines.push(currentLine.slice(0, -1));
      currentLine = await readNextLine('... ');
    } else if (hasOpenBrackets(currentLine)) {
      // æ‹¬å·æœªé—­åˆ
      lines.push(currentLine);
      currentLine = await readNextLine('... ');
    } else {
      lines.push(currentLine);
      break;
    }
  }

  return lines;
}
```

### 4.4 ç¡®è®¤æç¤ºå¢å¼º

```typescript
// src/interactive/prompts.ts

export interface ConfirmOptions {
  message: string;
  default?: 'y' | 'n';
  options?: Array<{
    key: string;
    label: string;
    description: string;
  }>;
}

export async function confirmEnhanced(options: ConfirmOptions): Promise<string> {
  const { message, default: defaultVal, options: customOptions } = options;

  // é»˜è®¤é€‰é¡¹
  const opts = customOptions || [
    { key: 'y', label: 'Yes', description: 'ç¡®è®¤æ‰§è¡Œ' },
    { key: 'n', label: 'No', description: 'å–æ¶ˆæ“ä½œ' },
  ];

  // æ¸²æŸ“é€‰é¡¹
  const optionsText = opts.map(o =>
    chalk.dim(`[${o.key}]`) + ` ${o.label}`
  ).join(' ');

  console.log(chalk.cyan(`\n? ${message}`));
  console.log(chalk.dim(`  ${optionsText}`));

  const answer = await readLine(`  Choose: `);

  return answer.toLowerCase() || defaultVal || 'n';
}
```

---

## 5. å®ç°è®¡åˆ’

### Phase 1: åŸºç¡€å¢å¼º (P0)

| ä»»åŠ¡ | æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|------|
| 1.1 | `src/interactive/prompts.ts` | æ–°å¢ï¼šå¢å¼ºç¡®è®¤æç¤ºç»„ä»¶ |
| 1.2 | `src/interactive/repl.ts` | æ·»åŠ ï¼šå“åº”å¼å¸ƒå±€æ£€æµ‹ |
| 1.3 | `src/interactive/repl.ts` | æ·»åŠ ï¼šé”®ç›˜å¿«æ·é”®ç»‘å®š |

### Phase 2: æ ¸å¿ƒ UI (P0)

| ä»»åŠ¡ | æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|------|
| 2.1 | `src/interactive/repl.ts` | å®ç°ï¼šå¤šè¡Œè¾“å…¥ (Ctrl+J) |
| 2.2 | `src/interactive/status-bar.ts` | æ–°å¢ï¼šçŠ¶æ€æ ç»„ä»¶ |
| 2.3 | `src/kodax_cli.ts` | å¢å¼ºï¼šè¿›åº¦å¯è§†åŒ– |

### Phase 3: é«˜çº§åŠŸèƒ½ (P1)

| ä»»åŠ¡ | æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|------|
| 3.1 | `src/interactive/autocomplete.ts` | æ–°å¢ï¼šè‡ªåŠ¨è¡¥å…¨ |
| 3.2 | `src/kodax_cli.ts` | å¢å¼ºï¼šæµå¼ Markdown |
| 3.3 | `src/kodax_cli.ts` | å¢å¼ºï¼šå·¥å…·è¿›åº¦è¿½è¸ª |

### Phase 4: æ¶¦è‰² (P2)

| ä»»åŠ¡ | æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|------|
| 4.1 | `src/interactive/themes.ts` | æ–°å¢ï¼šä¸»é¢˜ç³»ç»Ÿ |
| 4.2 | `src/interactive/repl.ts` | å¢å¼ºï¼šå‘½ä»¤å†å² |
| 4.3 | `src/interactive/repl.ts` | å¢å¼ºï¼šTodo UI |

---

## 6. å…³é”®å†³ç­–æ€»ç»“

| å†³ç­– | é€‰æ‹© | ç†ç”± |
|------|------|------|
| å¤šè¡Œè¾“å…¥ | Ctrl+J æ¢è¡Œ | å…¼å®¹æ€§æœ€å¥½ |
| çŠ¶æ€æ  | åº•éƒ¨å›ºå®š | ä¿¡æ¯å±•ç¤ºå®Œæ•´ |
| è‡ªåŠ¨è¡¥å…¨ | readline åŸç”Ÿ | æ— éœ€æ–°ä¾èµ– |
| ä¸»é¢˜ | å…ˆ dark ä¸»é¢˜ | ç»ˆç«¯ç”¨æˆ·åå¥½ |

---

## 7. é£é™©ä¸å›æ»š

### æ½œåœ¨é£é™©

| é£é™© | å¯èƒ½æ€§ | åº”å¯¹æªæ–½ |
|------|--------|----------|
| ANSI è½¬ä¹‰åºåˆ—å…¼å®¹æ€§ | ä¸­ | æ£€æµ‹ç»ˆç«¯èƒ½åŠ›ï¼Œé™çº§å¤„ç† |
| çŠ¶æ€æ ä¸è¾“å‡ºå†²çª | ä½ | ä½¿ç”¨å¤‡ç”¨å±å¹•ç¼“å†²åŒº |
| è¡¥å…¨æ€§èƒ½é—®é¢˜ | ä½ | å¼‚æ­¥åŠ è½½ï¼Œç¼“å­˜ç»“æœ |

### å›æ»šæ–¹æ¡ˆ

- æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹ï¼Œå¯å•ç‹¬ç¦ç”¨
- é€šè¿‡é…ç½®é¡¹ `ui.features` æ§åˆ¶åŠŸèƒ½å¼€å…³
- çŠ¶æ€æ å¯é€šè¿‡ `--no-status-bar` å‚æ•°ç¦ç”¨

---

## 8. ä¸å…¶ä»– CLI å·¥å…·çš„å¯¹æ¯”

| åŠŸèƒ½ | Claude Code | Gemini CLI | Aider | KodaX (æ”¹è¿›å) |
|------|-------------|------------|-------|----------------|
| å¤šè¡Œè¾“å…¥ | âœ… | âœ… | âœ… | âœ… |
| æ–‡ä»¶è¡¥å…¨ | âœ… | âœ… | âœ… | âœ… |
| å‘½ä»¤è¡¥å…¨ | âœ… | âœ… | âœ… | âœ… |
| çŠ¶æ€æ  | âŒ | âŒ | âœ… | âœ… |
| ä¸»é¢˜ | âŒ | âŒ | âŒ | âœ… |
| é”®ç›˜å¿«æ·é”® | âœ… | éƒ¨åˆ† | éƒ¨åˆ† | âœ… |
| Markdown é«˜äº® | âœ… | âœ… | âŒ | âœ… |

---

## 9. åç»­ä¼˜åŒ–æ–¹å‘

1. **å¤–éƒ¨ç¼–è¾‘å™¨é›†æˆ**ï¼šCtrl+E æ‰“å¼€ $EDITOR ç¼–è¾‘å¤šè¡Œè¾“å…¥
2. **æ¨¡ç³Šæœç´¢**ï¼šfzf é£æ ¼çš„æ–‡ä»¶/å‘½ä»¤æœç´¢
3. **åˆ†å±æ˜¾ç¤º**ï¼šå·¥å…·è¾“å‡ºä¸å¯¹è¯åˆ†å±
4. **é¼ æ ‡æ”¯æŒ**ï¼šç‚¹å‡»é€‰æ‹©è¡¥å…¨é¡¹
5. **Web UI**ï¼šå¯é€‰çš„æµè§ˆå™¨ç•Œé¢

---

## 10. KodaX vs Gemini CLI å·®è·åˆ†æ (2026-02-20)

> **èƒŒæ™¯**: æ·±å…¥ç ”ç©¶ Gemini CLI æºç åå‘ç° KodaX Ink UI å­˜åœ¨æ˜¾è‘—åŠŸèƒ½å·®è·ã€‚

### 10.1 æ¶æ„å¯¹æ¯”

| æ¨¡å— | Gemini CLI | KodaX | å·®è· |
|------|------------|-------|------|
| **ä¸»å®¹å™¨** | `AppContainer.tsx` (~2000è¡Œ) | `InkREPL.tsx` (~570è¡Œ) | KodaX è¿‡äºç®€å• |
| **è¾“å…¥ç»„ä»¶** | `InputPrompt.tsx` (~1500è¡Œ) | `InputPrompt.tsx` (~250è¡Œ) | ç¼ºå°‘è®¸å¤šåŠŸèƒ½ |
| **æ–‡æœ¬ç¼“å†²** | `text-buffer.js` (~130KB) | `text-buffer.ts` (~450è¡Œ) | åŠŸèƒ½å·®è·å¤§ |
| **é”®ç›˜ç³»ç»Ÿ** | `KeypressContext.tsx` (~22KB) | `useKeypress.ts` (~70è¡Œ) | ç¼ºå°‘ä¼˜å…ˆçº§ç³»ç»Ÿ |
| **æµå¼å¤„ç†** | `useGeminiStream.ts` (~57KB) | æ—  | å®Œå…¨ç¼ºå¤± |
| **ä¸»é¢˜ç³»ç»Ÿ** | å¤šä¸ªä¸»é¢˜æ–‡ä»¶ + Manager | `dark.ts` (~50è¡Œ) | éå¸¸åŸºç¡€ |

### 10.2 ä¸¥é‡é—®é¢˜ (P0)

#### 10.2.1 ğŸ”´ æ¶ˆæ¯åˆ—è¡¨ä¸æ¸²æŸ“

**ç°çŠ¶**: `InkREPL` åªæ¸²æŸ“ `InputPrompt`ï¼Œæ‰€æœ‰è¾“å‡ºé€šè¿‡ `console.log` æ‰“å°ã€‚
```typescript
// InkREPL.tsx - åªæœ‰è¾“å…¥æ¡†
return (
  <Box flexDirection="column">
    <InputPrompt onSubmit={handleSubmit} ... />
  </Box>
);
```

**Gemini CLI åšæ³•**:
- `AppContainer` ç®¡ç†å®Œæ•´ UI çŠ¶æ€
- `HistoryItems` ç»„ä»¶æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
- å·¥å…·è°ƒç”¨æœ‰ä¸“é—¨çš„ `ToolGroup` ç»„ä»¶

#### 10.2.2 ğŸ”´ æ— æµå¼å“åº”

**ç°çŠ¶**: ç”¨æˆ·å¿…é¡»ç­‰å¾…å®Œæ•´å“åº”ï¼Œæ— ä»»ä½•åé¦ˆã€‚

**Gemini CLI åšæ³•**:
```typescript
enum StreamingState {
  Idle = 'idle',
  Responding = 'responding',
  WaitingForConfirmation = 'waiting_for_confirmation'
}
```
- å®æ—¶æ›´æ–° UI æ˜¾ç¤ºéƒ¨åˆ†å“åº”
- åŠ è½½æŒ‡ç¤ºå™¨ + çŸ­è¯­å¾ªç¯ (witty/informative/minimal)

#### 10.2.3 ğŸ”´ æ— å·¥å…·æ‰§è¡Œå¯è§†åŒ–

**ç°çŠ¶**: å·¥å…·è°ƒç”¨ï¼ˆæ–‡ä»¶è¯»å†™ã€å‘½ä»¤æ‰§è¡Œï¼‰æ— è§†è§‰åé¦ˆã€‚

**Gemini CLI åšæ³•**:
```typescript
type ToolCallStatus =
  | 'Scheduled' | 'Validating' | 'AwaitingApproval'
  | 'Executing' | 'Success' | 'Error' | 'Cancelled';

// çŠ¶æ€å›¾æ ‡
const TOOL_STATUS = { scheduled: 'â—‹', executing: 'â—‹', success: 'âœ“', error: 'âœ—' };
```

#### 10.2.4 ğŸ”´ é”®ç›˜ç³»ç»Ÿè¿‡äºç®€å•

**ç°çŠ¶**: æ— ä¼˜å…ˆçº§ç³»ç»Ÿï¼Œæ— æ³•è®©ä¸åŒç»„ä»¶å¤„ç†ç›¸åŒæŒ‰é”®ã€‚

**Gemini CLI åšæ³•**:
```typescript
enum KeypressHandlerPriority {
  Low = -100, Normal = 0, High = 100, Critical = 200
}
// ä½¿ç”¨ MultiMap ç®¡ç†è®¢é˜…è€…ï¼ŒåŒä¼˜å…ˆçº§å†…åæ³¨å†Œçš„å…ˆå¤„ç†
```

### 10.3 ä¸­ç­‰é—®é¢˜ (P1)

| åŠŸèƒ½ | Gemini CLI | KodaX |
|------|------------|-------|
| **Unicode å¤„ç†** | LRU ç¼“å­˜ + code point | åŸºç¡€ code point |
| **è§†è§‰/é€»è¾‘å…‰æ ‡** | âœ… åˆ†ç¦» | âŒ |
| **ç²˜è´´å ä½ç¬¦** | `[Pasted Text: X lines]` | âŒ |
| **å¤–éƒ¨ç¼–è¾‘å™¨** | Ctrl+O æ‰“å¼€ $EDITOR | âŒ |
| **æ–‡æœ¬é€‰æ‹©** | âœ… | âŒ |
| **æ»šåŠ¨è§†å£** | âœ… | âŒ |
| **å¤§ç²˜è´´ä¿æŠ¤** | >50 è¡Œæˆ– >5000 å­—ç¬¦æŠ˜å  | âŒ |
| **æŒä¹…åŒ–å†å²** | RecordingService | ä»…å†…å­˜ |
| **ä¸»é¢˜æ•°é‡** | 10+ | 2 |
| **è‡ªåŠ¨ä¸»é¢˜æ£€æµ‹** | âœ… | âŒ |

### 10.4 Gemini CLI å…³é”®å®ç°å‚è€ƒ

```
packages/cli/src/ui/
â”œâ”€â”€ AppContainer.tsx          # ä¸»å®¹å™¨ (~2000è¡Œ)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ InputPrompt.tsx       # è¾“å…¥ç»„ä»¶ (~1500è¡Œ)
â”‚   â”œâ”€â”€ SuggestionsDisplay.tsx # è¡¥å…¨ UI
â”‚   â””â”€â”€ shared/text-buffer.js # æ–‡æœ¬ç¼“å†² (~130KB)
â”œâ”€â”€ contexts/
â”‚   â”œâ”€â”€ KeypressContext.tsx   # é”®ç›˜ç³»ç»Ÿ (~22KB)
â”‚   â”œâ”€â”€ UIStateContext.tsx    # UI çŠ¶æ€
â”‚   â”œâ”€â”€ UIActionsContext.tsx  # UI åŠ¨ä½œ
â”‚   â””â”€â”€ StreamingContext.tsx  # æµå¼çŠ¶æ€
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useGeminiStream.ts    # æµå¼å¤„ç† (~1600è¡Œ)
â”‚   â””â”€â”€ useLoadingIndicator.ts # åŠ è½½æŒ‡ç¤º
â”œâ”€â”€ themes/
â”‚   â”œâ”€â”€ theme.ts              # ä¸»é¢˜ç±»
â”‚   â””â”€â”€ theme-manager.ts      # ä¸»é¢˜ç®¡ç†
â””â”€â”€ utils/textUtils.ts        # æ–‡æœ¬å·¥å…· (LRU ç¼“å­˜)
```

### 10.5 æŠ€æœ¯å€ºåŠ¡

| é—®é¢˜ | ä½ç½® | ä¼˜å…ˆçº§ |
|------|------|--------|
| é”®ç›˜é€»è¾‘é‡å¤ | `useTextBuffer.ts` + `InputPrompt.tsx` | P1 |
| ç»„ä»¶æœªä½¿ç”¨ | `App.tsx`, `MessageList.tsx`, `StatusBar.tsx` | P0 |
| æ— æŒä¹…åŒ–å­˜å‚¨ | `MemorySessionStorage` | P1 |
| æ¶ˆæ¯ç±»å‹ç®€å• | `types.ts` | P1 |

---

## 11. Phase 6-8 æ”¹è¿›è®¡åˆ’

### Phase 6: æ ¸å¿ƒæ¶æ„é‡æ„ (P0)

| ä»»åŠ¡ | æ–‡ä»¶ | æè¿° |
|------|------|------|
| 6.1 | `contexts/UIStateContext.tsx` | åˆ›å»ºå…¨å±€çŠ¶æ€ Context |
| 6.2 | `contexts/KeypressContext.tsx` | åˆ›å»ºä¼˜å…ˆçº§é”®ç›˜ç³»ç»Ÿ |
| 6.3 | `contexts/StreamingContext.tsx` | åˆ›å»ºæµå¼çŠ¶æ€ç®¡ç† |
| 6.4 | `components/MessageList.tsx` | é‡å†™æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“ |
| 6.5 | `components/ToolGroup.tsx` | å·¥å…·æ‰§è¡Œå¯è§†åŒ– |
| 6.6 | `components/LoadingIndicator.tsx` | åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ |
| 6.7 | `InkREPL.tsx` | é‡æ„é›†æˆæ‰€æœ‰æ–°ç»„ä»¶ |

### Phase 7: æ–‡æœ¬å¤„ç†å¢å¼º (P1)

| ä»»åŠ¡ | æ–‡ä»¶ | æè¿° |
|------|------|------|
| 7.1 | `utils/textUtils.ts` | LRU ç¼“å­˜ + code point å·¥å…· |
| 7.2 | `text-buffer.ts` | è§†è§‰/é€»è¾‘å…‰æ ‡åˆ†ç¦» |
| 7.3 | `hooks/usePasteHandler.ts` | ç²˜è´´æ£€æµ‹ + ä¿æŠ¤æœºåˆ¶ |
| 7.4 | `utils/externalEditor.ts` | å¤–éƒ¨ç¼–è¾‘å™¨æ”¯æŒ |

### Phase 8: ä¸»é¢˜ä¸ä½“éªŒ (P2)

| ä»»åŠ¡ | æ–‡ä»¶ | æè¿° |
|------|------|------|
| 8.1 | `themes/ThemeManager.ts` | ä¸»é¢˜ç®¡ç†å™¨ |
| 8.2 | `themes/*.ts` | å¤šä¸»é¢˜æ”¯æŒ |
| 8.3 | `utils/terminalCapabilities.ts` | ç»ˆç«¯èƒ½åŠ›æ£€æµ‹ |
| 8.4 | `components/SuggestionsDisplay.tsx` | è‡ªåŠ¨è¡¥å…¨ UI |

---

## 12. æ›´æ–°åçš„åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | Claude Code | Gemini CLI | KodaX (å½“å‰) | KodaX (ç›®æ ‡) |
|------|-------------|------------|--------------|--------------|
| å¤šè¡Œè¾“å…¥ | âœ… | âœ… | âœ… | âœ… |
| æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“ | âœ… | âœ… | âŒ | âœ… |
| æµå¼å“åº” | âœ… | âœ… | âŒ | âœ… |
| å·¥å…·å¯è§†åŒ– | âœ… | âœ… | âŒ | âœ… |
| åŠ è½½æŒ‡ç¤ºå™¨ | âœ… | âœ… | âŒ | âœ… |
| æ–‡ä»¶è¡¥å…¨ | âœ… | âœ… | éƒ¨åˆ† | âœ… |
| å‘½ä»¤è¡¥å…¨ | âœ… | âœ… | éƒ¨åˆ† | âœ… |
| çŠ¶æ€æ  | âŒ | âŒ | å­˜åœ¨ä½†æœªç”¨ | âœ… |
| ä¸»é¢˜ | âŒ | âœ… 10+ | âœ… 2 | âœ… 5+ |
| å¤–éƒ¨ç¼–è¾‘å™¨ | âœ… | âœ… | âŒ | âœ… |
| ç²˜è´´ä¿æŠ¤ | âœ… | âœ… | âŒ | âœ… |
| æŒä¹…åŒ–å†å² | âœ… | âœ… | âŒ | âœ… |
