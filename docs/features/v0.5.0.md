# v0.5.0 Feature Design

_创建时间: 2026-02-25_
_更新时间: 2026-02-25_

---

## FEATURE_006: Agent Skills 系统

### 1. 概述

实现完整的 [Agent Skills](https://agentskills.io/) 开放标准，使 KodaX 能够：
- 加载和使用符合 Agent Skills 标准的技能
- 完全兼容 Claude Code 及其他支持 Agent Skills 的工具开发的 skills
- 支持渐进式披露机制，优化上下文使用
- 提供企业级的技能管理和分发能力

**参考文档**:
- [Agent Skills 官方标准](https://agentskills.io/)
- [Claude Code Skills 文档](https://code.claude.com/docs/en/skills)
- [The Complete Guide to Building Skills for Claude](https://resources.anthropic.com/hubfs/The-Complete-Guide-to-Building-Skill-for-Claude.pdf)

### 2. 影响范围

**需要创建的文件**:
```
packages/repl/src/skills/
├── index.ts                    # 技能系统入口
├── types.ts                    # 类型定义 (符合 Agent Skills 标准)
├── skill-loader.ts             # 技能加载器
├── skill-registry.ts           # 技能注册表
├── skill-resolver.ts           # 技能解析器 (参数替换、动态上下文)
├── discovery.ts                # 技能发现与扫描
├── executor.ts                 # 技能执行器 (支持 fork 模式)
└── builtin/                    # 内置技能目录
    ├── code-review/
    │   └── SKILL.md
    ├── git-workflow/
    │   └── SKILL.md
    └── tdd/
        └── SKILL.md
```

**需要修改的文件**:
- `packages/repl/src/interactive/commands.ts` - 集成 `/skills` 命令
- `packages/repl/src/ui/InkREPL.tsx` - 技能 UI 反馈
- `packages/repl/src/llm/context-builder.ts` - 渐进式披露集成

### 3. 技术方案

#### 3.0 依赖说明

| 依赖 | 用途 | 说明 |
|------|------|------|
| `gray-matter` | YAML frontmatter 解析 | 支持容错解析，处理非标准 YAML 格式 |

#### 3.1 Agent Skills 标准文件结构

每个 Skill 是一个目录，包含以下结构：

```
skill-name/
├── SKILL.md           # 必需 - 主技能文件
├── scripts/           # 可选 - 可执行脚本
│   ├── analyze.py
│   └── validate.sh
├── templates/         # 可选 - 模板文件
│   └── output.md
└── resources/         # 可选 - 参考文档
    └── style-guide.md
```

**YAML Frontmatter 解析**:
```typescript
import matter from 'gray-matter';

// 容错解析：处理非标准 YAML（如未引用的含冒号字符串）
function fallbackSanitization(content: string): string {
  // 将含冒号的值转换为 block scalar 格式
  // 例如: description: This: contains: colons
  // 转换为: description: |-
  //           This: contains: colons
}

async function parseSkill(filePath: string) {
  const template = await readFile(filePath);
  try {
    return matter(template);
  } catch {
    // 容错：尝试 sanitization 后重新解析
    return matter(fallbackSanitization(template));
  }
}
```

#### 3.2 SKILL.md 格式

```markdown
---
# === 必需字段 ===
name: skill-name
description: 技能描述。包含触发条件，例如"当用户要求...时使用"。

# === Claude Code 扩展字段 (可选) ===
disable-model-invocation: false    # 是否禁止自动触发
user-invocable: true               # 是否在 / 菜单显示
allowed-tools: "Read, Grep, Glob"  # 限制可用工具
context: fork                      # 在子代理中执行
agent: Explore                     # 指定子代理类型
argument-hint: "[file] [format]"   # 参数提示
model: haiku                       # 指定模型

# === 元数据 (可选) ===
license: MIT
compatibility: "Requires Python 3.8+"
metadata:
  author: KodaX Team
  version: 1.0.0
  tags: [code-quality, review]
---

# Skill Title

技能的详细指令内容...

## 使用方式

处理 $ARGUMENTS 的任务...

或按位置访问参数:
- 第一个参数: $0
- 第二个参数: $1

## 动态上下文

当前 git 状态:
!`git status --short`

## 参考资源

详见 [resources/style-guide.md](resources/style-guide.md)
```

#### 3.3 渐进式披露 (Progressive Disclosure)

**第一级 - 元数据预加载**:
```typescript
// 启动时，仅加载 name 和 description 到系统提示
interface SkillMetadata {
  name: string;
  description: string;
  userInvocable: boolean;
  argumentHint?: string;
}
```

**第二级 - 完整内容加载**:
```typescript
// 当技能被触发时，加载完整 SKILL.md
interface SkillContent extends SkillMetadata {
  content: string;           // Markdown 正文
  disableModelInvocation: boolean;
  allowedTools?: string[];
  context?: 'fork';
  agent?: string;
  model?: string;
}
```

**第三级 - 支持文件按需加载**:
```typescript
// 仅在需要时加载 scripts/, templates/, resources/
interface SkillResources {
  scripts: Map<string, string>;
  templates: Map<string, string>;
  resources: Map<string, string>;
}
```

#### 3.4 技能发现机制

```typescript
// 技能扫描路径优先级
const SKILL_PATHS = [
  // 1. 企业级 (最高优先级)
  '~/.kodox/skills/enterprise/',

  // 2. 用户级
  '~/.kodox/skills/',
  '~/.claude/skills/',  // 兼容 Claude Code

  // 3. 项目级
  '${projectRoot}/.kodox/skills/',
  '${projectRoot}/.claude/skills/',  // 兼容 Claude Code

  // 4. 插件级
  '${pluginPath}/skills/',

  // 5. 内置
  '${kodoxRoot}/builtin/skills/',
];

// 嵌套目录自动发现 (支持 monorepo)
// 当用户在 packages/frontend/ 工作时，自动扫描:
// - packages/frontend/.claude/skills/
// - packages/.claude/skills/
// - .claude/skills/
```

### 4. 接口契约

#### 4.1 核心类型定义

```typescript
/**
 * Agent Skills 标准类型定义
 * 符合 https://agentskills.io/ 规范
 */

// === YAML Frontmatter 字段 ===

interface SkillFrontmatter {
  // 必需字段
  name: string;                          // kebab-case, 最大 64 字符
  description: string;                   // 最大 1024 字符，包含触发条件

  // Claude Code 扩展字段
  disableModelInvocation?: boolean;      // 默认 false
  userInvocable?: boolean;               // 默认 true
  allowedTools?: string;                 // 工具限制，如 "Read, Grep, Bash(python:*)"
  context?: 'fork';                      // 子代理执行模式
  agent?: string;                        // 子代理类型: Explore, Plan, general-purpose 等
  argumentHint?: string;                 // 参数提示，如 "[file] [format]"
  model?: 'haiku' | 'sonnet' | 'opus';   // 指定模型

  // 元数据
  license?: string;
  compatibility?: string;
  metadata?: Record<string, unknown>;
}

// === 完整 Skill 定义 ===

interface Skill extends SkillFrontmatter {
  // 文件路径
  path: string;                          // Skill 目录绝对路径
  skillFilePath: string;                 // SKILL.md 绝对路径

  // 内容
  content: string;                       // Markdown 正文 (已处理变量替换)

  // 支持文件
  scripts?: SkillFile[];                 // scripts/ 目录文件
  templates?: SkillFile[];               // templates/ 目录文件
  resources?: SkillFile[];               // resources/ 目录文件

  // 运行时状态
  loaded: boolean;                       // 是否已完整加载
  source: 'enterprise' | 'user' | 'project' | 'plugin' | 'builtin';
}

interface SkillFile {
  name: string;                          // 文件名
  path: string;                          // 绝对路径
  relativePath: string;                  // 相对于 Skill 目录的路径
  content?: string;                      // 文件内容 (按需加载)
}

// === 技能注册表 ===

interface SkillRegistry {
  // 所有已发现的技能元数据
  skills: Map<string, SkillMetadata>;

  // 发现技能
  discover(): Promise<void>;

  // 获取技能
  get(name: string): Promise<Skill | undefined>;

  // 加载完整技能内容
  loadFull(name: string): Promise<Skill>;

  // 触发技能
  invoke(name: string, args: string, context: SkillContext): Promise<SkillResult>;
}

// === 技能执行上下文 ===

interface SkillContext {
  workingDirectory: string;
  messages: Message[];
  sessionId: string;
  environment: Record<string, string>;
}

// === 技能执行结果 ===

interface SkillResult {
  success: boolean;
  content: string;                       // 处理后的提示内容
  artifacts?: SkillArtifact[];           // 生成的文件等
  error?: string;
}
```

#### 4.2 变量替换系统

```typescript
/**
 * 技能内容变量替换
 */
interface VariableResolver {
  // 替换所有变量
  resolve(content: string, args: string, context: SkillContext): string;
}

// 支持的变量:
// $ARGUMENTS     - 所有参数
// $0, $1, $2...  - 按位置访问参数
// ${CLAUDE_SESSION_ID} - 会话 ID
// !`command`     - 动态上下文注入 (预处理执行)

// 示例:
// 输入: "审查 $ARGUMENTS 的代码"
// 参数: "src/auth.ts"
// 输出: "审查 src/auth.ts 的代码"

// 动态上下文示例:
// 输入: "当前状态:\n!`git status --short`"
// 执行: git status --short
// 输出: "当前状态:\nM src/auth.ts\n?? src/new.ts"
```

#### 4.3 命令接口

```typescript
// /skills - 列出所有可用技能
// /skill-name [args...] - 调用技能
// /skills reload - 重新扫描技能目录
// /skills info <name> - 显示技能详情
```

### 5. 实现步骤

#### Phase 1: 核心框架

1. **创建类型定义** `types.ts`
   - 定义符合 Agent Skills 标准的接口
   - 支持 Claude Code 扩展字段

2. **实现技能发现** `discovery.ts`
   - 多路径扫描
   - 嵌套目录支持
   - 优先级处理

3. **实现技能加载器** `skill-loader.ts`
   - YAML frontmatter 解析 (使用 **gray-matter** 库)
   - 容错处理：支持非标准 YAML 格式（参考 OpenCode 的 `fallbackSanitization`）
   - Markdown 内容处理
   - 支持文件加载

**依赖**: `gray-matter` - 成熟的 YAML frontmatter 解析库，支持容错解析

#### Phase 2: 执行引擎

4. **实现变量解析器** `skill-resolver.ts`
   - `$ARGUMENTS` 替换
   - `$0`, `$1` 位置参数
   - `` !`command` `` 动态上下文
   - `${CLAUDE_SESSION_ID}` 环境变量

5. **实现技能注册表** `skill-registry.ts`
   - 渐进式披露
   - 技能缓存
   - 热重载

6. **实现执行器** `executor.ts`
   - 内联执行
   - `context: fork` 子代理执行
   - 工具权限控制

#### Phase 3: 集成与 UI

7. **集成命令系统** `commands.ts`
   - `/skills` 命令
   - `/skill-name` 调用
   - Tab 补全

8. **UI 反馈** `InkREPL.tsx`
   - 技能加载状态
   - 执行进度
   - 结果展示

#### Phase 4: 内置技能与测试

9. **创建内置技能** `builtin/`
   - `code-review/SKILL.md`
   - `git-workflow/SKILL.md`
   - `tdd/SKILL.md`

10. **兼容性测试**
    - 测试 Claude Code 官方 skills
    - 测试社区 skills
    - 边界情况处理

### 6. 兼容性保证

#### 6.1 Claude Code Skills 兼容

```typescript
// 完全兼容 Claude Code 的 skills 格式
// 支持 Claude Code 的所有扩展字段:
// - disable-model-invocation
// - user-invocable
// - allowed-tools
// - context: fork
// - agent
// - argument-hint
// - model
// - hooks

// 路径兼容:
// - ~/.claude/skills/
// - .claude/skills/
```

#### 6.2 Agent Skills 标准兼容

```typescript
// 遵循 agentskills.io 标准
// - SKILL.md 文件格式
// - YAML frontmatter 必需字段
// - 渐进式披露机制
// - 可移植性
```

### 7. 验收标准

- [ ] **标准兼容**
  - [ ] 完全解析 Agent Skills 标准 SKILL.md
  - [ ] 支持 YAML frontmatter 所有标准字段
  - [ ] 支持渐进式披露机制

- [ ] **Claude Code 兼容**
  - [ ] 加载 `~/.claude/skills/` 目录
  - [ ] 加载 `.claude/skills/` 目录
  - [ ] 支持 Claude Code 扩展字段
  - [ ] 测试通过 3 个以上 Claude Code 官方 skills

- [ ] **功能完整**
  - [ ] `/skills` 命令列出所有技能
  - [ ] `/skill-name [args]` 调用技能
  - [ ] `$ARGUMENTS` 参数替换
  - [ ] `$0`, `$1` 位置参数
  - [ ] `` !`command` `` 动态上下文
  - [ ] `scripts/`, `templates/`, `resources/` 支持

- [ ] **高级特性**
  - [ ] `context: fork` 子代理执行
  - [ ] `allowed-tools` 工具限制
  - [ ] 嵌套目录自动发现
  - [ ] 热重载

- [ ] **内置技能**
  - [ ] 至少 3 个内置技能
  - [ ] 每个技能包含完整文档

### 8. 示例：完整 Skill

```
code-review/
├── SKILL.md
├── scripts/
│   └── complexity.py
├── templates/
│   └── review-report.md
└── resources/
    └── coding-standards.md
```

**SKILL.md**:
```markdown
---
name: code-review
description: 代码审查技能。当用户要求审查代码、code review、检查代码质量、review code 时使用。
disable-model-invocation: false
user-invocable: true
allowed-tools: "Read, Grep, Glob, Bash(python:*)"
argument-hint: "[file-or-directory]"
---

# Code Review Skill

对 **$ARGUMENTS** 进行全面的代码审查。

## 审查流程

1. **读取目标文件**
   使用 Read 工具读取 $ARGUMENTS 指定的文件或目录。

2. **分析代码复杂度**
   运行复杂度分析脚本:
   ```bash
   python scripts/complexity.py $ARGUMENTS
   ```

3. **检查编码规范**
   参考 [resources/coding-standards.md](resources/coding-standards.md)

4. **生成审查报告**
   使用 [templates/review-report.md](templates/review-report.md) 格式

## 当前 Git 状态

!`git diff --stat HEAD~5`

## 审查重点

- 代码风格一致性
- 潜在安全漏洞
- 性能问题
- 可维护性
- 测试覆盖
```

---

## FEATURE_007: 主题系统完善

### 1. 概述

将所有硬编码的 chalk 颜色改为使用主题系统，实现全局主题切换。

### 2. 影响范围

**需要修改的文件**:
- `packages/repl/src/interactive/commands.ts` - 使用主题颜色
- `packages/repl/src/interactive/project-commands.ts` - 使用主题颜色
- `packages/repl/src/ui/themes/index.ts` - 添加主题切换
- `packages/repl/src/ui/contexts/` - 添加 ThemeContext

### 3. 技术方案

**ThemeContext**:
```typescript
interface ThemeContextValue {
  theme: Theme;
  setTheme: (name: string) => void;
  themeColors: ThemeColors;
}
```

**命令颜色迁移**:
```typescript
// 之前
console.log(chalk.cyan('消息'));

// 之后
console.log(chalk.hex(theme.colors.primary)('消息'));
```

### 4. 接口契约

**新增命令**:
- `/theme` - 显示当前主题
- `/theme <name>` - 切换主题
- `/theme list` - 列出所有可用主题

### 5. 实现步骤

1. **创建 ThemeContext**
2. **修改命令系统注入主题**
3. **迁移 commands.ts 的 chalk 调用**
4. **迁移 project-commands.ts 的 chalk 调用**
5. **添加 /theme 命令**
6. **主题配置持久化**

### 6. 验收标准

- [ ] `/theme` 命令可用
- [ ] 命令输出颜色随主题变化
- [ ] 主题选择持久化
- [ ] dark 和 minimal 主题都正常工作
